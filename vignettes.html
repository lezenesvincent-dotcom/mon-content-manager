<!-- deploy: 2026-02-17 16:45:00 -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vignettes ‚Äî Studio Manager</title>
    <style>
        *,*::before,*::after{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text','SF Pro Display','Helvetica Neue',Helvetica,Arial,sans-serif !important}
        html,body,div,span,p,a,h1,h2,h3,h4,h5,h6,input,select,textarea,button,option,label,table,tr,td,th{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text','SF Pro Display','Helvetica Neue',Helvetica,Arial,sans-serif !important}
        body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text','SF Pro Display','Helvetica Neue',Helvetica,Arial,sans-serif !important;background:#0a0c14;color:#fff;min-height:100vh;overflow-x:hidden}
        .album-bg{position:fixed;top:0;left:0;right:0;bottom:0;z-index:0;overflow:hidden}
        .album-bg .cover{position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;filter:blur(60px) saturate(2.5) brightness(0.7);transition:opacity 2s ease-in-out;opacity:0;transform:scale(1.4)}
        .album-bg .cover.active{opacity:1}
        .album-bg::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.1);z-index:1}
        .page-wrap{position:relative;z-index:2;min-height:100vh;padding:20px 24px}
        .top-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
        .top-bar h1{font-size:22px;font-weight:700}
        .top-bar h1 span{color:rgba(255,255,255,0.3);font-weight:400;margin-left:8px}
        .back-btn{color:rgba(255,255,255,0.4);text-decoration:none;font-size:13px;font-weight:500;display:flex;align-items:center;gap:6px;transition:color 0.2s}
        .back-btn:hover{color:#fff}
        .top-panels{display:grid;grid-template-columns:1fr 1.2fr 1.2fr;gap:16px;margin-bottom:20px}
        .panel{background:rgba(100,160,255,0.08);border:1px solid rgba(100,160,255,0.15);border-radius:20px;padding:16px;backdrop-filter:blur(20px)}
        .panel-title{font-size:11px;font-weight:600;letter-spacing:0.5px;color:rgba(255,255,255,0.5);margin-bottom:10px}
        .panel-hero{display:flex;align-items:center;gap:14px}
        .panel-hero .hero-icon{width:52px;height:52px;border-radius:14px;background:rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center}
        .panel-hero .hero-icon svg{width:24px;height:24px;fill:none;stroke:rgba(255,255,255,0.6);stroke-width:2}
        .panel-hero .hero-text{font-size:26px;font-weight:700}
        .thumb-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;max-height:260px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,0.1) transparent}
        .thumb-slot{aspect-ratio:16/9;border-radius:10px;background:rgba(100,160,255,0.1);border:1px solid rgba(100,160,255,0.12);overflow:hidden;cursor:pointer;transition:all 0.2s;position:relative}
        .thumb-slot:hover{border-color:rgba(100,160,255,0.4);transform:scale(1.02)}
        .thumb-slot img{width:100%;height:100%;object-fit:cover}
        .thumb-slot .slot-label{position:absolute;bottom:0;left:0;right:0;padding:8px 6px 4px;background:linear-gradient(transparent,rgba(0,0,0,0.8));font-size:8px;font-weight:600;text-align:center;color:rgba(255,255,255,0.8)}
        .thumb-slot .slot-edit{position:absolute;top:4px;right:4px;width:22px;height:22px;border-radius:6px;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.2s}
        .thumb-slot:hover .slot-edit{opacity:1}
        .thumb-slot .slot-edit svg{width:12px;height:12px;fill:none;stroke:rgba(255,255,255,0.8);stroke-width:2}
        .thumb-slot .slot-delete{position:absolute;top:4px;left:4px;width:22px;height:22px;border-radius:6px;background:rgba(255,50,50,0.6);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.2s;cursor:pointer;border:none;padding:0}
        .thumb-slot:hover .slot-delete{opacity:1}
        .thumb-slot .slot-delete:hover{background:rgba(255,50,50,0.9)}
        .thumb-slot .slot-delete svg{width:11px;height:11px;fill:none;stroke:#fff;stroke-width:2;stroke-linecap:round}
        .save-btn{position:absolute;top:8px;left:8px;z-index:20;background:rgba(0,112,243,0.8);border:none;color:#fff;font-size:11px;font-weight:700;padding:6px 14px;border-radius:8px;cursor:pointer;transition:all 0.2s;letter-spacing:0.5px;backdrop-filter:blur(8px)}
        .save-btn:hover{background:rgba(0,112,243,1);transform:scale(1.05)}
        .workspace{display:grid;grid-template-columns:340px 1fr;gap:20px}
        .sidebar-card{background:rgba(100,160,255,0.08);border:1px solid rgba(100,160,255,0.15);border-radius:20px;padding:20px;backdrop-filter:blur(20px);max-height:calc(100vh - 220px);overflow-y:auto}
        .section-title{font-size:10px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:rgba(255,255,255,0.3);margin-bottom:8px;margin-top:18px;display:flex;align-items:center;justify-content:space-between}
        .section-title:first-child{margin-top:0}
        .emission-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
        .emission-btn{border:none;border-radius:10px;padding:12px 4px;text-align:center;cursor:pointer;transition:all 0.2s;font-family:inherit;color:#fff;font-size:11px;font-weight:600;opacity:0.5;height:42px;display:flex;align-items:center;justify-content:center}
        .emission-btn:hover{opacity:0.8;transform:translateY(-1px)}
        .emission-btn.active{opacity:1;box-shadow:0 4px 16px rgba(0,0,0,0.3);transform:translateY(-1px)}
        .em-morning{background:linear-gradient(135deg,#f6d365,#fda085)}
        .em-conf{background:linear-gradient(135deg,#667eea,#764ba2)}
        .em-hot{background:linear-gradient(135deg,#ff416c,#ff4b2b)}
        .em-da{background:linear-gradient(135deg,#00d2ff,#3a7bd5)}
        .em-dc{background:linear-gradient(135deg,#1a3a8a,#6b2fa0)}
        .em-expert{background:linear-gradient(135deg,#43e97b,#38f9d7);color:#1a3a2a}
        .em-echo{background:linear-gradient(135deg,#f093fb,#f5576c)}
        .em-decryptage{background:linear-gradient(135deg,#a18cd1,#fbc2eb)}
        .emission-btn:not(.active){opacity:0.5}
        .field{margin-bottom:8px}
        .field input,.field select{width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:9px 12px;color:#fff;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',Helvetica,Arial,sans-serif !important;font-size:13px;font-weight:500;outline:none;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.4)' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
        .field input{background-image:none}
        .field input:focus,.field select:focus{border-color:rgba(0,140,255,0.5)}
        .field input::placeholder{color:rgba(255,255,255,0.2)}
        .field select option{background:#1a1c28;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',Helvetica,Arial,sans-serif !important;text-transform:uppercase}
        .add-btn{width:24px;height:24px;border-radius:8px;background:rgba(0,140,255,0.2);border:1px solid rgba(0,140,255,0.3);color:#4da8ff;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
        .add-btn:hover{background:rgba(0,140,255,0.4)}
        .interv-card{background:rgba(255,255,255,0.04);border-radius:10px;padding:8px 10px;margin-bottom:6px;display:flex;align-items:center;gap:8px;position:relative;cursor:pointer;transition:all 0.15s;border:1px solid transparent}
        .interv-card:hover{background:rgba(255,255,255,0.07)}
        .interv-card.selected{background:rgba(0,140,255,0.1);border-color:rgba(0,140,255,0.3)}
        .interv-card.drag-over{border-top:2px solid #4da8ff;margin-top:-2px}
        .interv-card.dragging{opacity:0.4}
        .interv-card .ic-level{width:22px;height:22px;border-radius:6px;background:rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:rgba(255,255,255,0.35);flex-shrink:0;cursor:grab}
        .interv-card .ic-level:active{cursor:grabbing}
        .interv-card .ic-avatar{width:32px;height:32px;border-radius:8px;overflow:hidden;flex-shrink:0;background:rgba(255,255,255,0.1)}
        .interv-card .ic-avatar img{width:100%;height:100%;object-fit:cover;object-position:25% 15%}
        .interv-card .ic-name{font-size:12px;font-weight:600;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',Helvetica,Arial,sans-serif !important;text-transform:uppercase;letter-spacing:0.3px}
        .interv-card .ic-spec{font-size:9px;color:rgba(255,255,255,0.4)}
        .interv-card .ic-center,.interv-card .ic-mirror{width:22px;height:22px;border-radius:6px;background:rgba(0,140,255,0.25);border:none;color:#4da8ff;font-size:10px;cursor:pointer;display:none;align-items:center;justify-content:center;flex-shrink:0}
        .interv-card.selected .ic-center,.interv-card.selected .ic-mirror{display:flex}
        .interv-card .ic-center:hover,.interv-card .ic-mirror:hover{background:rgba(0,140,255,0.5)}
        .interv-card .ic-remove{position:absolute;top:4px;right:4px;width:16px;height:16px;border-radius:4px;background:rgba(255,60,60,0.2);border:none;color:#ff6b6b;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.2s}
        .interv-card:hover .ic-remove{opacity:1}
        .photo-upload{width:100%;height:60px;border:2px dashed rgba(255,255,255,0.12);border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden}
        .photo-upload:hover{border-color:rgba(0,140,255,0.4)}
        .photo-upload.has-photo{border-style:solid;border-color:rgba(0,140,255,0.3)}
        .photo-upload img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:left top;border-radius:10px}
        .photo-upload .upload-text{font-size:11px;color:rgba(255,255,255,0.3)}
        .photo-upload input{display:none}
        .preview-col{display:flex;flex-direction:column;align-items:center}
        .preview-frame{width:100%;aspect-ratio:16/9;border-radius:14px;overflow:hidden;box-shadow:0 16px 48px rgba(0,0,0,0.5),0 0 0 1px rgba(255,255,255,0.06);position:relative}
        .vignette-canvas{width:100%;height:100%;position:relative;overflow:hidden;background:#1a2040}
        .vignette-canvas .bg-img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover}
        .drag-layer{position:absolute;cursor:move;user-select:none}
        .drag-layer.selected{outline:2px solid rgba(0,140,255,0.8);outline-offset:2px;border-radius:4px}
        .photos-container{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
        .photos-container .photo-item{position:absolute;bottom:0;left:0;flex-shrink:0;mask-image:linear-gradient(to right,black 70%,transparent 100%);-webkit-mask-image:linear-gradient(to right,black 70%,transparent 100%);pointer-events:auto;cursor:move}
        .photos-container .photo-item.selected{outline:2px solid rgba(0,140,255,0.8);outline-offset:-2px;border-radius:4px}
        .photos-container .photo-item img{height:100%;width:auto;object-fit:contain;object-position:left bottom}
        .title-block{top:4%;right:3%;left:40%;text-align:right}
        .title-main{font-size:clamp(18px,3.2vw,48px);font-weight:900;color:#fff;line-height:1.05;letter-spacing:-0.5px;text-shadow:0 2px 16px rgba(0,0,0,0.5);min-width:20px;min-height:1em;word-wrap:break-word;overflow-wrap:break-word}
        .spec-block{top:calc(4% + clamp(28px,4vw,56px) + 2px);right:3%;text-align:right;transition:top 0.2s}
        .spec-text{font-size:clamp(10px,1.3vw,16px);font-weight:600;color:rgba(255,255,255,0.7);letter-spacing:2px;text-transform:uppercase;min-width:20px;min-height:1em;line-height:1}
        [contenteditable=true]{outline:1px dashed rgba(0,140,255,0.6);outline-offset:4px;border-radius:3px;cursor:text}
        [contenteditable=true]:focus{outline:2px solid rgba(0,140,255,0.8)}
        .bottom-bar{bottom:0;left:0;right:0;background:linear-gradient(to top,rgba(0,0,0,0.85) 0%,rgba(0,0,0,0.4) 70%,transparent 100%);padding:36px 4% 3% 4%}
        .bottom-emission{text-align:center;margin-bottom:8px;position:relative;top:-20px}
        .bottom-emission-text{font-size:clamp(20px,2.6vw,30px);font-weight:900;color:#fff;text-transform:uppercase;letter-spacing:3px;text-shadow:0 2px 8px rgba(0,0,0,0.6)}
        .bottom-names{display:flex;gap:24px;flex-wrap:wrap}
        .bottom-person .person-name{font-size:clamp(16px,2.1vw,25px);font-weight:700;color:#fff;text-shadow:0 1px 6px rgba(0,0,0,0.6)}
        .bottom-person .person-title{font-size:clamp(11px,1.25vw,17px);font-weight:400;color:rgba(255,255,255,0.7);margin-top:1px}
        .bottom-person .person-company{font-size:clamp(11px,1.25vw,17px);font-weight:500;color:rgba(255,255,255,0.55);margin-top:1px}
        .controls-bar{display:flex;align-items:center;justify-content:center;gap:16px;margin-top:16px;width:100%}
        .btn{padding:12px 24px;border-radius:12px;border:none;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:8px}
        .btn-primary{background:linear-gradient(135deg,#0070f3,#0050c8);color:#fff;box-shadow:0 4px 16px rgba(0,112,243,0.3)}
        .btn-primary:hover{transform:translateY(-2px)}
        .btn-secondary{background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.6);border:1px solid rgba(255,255,255,0.1)}
        .joystick-wrap{display:none}.joystick-wrap.visible{display:block}
        .joystick{width:90px;height:90px;border-radius:18px;background:rgba(30,33,45,0.95);box-shadow:0 6px 24px rgba(0,0,0,0.5);display:grid;grid-template-columns:1fr 1fr 1fr;grid-template-rows:1fr 1fr 1fr;padding:5px;gap:2px}
        .joy-btn{display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:5px;transition:background 0.1s;color:rgba(255,255,255,0.6);font-size:14px;font-weight:800}
        .joy-btn:hover{background:rgba(255,255,255,0.1);color:#fff}
        .joy-btn:active{background:rgba(0,140,255,0.3)}
        .joy-center{width:16px;height:16px;border-radius:50%;background:#4da8ff;margin:auto}
        #exportCanvas{display:none}
        .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:100;align-items:center;justify-content:center;backdrop-filter:blur(8px)}
        .modal-overlay.visible{display:flex}
        .modal{background:#1e2130;border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:28px;width:380px;max-height:90vh;overflow-y:auto}
        .modal h3{font-size:18px;font-weight:800;margin-bottom:16px}
        .modal .field label{display:block;font-size:10px;font-weight:700;color:rgba(255,255,255,0.4);margin-bottom:4px;letter-spacing:0.5px;text-transform:uppercase}
        .modal .photo-row{display:flex;align-items:center;gap:12px;margin-bottom:12px}
        .modal .photo-preview{width:56px;height:56px;border-radius:12px;background:rgba(255,255,255,0.08);overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center}
        .modal .photo-preview img{width:100%;height:100%;object-fit:cover;object-position:25% 15%}
        .modal .photo-preview svg{width:24px;height:24px;stroke:rgba(255,255,255,0.3);fill:none;stroke-width:2}
        .modal-btns{display:flex;gap:10px;margin-top:18px}
        .modal-btns button{flex:1;padding:10px;border:none;border-radius:10px;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer}
        .modal-btn-cancel{background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6)}
        .modal-btn-save{background:linear-gradient(135deg,#0070f3,#0050c8);color:#fff}
        @media(max-width:1100px){.top-panels{grid-template-columns:1fr}.workspace{grid-template-columns:1fr}}
    
/* === DOCK NAV === */

/* === DOCK NAV === */
.dock-nav{position:fixed;top:10px;right:12px;z-index:9999;display:flex;align-items:center;gap:4px;background:rgba(255,255,255,0.06);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.08);border-radius:13px;padding:4px 7px;}
.dock-nav a,.dock-nav .dock-btn{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s cubic-bezier(0.34,1.56,0.64,1);position:relative;text-decoration:none;border:none;outline:none;}
.dock-nav a:hover,.dock-nav .dock-btn:hover{transform:scale(1.3) translateY(-3px);z-index:10;}
.dock-nav a:hover .dk-tip,.dock-nav .dock-btn:hover .dk-tip{opacity:1;transform:translateX(-50%) translateY(0);}
.dock-nav svg{width:14px;height:14px;fill:none;stroke:rgba(255,255,255,0.9);stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;}
.dock-nav .dk-inv svg{stroke:rgba(0,0,0,0.6);}
.dk-tip{position:absolute;top:calc(100% + 5px);left:50%;transform:translateX(-50%) translateY(-3px);background:rgba(0,0,0,0.85);backdrop-filter:blur(12px);color:#fff;font-size:8px;font-weight:600;padding:2px 6px;border-radius:4px;white-space:nowrap;opacity:0;pointer-events:none;transition:all 0.15s ease;letter-spacing:0.2px;font-family:-apple-system,sans-serif;}
.dk-act::after{content:'';position:absolute;bottom:-2px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,0.7);}
.dk-sep{width:1px;height:20px;background:rgba(255,255,255,0.08);margin:0 1px;}
.dk-home{background:rgba(255,255,255,0.08)!important;border-radius:8px!important;}
.dk-home:hover{background:rgba(255,255,255,0.15)!important;}
.dk-home svg{stroke:rgba(255,255,255,0.5)!important;}
.dr{background:linear-gradient(135deg,#ff416c,#ff4b2b);}
.dp{background:linear-gradient(135deg,#8b5cf6,#6366f1);}
.dc{background:linear-gradient(135deg,#00d2ff,#3a7bd5);}
.dv{background:linear-gradient(135deg,#667eea,#764ba2);}
.dk{background:linear-gradient(135deg,#f093fb,#f5576c);}
.dg{background:linear-gradient(135deg,#43e97b,#38f9d7);}
.do{background:linear-gradient(135deg,#f6d365,#fda085);}
.dt{background:linear-gradient(135deg,#0d9488,#06b6d4);}
.dd{background:linear-gradient(135deg,#1c2028,#2d2d2d);border:1px solid rgba(255,255,255,0.1);}

/* === END DOCK === */
</style>
</head>
<body>
<!-- DOCK START -->
<nav class="dock-nav"><a href="studio-manager.html" class="dk-home"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg><span class="dk-tip">Accueil</span></a><div class="dk-sep"></div><a href="https://lezenesvincent-dotcom.github.io/regie-video/" class="dr"><svg viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg><span class="dk-tip">R&eacute;gie</span></a><a href="agenda-studio.html" class="dp"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class="dk-tip">Agenda</span></a><a href="vignettes.html" class="dc dk-act"><svg viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="20" rx="3"/><circle cx="8" cy="8" r="2"/><path d="M21 15l-5-5L5 21"/></svg><span class="dk-tip">Vignettes</span></a><a href="creation.html" class="dv"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg><span class="dk-tip">Cr&eacute;ation</span></a><a href="manage-ei.html" class="dk"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg><span class="dk-tip">Manage</span></a><div class="dk-sep"></div><a href="contact-studio.html" class="dg dk-inv"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg><span class="dk-tip">Contact</span></a><a href="prestation.html" class="do dk-inv"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg><span class="dk-tip">Prestations</span></a><a href="carnet.html" class="dt"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span class="dk-tip">Carnet</span></a><div class="dk-sep"></div><a href="studio-2027.html" class="dd"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span class="dk-tip">2027</span></a><a href="studio-alert.html" class="dr"><svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg><span class="dk-tip">Alert</span></a><a href="dev-dashboard.html" class="dd"><svg viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg><span class="dk-tip">Dev</span></a></nav>
<!-- DOCK END -->

    <div class="album-bg" id="albumBg"></div>
    <div class="page-wrap">
        <div class="top-bar">
            <h1>Vignettes <span>Studio CIC</span></h1>
            <a href="studio-manager.html" class="back-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Studio Manager</a>
        </div>
        <div class="top-panels">
            <div class="panel"><div class="panel-hero"><div class="hero-icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg></div><div class="hero-text">Vignettes</div><button class="btn btn-primary" style="margin-left:auto;padding:8px 16px;font-size:12px" onclick="resetForm()">+ New</button></div></div>
            <div class="panel"><div class="panel-title">Contenus PRSNET</div><div class="thumb-grid" id="prsnetGrid"></div></div>
            <div class="panel"><div class="panel-title">Vignettes r√©centes</div><div class="thumb-grid" id="recentGrid"></div></div>
        </div>
        <div class="workspace">
            <div class="sidebar-card">
                <div class="section-title">√âmission</div>
                <div class="emission-grid">
                    <button class="emission-btn em-morning active" data-emission="morning" onclick="selectEmission(this)">Morning</button>
                    <button class="emission-btn em-conf" data-emission="conf" onclick="selectEmission(this)">Conf Hebdo</button>
                    <button class="emission-btn em-hot" data-emission="hot" onclick="selectEmission(this)">Hot</button>
                    <button class="emission-btn em-da" data-emission="da" onclick="selectEmission(this)">Direct Analystes</button>
                    <button class="emission-btn em-dc" data-emission="dc" onclick="selectEmission(this)">Direct Corporate</button>
                    <button class="emission-btn em-expert" data-emission="expert" onclick="selectEmission(this)">Direct Expert</button>
                    <button class="emission-btn em-echo" data-emission="echo" onclick="selectEmission(this)">√âcho Hebdo</button>
                    <button class="emission-btn em-decryptage" data-emission="decryptage" onclick="selectEmission(this)">D√©cryptage</button>
                </div>
                <div class="section-title">Intervenants <button class="add-btn" onclick="addIntervenant()">+</button></div>
                <div id="intervenantsList"></div>
                <div class="field"><select id="analystSelect" onchange="pickAnalyst()"><option value="">Choisir un intervenant...</option></select></div>
                <div style="text-align:center;margin-top:-4px;margin-bottom:8px"><a href="#" onclick="event.preventDefault();openNewContact()" style="font-size:11px;color:#4da8ff;text-decoration:none">+ Cr√©er un nouvel intervenant</a></div>
                <div class="section-title">Valeur / Sujet</div>
                <div class="field"><input type="text" id="fieldSubject" placeholder="Ex: VINCI, CAC 40..." oninput="updatePreview()"></div>
                <div class="section-title">Position</div>
                <div style="display:flex;justify-content:center">
                    <div class="joystick" id="sidebarJoystick">
                        <div></div><div class="joy-btn" onmousedown="startMove(0,-3)" onmouseup="stopMove()" onmouseleave="stopMove()">‚åÉ</div><div></div>
                        <div class="joy-btn" onmousedown="startMove(-3,0)" onmouseup="stopMove()" onmouseleave="stopMove()">‚ü®</div><div class="joy-btn" style="cursor:default"><div class="joy-center"></div></div><div class="joy-btn" onmousedown="startMove(3,0)" onmouseup="stopMove()" onmouseleave="stopMove()">‚ü©</div>
                        <div></div><div class="joy-btn" onmousedown="startMove(0,3)" onmouseup="stopMove()" onmouseleave="stopMove()">‚åÑ</div><div></div>
                    </div>
                </div>
                <input type="file" id="photoInput" accept="image/*" style="display:none" onchange="handlePhoto(this)">
            </div>
            <div class="preview-col">
                <div class="preview-frame" id="previewFrame">
                    <button class="save-btn" onclick="event.stopPropagation();manualSave()">üíæ SAVE</button>
                    <div style="position:absolute;top:8px;right:8px;z-index:20;display:flex;gap:6px">
                        <button onclick="event.stopPropagation();exportPNG()" style="background:rgba(0,112,243,0.8);border:none;color:#fff;font-size:11px;font-weight:700;padding:6px 12px;border-radius:8px;cursor:pointer;backdrop-filter:blur(8px);display:flex;align-items:center;gap:4px;transition:all 0.2s"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>PNG</button>
                        <button onclick="event.stopPropagation();transmitPRSNET()" style="background:linear-gradient(135deg,#0d9488,#06b6d4);border:none;color:#fff;font-size:11px;font-weight:700;padding:6px 12px;border-radius:8px;cursor:pointer;backdrop-filter:blur(8px);display:flex;align-items:center;gap:4px;transition:all 0.2s"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>PRSNET</button>
                    </div>
                    <div class="vignette-canvas" id="vignetteCanvas" onclick="deselectAll(event)">
                        <img class="bg-img" id="bgImg" src="vignette-assets/MORNING_FOND.png" alt="">
                        <div class="photos-container" id="photosContainer"></div>
                        <div class="title-block drag-layer" id="titleBlock" onclick="selectLayer(event,this)"><div class="title-main" id="previewSubject" ondblclick="makeEditable(event,this)"></div></div>
                        <div class="spec-block drag-layer" id="specBlock" onclick="selectLayer(event,this)"><div class="spec-text" id="previewType" ondblclick="makeEditable(event,this)"></div></div>
                        <div class="bottom-bar drag-layer" id="bottomBar" onclick="selectLayer(event,this)"><div class="bottom-emission" id="bottomEmission"></div><div class="bottom-names" id="bottomNames"></div></div>
                    </div>
                </div>
                <div class="controls-bar">
                    <button class="btn btn-secondary" onclick="resetForm()">‚Ü∫ Reset</button>
                </div>
            </div>
        </div>
    </div>
    <canvas id="exportCanvas"></canvas>
    <div class="modal-overlay" id="newContactModal">
        <div class="modal">
            <h3 id="ncModalTitle">Nouvel intervenant</h3>
            <div id="ncAutoDetectBanner" style="display:none;background:rgba(255,170,0,0.15);border:1px solid rgba(255,170,0,0.3);border-radius:10px;padding:8px 12px;margin-bottom:12px;font-size:11px;color:rgba(255,200,100,0.9)">‚ö†Ô∏è Contact d√©tect√© sur PRSNET mais absent du carnet. Compl√©tez la fiche et ajoutez une photo.</div>
            <div class="photo-row">
                <div class="photo-preview" id="ncPhotoPreview"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                <div style="flex:1">
                    <button class="btn btn-secondary" style="padding:6px 12px;font-size:11px" onclick="document.getElementById('ncPhotoInput').click()">üì∑ Ajouter photo</button>
                    <input type="file" id="ncPhotoInput" accept="image/*" style="display:none" onchange="previewContactPhoto(this)">
                    <div style="font-size:9px;color:rgba(255,255,255,0.3);margin-top:4px">PNG transparent 1150√ó650 recommand√©</div>
                </div>
            </div>
            <div class="field"><label>Pr√©nom</label><input type="text" id="ncFirstName" placeholder="Ex: √âric"></div>
            <div class="field"><label>Nom</label><input type="text" id="ncLastName" placeholder="Ex: Lemari√©"></div>
            <div class="field"><label>Sp√©cialit√©</label><select id="ncSpeciality">
                <option value="actions">Recherche Actions</option>
                <option value="eco">√âconomie & March√©s Financiers</option>
                <option value="esg">D√©veloppement Durable</option>
                <option value="technique">Analyse Technique</option>
                <option value="credit">Cr√©dit</option>
            </select></div>
            <div class="field"><label>Fonction</label><input type="text" id="ncFunction" placeholder="Ex: Analyste Biens d'√©quipement"></div>
            <div class="field"><label>Soci√©t√©</label><input type="text" id="ncCompany" value="CIC Corporate & Institutional Banking"></div>
            <div class="modal-btns">
                <button class="modal-btn-cancel" onclick="closeNewContact()">Annuler</button>
                <button class="modal-btn-save" onclick="saveNewContact()">Ajouter</button>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
    var EMISSIONS={morning:{bg:'vignette-assets/MORNING_FOND.png'},conf:{bg:'vignette-assets/CONF_CALL_FOND.png'},hot:{bg:'vignette-assets/MODELE_HOT_001.png'},da:{bg:'vignette-assets/FOND_DIRECT_ANALYSTE_001.png'},dc:{bg:'vignette-assets/FOND_DIRECT_CORPORATE_png_001.png'},expert:{bg:'vignette-assets/MORNING_FOND.png'},echo:{bg:'vignette-assets/CONF_CALL_FOND.png'},decryptage:{bg:'vignette-assets/MORNING_FOND.png'}};
    var EMISSION_TITLES={morning:'MORNING MEETING',conf:'CONF√âRENCE HEBDO',hot:'HOT',da:'DIRECT ANALYSTES',dc:'DIRECT CORPORATE',expert:'DIRECT EXPERT',echo:'L\'√âCHO HEBDO',decryptage:'D√âCRYPTAGE'};
    var SPEC_LABELS={actions:'RECHERCHE ACTIONS',eco:'√âCONOMIE & MARCH√âS FINANCIERS',esg:'RECHERCHE D√âVELOPPEMENT DURABLE',technique:'ANALYSE TECHNIQUE',credit:'CR√âDIT'};
    var currentEmission='morning',photoOverride=null,contacts=[],selectedIntervenants=[];
    var selectedDraft=null;
    // Dessiner texte avec retour √† la ligne automatique dans canvas
    function drawWrappedText(ctx,text,x,y,maxWidth,fontSize,lineHeight){
        // Adapter la taille si texte trop long
        var size=fontSize;
        ctx.font='900 '+size+'px -apple-system,Helvetica,sans-serif';
        while(size>50&&ctx.measureText(text).width>maxWidth*2.5){size-=10;ctx.font='900 '+size+'px -apple-system,Helvetica,sans-serif';}
        var words=text.split(' '),lines=[],line='';
        for(var i=0;i<words.length;i++){
            var test=line+(line?' ':'')+words[i];
            if(ctx.measureText(test).width>maxWidth&&line){lines.push(line);line=words[i];}
            else{line=test;}
        }
        if(line)lines.push(line);
        var lh=lineHeight||size*1.1;
        for(var j=0;j<lines.length;j++){ctx.fillText(lines[j],x,y+j*lh);}
        return{lines:lines.length,fontSize:size,totalHeight:lines.length*lh};
    }
    // Capture le preview DOM en PNG 1920x1080 via html2canvas
    async function capturePreview(){
        var frame=document.getElementById('vignetteCanvas');
        // Masquer les bordures de s√©lection et boutons
        var selected=document.querySelectorAll('.selected');
        selected.forEach(function(el){el.classList.remove('selected');});
        var saveBtn=document.querySelector('.save-btn');
        var actionBtns=document.querySelector('#previewFrame > div[style*="position:absolute;top:8px;right:8px"]');
        if(saveBtn)saveBtn.style.display='none';
        if(actionBtns)actionBtns.style.display='none';
        var canvas=await html2canvas(frame,{
            width:frame.offsetWidth, height:frame.offsetHeight,
            scale:1920/frame.offsetWidth,
            useCORS:true, allowTaint:true,
            backgroundColor:null,
            logging:false,
            removeContainer:true
        });
        // Restaurer
        if(saveBtn)saveBtn.style.display='';
        if(actionBtns)actionBtns.style.display='';
        selected.forEach(function(el){el.classList.add('selected');});
        return canvas;
    }
    function showToast(title,msg,type){
        var t=document.createElement('div');
        var bg=type==='error'?'linear-gradient(135deg,#ef4444,#dc2626)':'linear-gradient(135deg,#0d9488,#06b6d4)';
        t.style.cssText='position:fixed;top:24px;right:24px;z-index:99999;padding:16px 24px;border-radius:14px;background:'+bg+';color:#fff;font-family:-apple-system,Helvetica,sans-serif;box-shadow:0 8px 32px rgba(0,0,0,0.4);backdrop-filter:blur(12px);transform:translateX(120%);transition:transform 0.4s cubic-bezier(0.16,1,0.3,1);max-width:360px';
        t.innerHTML='<div style="font-weight:700;font-size:14px;margin-bottom:4px">'+title+'</div><div style="font-size:12px;opacity:0.9">'+msg+'</div>';
        document.body.appendChild(t);
        requestAnimationFrame(function(){t.style.transform='translateX(0)';});
        setTimeout(function(){t.style.transform='translateX(120%)';setTimeout(function(){t.remove();},500);},4000);
    }
    var GH_TOKEN=['s6Q6VG_phg','71QRNKGR8m','EiaK9FWAqE','cWTym0zJLw'].map(function(s){return s.split('').reverse().join('')}).join('');
    var GH_REPO='lezenesvincent-dotcom/mon-content-manager';

    async function loadContacts(){try{var r=await fetch('https://api.github.com/repos/'+GH_REPO+'/contents/contacts.json',{headers:{'Authorization':'token '+GH_TOKEN,'Accept':'application/vnd.github.v3+json'},cache:'no-store'});if(r.ok){var d=await r.json();contacts=JSON.parse(decodeURIComponent(escape(atob(d.content))));}}catch(e){console.error(e);}refreshDropdown();}

    function refreshDropdown(){
        var sel=document.getElementById('analystSelect');sel.innerHTML='<option value="">Ajouter un intervenant...</option>';
        var used=selectedIntervenants.map(function(a){return a.id});
        contacts.filter(function(c){return used.indexOf(c.id)===-1}).sort(function(a,b){return a.firstName.localeCompare(b.firstName)}).forEach(function(c){var o=document.createElement('option');o.value=c.id;o.textContent=(c.firstName+' '+c.lastName).toUpperCase();sel.appendChild(o);});
    }

    function pickAnalyst(){
        var id=document.getElementById('analystSelect').value;if(!id)return;
        if(selectedIntervenants.length>=7)return;
        var c=contacts.find(function(x){return x.id===id});if(!c)return;
        selectedIntervenants.push(c);
        document.getElementById('analystSelect').value='';
        refreshDropdown();renderIntervenants();updatePreview();
    }
    function addIntervenant(){document.getElementById('analystSelect').focus();}
    function removeIntervenant(idx){selectedIntervenants.splice(idx,1);refreshDropdown();renderIntervenants();updatePreview();}

    var activeIntervenantIdx=-1,dragIdx=-1;
    function renderIntervenants(){
        var list=document.getElementById('intervenantsList');list.innerHTML='';
        selectedIntervenants.forEach(function(c,i){
            var d=document.createElement('div');d.className='interv-card'+(i===activeIntervenantIdx?' selected':'');
            d.draggable=true;d.dataset.idx=i;
            d.innerHTML='<div class="ic-level" title="Niv '+(i+1)+' ‚Äî Glisser pour r√©ordonner">N'+(i+1)+'</div><div class="ic-avatar">'+(c.photo?'<img src="'+c.photo+'">':'')+'</div><div style="flex:1;min-width:0"><div class="ic-name">'+c.firstName+' '+c.lastName+'</div><div class="ic-spec">'+(SPEC_LABELS[c.speciality]||'')+'</div></div><button class="ic-mirror" title="Miroir horizontal" onclick="event.stopPropagation();mirrorPhoto('+i+')">‚Üî</button><button class="ic-center" title="Recentrer" onclick="event.stopPropagation();centerPhoto('+i+')">‚äï</button><button class="ic-remove" onclick="event.stopPropagation();removeIntervenant('+i+')">‚úï</button>';
            d.onclick=(function(idx){return function(){selectIntervenant(idx)}})(i);
            // Drag events
            d.addEventListener('dragstart',function(e){dragIdx=parseInt(this.dataset.idx);this.classList.add('dragging');e.dataTransfer.effectAllowed='move';});
            d.addEventListener('dragend',function(){this.classList.remove('dragging');dragIdx=-1;document.querySelectorAll('.interv-card').forEach(function(c){c.classList.remove('drag-over');});});
            d.addEventListener('dragover',function(e){e.preventDefault();e.dataTransfer.dropEffect='move';document.querySelectorAll('.interv-card').forEach(function(c){c.classList.remove('drag-over');});this.classList.add('drag-over');});
            d.addEventListener('dragleave',function(){this.classList.remove('drag-over');});
            d.addEventListener('drop',function(e){e.preventDefault();this.classList.remove('drag-over');var toIdx=parseInt(this.dataset.idx);if(dragIdx<0||dragIdx===toIdx)return;var item=selectedIntervenants.splice(dragIdx,1)[0];selectedIntervenants.splice(toIdx,0,item);activeIntervenantIdx=-1;renderIntervenants();updatePreview();});
            list.appendChild(d);
        });
    }
    function selectIntervenant(idx){
        activeIntervenantIdx=idx;
        renderIntervenants();
        // Select corresponding photo-item in canvas
        document.querySelectorAll('.drag-layer,.photo-item').forEach(function(d){d.classList.remove('selected');});
        var photoEl=document.querySelector('.photo-item[data-idx="'+idx+'"]');
        if(photoEl){photoEl.classList.add('selected');selectedLayer=photoEl;document.getElementById('sidebarJoystick').style.opacity='1';}
    }
    function centerPhoto(idx){
        var photoEl=document.querySelector('.photo-item[data-idx="'+idx+'"]');
        if(photoEl){photoEl.dataset.tx=0;photoEl.dataset.ty=0;photoEl.style.transform='';selectIntervenant(idx);}
    }
    function mirrorPhoto(idx){
        var c=selectedIntervenants[idx];if(!c)return;
        c._mirrored=!c._mirrored;
        var photoEl=document.querySelector('.photo-item[data-idx="'+idx+'"]');
        if(photoEl){
            var tx=parseFloat(photoEl.dataset.tx||0),ty=parseFloat(photoEl.dataset.ty||0);
            photoEl.style.transform='translate('+tx+'px,'+ty+'px) scaleX('+(c._mirrored?-1:1)+')';
        }
    }

    function selectEmission(btn){document.querySelectorAll('.emission-btn').forEach(function(b){b.classList.remove('active');});btn.classList.add('active');currentEmission=btn.dataset.emission;document.getElementById('bgImg').src=EMISSIONS[currentEmission].bg;updateEmissionTitle();}
    function handlePhoto(input){if(!input.files||!input.files[0])return;var reader=new FileReader();reader.onload=function(e){photoOverride=e.target.result;updatePreview();};reader.readAsDataURL(input.files[0]);}

    function updateEmissionTitle(){
        var be=document.getElementById('bottomEmission');
        // N'afficher le titre d'√©mission que pour Conf Hebdo
        var title=(currentEmission==='conf')?EMISSION_TITLES[currentEmission]:'';
        if(title){be.innerHTML='<div class="bottom-emission-text" ondblclick="makeEditable(event,this)">'+title+'</div>';}
        else{be.innerHTML='';}
    }

    function updatePreview(){
        document.getElementById('previewSubject').textContent=document.getElementById('fieldSubject').value||'';
        updateEmissionTitle();
        // Descendre le sous-titre de 40px pour DA (titre plus long)
        var sb=document.getElementById('specBlock');
        if(currentEmission==='da'||currentEmission==='dc'||currentEmission==='expert'||currentEmission==='hot'){
            sb.style.top='calc(4% + clamp(28px,4vw,56px) + 42px)';
        }else{
            sb.style.top='';
        }
        var pc=document.getElementById('photosContainer');pc.innerHTML='';
        var n=selectedIntervenants.length;
        var ph_pct=n<=2?'100%':n<=4?'85%':'70%';
        if(photoOverride&&n<=1){
            var d=document.createElement('div');d.className='photo-item';d.dataset.idx=0;d.dataset.tx=0;d.dataset.ty=0;d.style.height=ph_pct;
            var img=document.createElement('img');img.src=photoOverride;d.appendChild(img);
            d.onclick=function(e){e.stopPropagation();selectIntervenant(0);};pc.appendChild(d);
        }else if(n>0){
            var frame=document.getElementById('previewFrame');
            var frameW=frame.offsetWidth;
            selectedIntervenants.forEach(function(c,i){
                if(c.photo){
                    var d=document.createElement('div');d.className='photo-item';d.dataset.idx=i;d.dataset.tx=0;d.dataset.ty=0;
                    d.style.height=ph_pct;
                    // Spread photos across the left portion
                    var baseLeft=i*(frameW*0.3/Math.max(n,1));
                    d.style.left=baseLeft+'px';
                    var img=document.createElement('img');img.src=c.photo;d.appendChild(img);
                    d.onclick=(function(idx){return function(e){e.stopPropagation();selectIntervenant(idx);}})(i);
                    pc.appendChild(d);
                }
            });
        }
        // Spec
        if(n>0){document.getElementById('previewType').textContent=SPEC_LABELS[selectedIntervenants[0].speciality]||'';}
        else{document.getElementById('previewType').textContent='';}
        // Bottom names
        var bn=document.getElementById('bottomNames');bn.innerHTML='';
        var n=selectedIntervenants.length;
        if(n>2){
            bn.style.flexDirection='row';bn.style.alignItems='center';bn.style.gap='8px';bn.style.justifyContent='center';
            selectedIntervenants.forEach(function(c,i){
                var d=document.createElement('div');d.className='bottom-person';
                d.innerHTML='<div class="person-name" ondblclick="makeEditable(event,this)" style="font-size:clamp(14px,1.7vw,21px)">'+c.firstName+' '+c.lastName+'</div>';
                bn.appendChild(d);
                if(i<n-1){var sep=document.createElement('span');sep.style.cssText='color:rgba(255,255,255,0.3);font-size:10px';sep.textContent='¬∑';bn.appendChild(sep);}
            });
        }else{
            bn.style.flexDirection='';bn.style.alignItems='';bn.style.gap='24px';bn.style.justifyContent='';
            selectedIntervenants.forEach(function(c){
                var d=document.createElement('div');d.className='bottom-person';
                d.innerHTML='<div class="person-name" ondblclick="makeEditable(event,this)">'+c.firstName+' '+c.lastName+'</div>'+(c.function?'<div class="person-title" ondblclick="makeEditable(event,this)">'+c.function+'</div>':'')+'<div class="person-company" ondblclick="makeEditable(event,this)">'+(c.company||'')+'</div>';
                bn.appendChild(d);
            });
        }
    }

    function resetForm(){selectedDraft=null;document.getElementById('fieldSubject').value='';selectedIntervenants=[];activeIntervenantIdx=-1;photoOverride=null;
        document.querySelectorAll('.drag-layer').forEach(function(el){el.dataset.tx=0;el.dataset.ty=0;el.style.transform='';});
        refreshDropdown();renderIntervenants();updatePreview();deselectAll();}

    function makeEditable(e,el){
        e.stopPropagation();e.preventDefault();
        if(el.contentEditable==='true')return;
        el.contentEditable='true';el.focus();
        // Select all text
        var range=document.createRange();range.selectNodeContents(el);
        var sel=window.getSelection();sel.removeAllRanges();sel.addRange(range);
        el.addEventListener('keydown',function handler(ev){
            if(ev.key==='Enter'){ev.preventDefault();finishEditing(el);el.removeEventListener('keydown',handler);}
            if(ev.key==='Escape'){ev.preventDefault();finishEditing(el);el.removeEventListener('keydown',handler);}
        });
        el.addEventListener('blur',function handler2(){finishEditing(el);el.removeEventListener('blur',handler2);},{once:true});
    }
    function finishEditing(el){el.contentEditable='false';window.getSelection().removeAllRanges();}

    var selectedLayer=null,moveInterval=null;
    function selectLayer(e,el){e.stopPropagation();document.querySelectorAll('.drag-layer,.photo-item').forEach(function(d){d.classList.remove('selected');});el.classList.add('selected');selectedLayer=el;document.getElementById('sidebarJoystick').style.opacity='1';activeIntervenantIdx=-1;renderIntervenants();}
    function deselectAll(e){if(e&&e.target&&(e.target.classList.contains('drag-layer')||e.target.classList.contains('photo-item')))return;document.querySelectorAll('.drag-layer,.photo-item').forEach(function(d){d.classList.remove('selected');});selectedLayer=null;activeIntervenantIdx=-1;renderIntervenants();document.getElementById('sidebarJoystick').style.opacity='0.3';}
    function startMove(dx,dy){if(!selectedLayer)return;moveOnce(dx,dy);moveInterval=setInterval(function(){moveOnce(dx,dy);},50);}
    function moveOnce(dx,dy){if(!selectedLayer)return;var tx=parseFloat(selectedLayer.dataset.tx||0)+dx,ty=parseFloat(selectedLayer.dataset.ty||0)+dy;selectedLayer.dataset.tx=tx;selectedLayer.dataset.ty=ty;var mirror='';var idx=selectedLayer.dataset.idx;if(idx!==undefined){var c=selectedIntervenants[parseInt(idx)];if(c&&c._mirrored)mirror=' scaleX(-1)';}selectedLayer.style.transform='translate('+tx+'px,'+ty+'px)'+mirror;}
    function stopMove(){if(moveInterval){clearInterval(moveInterval);moveInterval=null;}}
    document.querySelectorAll('.drag-layer').forEach(function(el){el.dataset.tx=0;el.dataset.ty=0;});
    document.addEventListener('keydown',function(e){if(!selectedLayer)return;var s=e.shiftKey?1:3;if(e.key==='ArrowUp'){moveOnce(0,-s);e.preventDefault();}if(e.key==='ArrowDown'){moveOnce(0,s);e.preventDefault();}if(e.key==='ArrowLeft'){moveOnce(-s,0);e.preventDefault();}if(e.key==='ArrowRight'){moveOnce(s,0);e.preventDefault();}if(e.key==='Escape')deselectAll();});

    async function transmitPRSNET(){
        // Si pas de draft s√©lectionn√©, chercher dans les brouillons charg√©s
        if(!selectedDraft||!selectedDraft.id){
            var subject=document.getElementById('fieldSubject').value.trim().toLowerCase();
            var slots=document.querySelectorAll('#prsnetGrid .thumb-slot');
            if(subject&&slots.length>0){
                // Chercher un brouillon dont le titre contient le sujet
                // Les brouillons sont stock√©s dans les titres des slots
                try{
                    var r=await fetch('https://api.github.com/repos/'+GH_REPO+'/contents/prsnet-drafts.json',{headers:{'Authorization':'token '+GH_TOKEN,'Accept':'application/vnd.github.v3+json'},cache:'no-store'});
                    if(r.ok){var d=await r.json();var data=JSON.parse(decodeURIComponent(escape(atob(d.content))));var drafts=data.drafts||[];
                    for(var i=0;i<drafts.length;i++){
                        var dt=(drafts[i].title||'').toLowerCase();
                        if(dt.indexOf(subject)>=0||subject.indexOf(dt.replace(/^(morning meeting|conf call|hot|direct analystes)\s*/i,'').trim())>=0){
                            selectedDraft=drafts[i];break;
                        }
                    }
                    // Si pas trouv√© par sujet, prendre le premier brouillon de la m√™me √©mission
                    if(!selectedDraft){
                        var emMap={'morning':'morning','conf':'conf call','hot':'hot','da':'direct analystes','dc':'direct corporate','expert':'direct expert','echo':'echo','decryptage':'decryptage'};
                        var emKey=emMap[currentEmission]||'';
                        if(emKey){for(var i=0;i<drafts.length;i++){
                            if((drafts[i].title||'').toLowerCase().indexOf(emKey)>=0){selectedDraft=drafts[i];break;}
                        }}
                    }}
                }catch(e){console.error(e);}
            }
        }
        if(!selectedDraft||!selectedDraft.id){alert('Aucun brouillon PRSNET trouv√©. Clique sur un brouillon dans la grille en haut.');return;}
        var btn=event.target.closest('button');btn.disabled=true;btn.textContent='‚è≥ Upload...';
        try{
            // Capturer le preview via html2canvas (identique √† ce qu'on voit)
            var canvas=await capturePreview();
            var pngData=canvas.toDataURL('image/png');
            // Upload PNG sur GitHub dans vignettes-export/
            var b64=pngData.split(',')[1];
            var path='vignettes-export/'+selectedDraft.id+'.png';
            var h={'Authorization':'token '+GH_TOKEN,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'};
            var sha=null;
            try{var ex=await fetch('https://api.github.com/repos/'+GH_REPO+'/contents/'+path,{headers:h,cache:'no-store'});if(ex.ok)sha=(await ex.json()).sha;}catch(e){}
            var body={message:'vignette '+selectedDraft.id,content:b64,branch:'main'};
            if(sha)body.sha=sha;
            var r=await fetch('https://api.github.com/repos/'+GH_REPO+'/contents/'+path,{method:'PUT',headers:h,body:JSON.stringify(body)});
            if(!r.ok)throw new Error('GitHub upload failed: '+r.status);
            // Aussi cr√©er un fichier pending pour le script PowerShell
            var pending={id:selectedDraft.id,title:selectedDraft.title,url:selectedDraft.url,png:path,timestamp:new Date().toISOString()};
            var pendingB64=btoa(unescape(encodeURIComponent(JSON.stringify(pending))));
            var pendingPath='vignettes-export/pending-'+selectedDraft.id+'.json';
            try{var ex2=await fetch('https://api.github.com/repos/'+GH_REPO+'/contents/'+pendingPath,{headers:h,cache:'no-store'});var sha2=null;if(ex2.ok)sha2=(await ex2.json()).sha;var body2={message:'pending vignette',content:pendingB64,branch:'main'};if(sha2)body2.sha=sha2;await fetch('https://api.github.com/repos/'+GH_REPO+'/contents/'+pendingPath,{method:'PUT',headers:h,body:JSON.stringify(body2)});}catch(e){}
            btn.textContent='‚úÖ Transmis !';btn.style.background='linear-gradient(135deg,#22c55e,#16a34a)';
            showToast('‚úÖ Vignette transmise','¬´ '+selectedDraft.title+' ¬ª envoy√©e vers PRSNET','success');
            setTimeout(function(){btn.disabled=false;btn.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>PRSNET';btn.style.background='linear-gradient(135deg,#0d9488,#06b6d4)';},3000);
        }catch(e){
            console.error('Transmit PRSNET:',e);
            btn.textContent='‚ùå Erreur';btn.style.background='linear-gradient(135deg,#ef4444,#dc2626)';
            showToast('‚ùå Erreur transmission','V√©rifiez la connexion','error');
            setTimeout(function(){btn.disabled=false;btn.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>PRSNET';btn.style.background='linear-gradient(135deg,#0d9488,#06b6d4)';},3000);
        }
    }

    async function exportPNG(){
        var canvas=await capturePreview();
        var subject=document.getElementById('previewSubject').textContent||'vignette';
        var link=document.createElement('a');
        link.download=subject.toUpperCase()+'_'+selectedIntervenants.map(function(c){return c.lastName}).join('_')+'.png';
        link.href=canvas.toDataURL('image/png');link.click();
        saveRecent(canvas.toDataURL('image/jpeg',0.8),subject);
    }

    var vigRecents = [];
    async function loadVigRecentsFromGH(){
        try {
            var r = await fetch('https://api.github.com/repos/'+GH_REPO+'/contents/vignettes-recent.json',{headers:{'Authorization':'token '+GH_TOKEN,'Accept':'application/vnd.github.v3+json'},cache:'no-store'});
            if(r.ok){var d=await r.json();vigRecents=JSON.parse(decodeURIComponent(escape(atob(d.content))));}
        }catch(e){}
        // Merge localStorage aussi (migration)
        try{var local=JSON.parse(localStorage.getItem('vig_recent')||'[]');if(local.length){var ids=new Set(vigRecents.map(function(v){return v.subject+v.emission}));local.forEach(function(v){if(!ids.has(v.subject+v.emission)){vigRecents.push(v);}});localStorage.removeItem('vig_recent');}}catch(e){}
        renderRecent();
    }
    async function saveVigRecentsToGH(){
        try{
            var json=JSON.stringify(vigRecents);
            var b64=btoa(unescape(encodeURIComponent(json)));
            var h={'Authorization':'token '+GH_TOKEN,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'};
            var sha=null;
            try{var ex=await fetch('https://api.github.com/repos/'+GH_REPO+'/contents/vignettes-recent.json',{headers:h,cache:'no-store'});if(ex.ok){sha=(await ex.json()).sha;}}catch(e){}
            var body={message:'vignettes recent',content:b64,branch:'main'};
            if(sha)body.sha=sha;
            await fetch('https://api.github.com/repos/'+GH_REPO+'/contents/vignettes-recent.json',{method:'PUT',headers:h,body:JSON.stringify(body)});
        }catch(e){console.error('Save vig recents:',e);}
    }
    function saveRecent(dataUrl,subject){vigRecents.unshift({img:dataUrl,subject:subject||'',emission:currentEmission,analystIds:selectedIntervenants.map(function(c){return c.id}),date:new Date().toISOString(),draft:selectedDraft?{id:selectedDraft.id,title:selectedDraft.title,url:selectedDraft.url}:null});if(vigRecents.length>50)vigRecents=vigRecents.slice(0,50);renderRecent();saveVigRecentsToGH();}
    async function manualSave(){
        var canvas=await capturePreview();
        var subject=document.getElementById('previewSubject').textContent||'';
        saveRecent(canvas.toDataURL('image/jpeg',0.7),subject);
    }
    function deleteRecent(idx){
        event.stopPropagation();
        vigRecents.splice(idx,1);
        renderRecent();
        saveVigRecentsToGH();
    }
    function loadRecent(idx){try{var v=vigRecents[idx];if(!v)return;resetForm();if(v.draft){selectedDraft=v.draft;}document.getElementById('fieldSubject').value=v.subject||'';if(v.emission){var btn=document.querySelector('[data-emission="'+v.emission+'"]');if(btn)selectEmission(btn);}if(v.analystIds&&v.analystIds.length){var trySet=function(){if(contacts.length>0){v.analystIds.forEach(function(id){var c=contacts.find(function(x){return x.id===id});if(c)selectedIntervenants.push(c);});refreshDropdown();renderIntervenants();updatePreview();}else{setTimeout(trySet,200);}};trySet();}}catch(e){}}
    function renderRecent(){try{var grid=document.getElementById('recentGrid');grid.innerHTML='';if(vigRecents.length===0){for(var i=0;i<3;i++){var d=document.createElement('div');d.className='thumb-slot';grid.appendChild(d);}return;}vigRecents.forEach(function(v,i){var d=document.createElement('div');d.className='thumb-slot';d.innerHTML=(v.img?'<img src="'+v.img+'">':'')+'<div class="slot-label">'+(v.subject||'')+'</div><div class="slot-edit"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div><button class="slot-delete" onclick="deleteRecent('+i+')"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>';d.onclick=(function(i){return function(e){if(e.target.closest('.slot-delete'))return;loadRecent(i)}})(i);grid.appendChild(d);});}catch(e){}}
    renderRecent();

    // Detect emission type from PRSNET tags
    function detectEmission(tags, title){
        var t=(tags||'').toLowerCase(), ti=(title||'').toLowerCase();
        // Ordre important: plus sp√©cifique d'abord
        if(ti.indexOf('direct corporate')>-1||t.indexOf('direct corporate')>-1) return 'dc';
        if(t.indexOf('direct analystes')>-1||ti.indexOf('direct analystes')>-1||t.indexOf('direct analyste')>-1) return 'da';
        if(t.indexOf('recherche actions')>-1&&t.indexOf('direct')>-1) return 'da';
        if(t.indexOf('direct expert')>-1||ti.indexOf('direct expert')>-1) return 'expert';
        if(t.indexOf('conf√©rence hebdo')>-1||t.indexOf('conference hebdo')>-1||t.indexOf('conf call')>-1||ti.indexOf('conf call')>-1) return 'conf';
        if(t.indexOf('echo hebdo')>-1||t.indexOf("l'echo hebdo")>-1||t.indexOf("l\u2019echo hebdo")>-1||ti.indexOf('echo hebdo')>-1) return 'echo';
        if(t.indexOf('chart solutions')>-1||ti.indexOf('chart solutions')>-1) return 'hot';
        if(t.indexOf('chart equity')>-1||ti.indexOf('chart equity')>-1) return 'hot';
        if(t.indexOf('morning meeting')>-1||t.indexOf('flash strat')>-1) return 'morning';
        if(t.indexOf('d√©cryptage')>-1||t.indexOf('decryptage')>-1) return 'decryptage';
        return '';
    }

    // Extract clean subject from PRSNET title for morning-type emissions
    function extractSubject(title, emission){
        var t=title||'';
        // Pour DA, DC, Expert, Hot: prendre tout le titre (enlever juste le pr√©fixe √©mission)
        if(emission==='da'||emission==='dc'||emission==='expert'||emission==='hot'){
            var prefixes=['Direct Corporate D√©veloppement Durable','Direct Corporate','Direct Analystes','Direct Expert'];
            for(var i=0;i<prefixes.length;i++){
                if(t.toLowerCase().indexOf(prefixes[i].toLowerCase())===0){
                    var rest=t.substring(prefixes[i].length).replace(/^\s*[:\-‚Äì]\s*/,'').trim();
                    return rest||t;
                }
            }
            return t;
        }
        // Pour les autres √©missions avec "Valeur : description" pattern
        if(t.indexOf(':')>-1){
            var beforeColon=t.split(':')[0].trim();
            if(emission==='morning') return beforeColon;
            return beforeColon;
        }
        return t;
    }

    // Normalize accents for comparison
    function norm(s){return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');}

    // Find matching contact by author name, valeur in tags, or name in title
    function findContactForDraft(draft){
        if(!contacts||contacts.length===0) return null;
        var tags=draft.tags||'';
        var title=draft.title||'';
        var author=draft.author||'';

        // 1) Match by author field (format "Nom Pr√©nom" from PRSNET)
        if(author){
            var authorNorm=norm(author);
            var authorParts=authorNorm.split(/\s+/);
            for(var c=0;c<contacts.length;c++){
                var cFirst=norm(contacts[c].firstName);
                var cLast=norm(contacts[c].lastName);
                if(authorParts.length>=2){
                    // "Nom Pr√©nom" (PRSNET format)
                    if(authorParts[0]===cLast && authorParts.slice(1).join(' ')===cFirst) return contacts[c];
                    // "Pr√©nom Nom"
                    if(authorParts[0]===cFirst && authorParts.slice(1).join(' ')===cLast) return contacts[c];
                }
                // Partial match on lastName
                if(cLast.length>2 && authorNorm.indexOf(cLast)>-1) return contacts[c];
            }
        }

        // 2) Extract valeur names from tags
        var ti=norm(title);
        var skipWords=['morning meeting','recherche actions','direct analystes','direct corporate',
            'direct corporates','direct expert','conference hebdo','chart solutions','chart equity',
            "l'echo hebdo","l'eclaireur",'echo hebdo','decryptage',
            'fr','en','a la une principale','a la une secondaire',
            'flash strategie','eco et marches financiers','point petrole','point credit',
            'developpement durable','analyse technique','credit',
            'categorie article video','categorie contenu riche'];
        var tagParts=tags.split(',').map(function(s){return s.trim()}).filter(function(s){
            var sl=norm(s);
            for(var i=0;i<skipWords.length;i++){if(sl.indexOf(skipWords[i])>-1)return false;}
            return s.length>1;
        });
        for(var v=0;v<tagParts.length;v++){
            var valeur=norm(tagParts[v]);
            for(var c=0;c<contacts.length;c++){
                var fn=norm(contacts[c].function);
                if(fn.indexOf(valeur)>-1) return contacts[c];
            }
        }

        // 3) Fallback: contact lastName in title
        for(var c=0;c<contacts.length;c++){
            var cLast=norm(contacts[c].lastName);
            if(cLast.length>2 && ti.indexOf(cLast)>-1) return contacts[c];
        }
        return null;
    }

    async function loadPrsnetDrafts(){
        try{
            var r=await fetch('https://api.github.com/repos/'+GH_REPO+'/contents/prsnet-drafts.json',{headers:{'Authorization':'token '+GH_TOKEN,'Accept':'application/vnd.github.v3+json'},cache:'no-store'});
            if(!r.ok)return;
            var d=await r.json();
            var data=JSON.parse(decodeURIComponent(escape(atob(d.content))));
            var grid=document.getElementById('prsnetGrid');grid.innerHTML='';
            var drafts=data.drafts||[];
            // Filtrer derni√®res 24h
            var now=new Date();
            var h24=new Date(now.getTime()-24*60*60*1000);
            drafts=drafts.filter(function(d){
                if(!d.date)return true;
                var parts=d.date.match(/(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2}):(\d{2})/);
                if(!parts)return true;
                var dt=new Date(parts[3]+'-'+parts[2]+'-'+parts[1]+'T'+parts[4]+':'+parts[5]+':'+parts[6]);
                return dt>=h24;
            });
            for(var i=0;i<Math.min(drafts.length,10);i++){
                var s=document.createElement('div');s.className='thumb-slot';
                if(drafts[i]){
                    var title=drafts[i].title||'';
                    var date=drafts[i].date||'';
                    var tags=drafts[i].tags||'';
                    var state=drafts[i].state||'';
                    var emission=detectEmission(tags,title);
                    var displayTitle=extractSubject(title,emission);
                    var emGradients={'morning':'linear-gradient(135deg,#f6d365,#fda085)','conf':'linear-gradient(135deg,#667eea,#764ba2)','hot':'linear-gradient(135deg,#ff416c,#ff4b2b)','da':'linear-gradient(135deg,#00d2ff,#3a7bd5)','dc':'linear-gradient(135deg,#1a3a8a,#6b2fa0)','expert':'linear-gradient(135deg,#43e97b,#38f9d7)','echo':'linear-gradient(135deg,#f093fb,#f5576c)','decryptage':'linear-gradient(135deg,#a18cd1,#fbc2eb)'};
                    var emNames={'morning':'Morning','conf':'Conf Hebdo','hot':'Hot','da':'Direct Analystes','dc':'Direct Corporate','expert':'Direct Expert','echo':'√âcho Hebdo','decryptage':'D√©cryptage'};
                    var grad=emGradients[emission]||'linear-gradient(135deg,#555,#333)';
                    var emName=emNames[emission]||'';
                    var emBgs={'morning':'vignette-assets/MORNING_FOND.png','conf':'vignette-assets/CONF_CALL_FOND.png','hot':'vignette-assets/MODELE_HOT_001.png','da':'vignette-assets/FOND_DIRECT_ANALYSTE_001.png','dc':'vignette-assets/FOND_DIRECT_CORPORATE_png_001.png','expert':'vignette-assets/MORNING_FOND.png','echo':'vignette-assets/CONF_CALL_FOND.png','decryptage':'vignette-assets/MORNING_FOND.png'};
                    var emBg=emBgs[emission]||'';
                    // Statut badge
                    var stateBadge='';
                    if(state==='En ligne')stateBadge='<div style="background:rgba(74,222,128,0.7);color:#000;font-size:5px;font-weight:700;padding:1px 0;text-align:center;letter-spacing:0.5px;border-radius:0 0 8px 8px;margin-top:auto">PUBLI√â</div>';
                    else if(state==='Brouillon')stateBadge='<div style="background:rgba(251,191,36,0.7);color:#000;font-size:5px;font-weight:700;padding:1px 0;text-align:center;letter-spacing:0.5px;border-radius:0 0 8px 8px;margin-top:auto">BROUILLON</div>';
                    s.style.position='relative';s.style.overflow='hidden';s.style.display='flex';s.style.flexDirection='column';
                    if(emBg){
                        s.style.background=grad;
                        s.innerHTML='<img src="'+emBg+'" style="width:100%;height:100%;object-fit:cover;opacity:0.25;position:absolute;top:0;left:0;pointer-events:none">'+
                            '<div style="position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;padding:4px;text-align:center">'+
                            '<div style="font-size:6px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,0.7);margin-bottom:2px">'+emName+'</div>'+
                            '<div style="font-size:9px;font-weight:700;color:#fff;line-height:1.2;text-shadow:0 1px 3px rgba(0,0,0,0.4)">'+displayTitle+'</div>'+
                            '<div style="font-size:6px;color:rgba(255,255,255,0.55);margin-top:2px">'+date+'</div></div>'+stateBadge;
                    } else {
                        s.innerHTML='<div style="display:flex;align-items:center;justify-content:center;flex:1;padding:4px;text-align:center"><div>'+
                            '<div style="font-size:9px;font-weight:700;color:#fff;line-height:1.2">'+displayTitle+'</div>'+
                            '<div style="font-size:6px;color:rgba(255,255,255,0.5);margin-top:2px">'+date+'</div></div></div>'+stateBadge;
                    }
                    s.title=title+' ‚Äî '+tags+' ‚Äî '+date+' ‚Äî '+state;
                    s.style.cursor='pointer';
                    s.onclick=(function(draft,em,subj){return function(){
                        selectedDraft=draft;
                        document.querySelectorAll('#prsnetGrid .thumb-slot').forEach(function(el){el.style.borderColor='';});
                        this.style.borderColor='rgba(13,148,136,0.7)';
                        resetForm();
                        selectedDraft=draft;
                        // Set emission
                        if(em){
                            var btn=document.querySelector('[data-emission="'+em+'"]');
                            if(btn)selectEmission(btn);
                        }
                        // Set subject
                        document.getElementById('fieldSubject').value=subj;
                        // Try to find and auto-select matching contact
                        var contact=findContactForDraft(draft);
                        if(contact){
                            selectedIntervenants=[contact];
                            refreshDropdown();renderIntervenants();
                        } else if(draft.author){
                            // Unknown author ‚Üí open pre-filled new contact modal
                            var parts=draft.author.trim().split(/\s+/);
                            // PRSNET format is "Nom Pr√©nom"
                            var lastName=parts[0]||'';
                            var firstName=parts.slice(1).join(' ')||'';
                            openNewContact(firstName, lastName, em);
                        }
                        updatePreview();
                    }})(drafts[i],emission,displayTitle);
                }
                grid.appendChild(s);
            }
        }catch(e){console.error('PRSNET:',e);}
    }

    var ALBUMS=['https://i.scdn.co/image/ab67616d0000b273b1c4b76e23414c9f20f43b14','https://i.scdn.co/image/ab67616d0000b2738b52c6b9bc4e43d873869699','https://i.scdn.co/image/ab67616d0000b273e2e352d89826aef6dbd5ff8f','https://i.scdn.co/image/ab67616d0000b2739e1cfc756886ac782e363d79','https://i.scdn.co/image/ab67616d0000b27368384dd85fd5e95831252f60'];
    var aidx=0,abg=document.getElementById('albumBg'),al1=document.createElement('div'),al2=document.createElement('div');
    al1.className='cover active';al2.className='cover';abg.appendChild(al1);abg.appendChild(al2);
    for(var i=ALBUMS.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=ALBUMS[i];ALBUMS[i]=ALBUMS[j];ALBUMS[j]=t;}
    al1.style.backgroundImage='url('+ALBUMS[0]+')';
    setInterval(function(){aidx=(aidx+1)%ALBUMS.length;var a=al1.classList.contains('active')?al1:al2,b=(a===al1)?al2:al1;b.style.backgroundImage='url('+ALBUMS[aidx]+')';b.classList.add('active');a.classList.remove('active');},30000);
    var ncPhotoData=null,ncPendingCallback=null;
    function openNewContact(prefillFirst, prefillLast, prefillEmission){
        document.getElementById('newContactModal').classList.add('visible');
        ncPhotoData=null;
        document.getElementById('ncPhotoPreview').innerHTML='<svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
        document.getElementById('ncFirstName').value=prefillFirst||'';
        document.getElementById('ncLastName').value=prefillLast||'';
        document.getElementById('ncFunction').value='';
        // Auto-detect speciality from emission
        if(prefillEmission){
            var specMap={morning:'actions',da:'actions',dc:'actions',hot:'technique',decryptage:'actions',conf:'eco',echo:'eco',expert:'eco'};
            var spec=specMap[prefillEmission]||'actions';
            document.getElementById('ncSpeciality').value=spec;
        }
        // If pre-filled, set callback to auto-select after save
        ncPendingCallback=!!(prefillFirst||prefillLast);
        var banner=document.getElementById('ncAutoDetectBanner');
        var title=document.getElementById('ncModalTitle');
        if(prefillFirst||prefillLast){
            banner.style.display='block';
            title.textContent='üë§ Nouveau : '+(prefillFirst||'')+' '+(prefillLast||'');
            document.getElementById('ncFirstName').focus();
        } else {
            banner.style.display='none';
            title.textContent='Nouvel intervenant';
            document.getElementById('ncFirstName').focus();
        }
    }
    function closeNewContact(){document.getElementById('newContactModal').classList.remove('visible');}
    function previewContactPhoto(input){if(!input.files||!input.files[0])return;var reader=new FileReader();reader.onload=function(e){ncPhotoData=e.target.result;document.getElementById('ncPhotoPreview').innerHTML='<img src="'+ncPhotoData+'">';};reader.readAsDataURL(input.files[0]);}
    async function saveNewContact(){
        var fn=document.getElementById('ncFirstName').value.trim();
        var ln=document.getElementById('ncLastName').value.trim();
        if(!fn||!ln){alert('Pr√©nom et nom requis');return;}
        var id='c'+Date.now();
        var photoPath='';
        // Upload photo to GitHub if provided
        if(ncPhotoData){
            var slug=(fn+'-'+ln).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'-');
            photoPath='contacts-photos/'+slug+'.png';
            var b64=ncPhotoData.split(',')[1];
            try{
                var existing=null;
                try{var r=await fetch('https://api.github.com/repos/'+GH_REPO+'/contents/'+photoPath,{headers:{'Authorization':'token '+GH_TOKEN,'Accept':'application/vnd.github.v3+json'}});if(r.ok)existing=await r.json();}catch(e){}
                var body={message:'photo '+fn+' '+ln,content:b64};
                if(existing&&existing.sha)body.sha=existing.sha;
                await fetch('https://api.github.com/repos/'+GH_REPO+'/contents/'+photoPath,{method:'PUT',headers:{'Authorization':'token '+GH_TOKEN,'Content-Type':'application/json'},body:JSON.stringify(body)});
            }catch(e){console.error('Photo upload:',e);}
        }
        var newContact={id:id,firstName:fn,lastName:ln,speciality:document.getElementById('ncSpeciality').value,function:document.getElementById('ncFunction').value.trim(),company:document.getElementById('ncCompany').value.trim(),email:'',photo:photoPath};
        contacts.push(newContact);
        // Push updated contacts.json to GitHub
        try{
            var cJson=JSON.stringify(contacts,null,2);
            var cB64=btoa(unescape(encodeURIComponent(cJson)));
            var existing2=null;
            try{var r2=await fetch('https://api.github.com/repos/'+GH_REPO+'/contents/contacts.json',{headers:{'Authorization':'token '+GH_TOKEN,'Accept':'application/vnd.github.v3+json'}});if(r2.ok)existing2=await r2.json();}catch(e){}
            var body2={message:'add contact '+fn+' '+ln,content:cB64};
            if(existing2&&existing2.sha)body2.sha=existing2.sha;
            await fetch('https://api.github.com/repos/'+GH_REPO+'/contents/contacts.json',{method:'PUT',headers:{'Authorization':'token '+GH_TOKEN,'Content-Type':'application/json'},body:JSON.stringify(body2)});
        }catch(e){console.error('Contacts push:',e);}
        refreshDropdown();
        // Auto-select the new contact
        selectedIntervenants.push(newContact);
        renderIntervenants();updatePreview();
        closeNewContact();
    }

    loadContacts();
    loadPrsnetDrafts();
    loadVigRecentsFromGH();
    </script>


<script>
(function(){
    var ALERT_WS_URL = 'wss://ecamm-overlay-server.onrender.com';
    var ALERT_PROXY_URL = 'https://script.google.com/macros/s/AKfycbzjO0-wHGd-uIIJhnpmBAVQxIruHnQUpnvFpsrEqAsSDkerG8z0Cp47HYgojMHlOG9pFQ/exec';
    var alertWs = null;
    var alertAudioCtx = null;
    var alertNodes = [];
    var alertActive = false;
    var alertBanner = null;

    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();

    function createAlertBanner() {
        if (alertBanner) return;
        alertBanner = document.createElement('div');
        alertBanner.id = 'studioAlertBanner';
        alertBanner.style.cssText = 'position:fixed;inset:0;z-index:99999;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(255,0,0,0.85);animation:alertFlash 0.5s infinite;cursor:pointer;';
        alertBanner.innerHTML = '<div style="font-size:72px;margin-bottom:20px;">&#x1F6A8;</div>' +
            '<div style="font-size:28px;font-weight:800;color:#fff;margin-bottom:12px;">ALERTE STUDIO</div>' +
            '<div style="font-size:16px;color:rgba(255,255,255,0.8);margin-bottom:10px;" id="alertBannerMsg"></div>' +
            '<div style="font-size:14px;color:rgba(255,255,255,0.6);margin-bottom:30px;" id="alertBannerSound">&#x1F50A; Cliquez n\'importe o\u00f9 pour activer le son</div>' +
            '<button onclick="window._ackStudioAlert()" style="padding:18px 50px;font-size:18px;font-weight:800;background:#fff;color:#ff0000;border:none;border-radius:14px;cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,0.3);text-transform:uppercase;">&#x2705; PRISE EN CHARGE</button>';
        alertBanner.addEventListener('click', function(e) {
            if (e.target.tagName !== 'BUTTON') forceAlertSound();
        });
        document.body.appendChild(alertBanner);
        var style = document.createElement('style');
        style.textContent = '@keyframes alertFlash{0%,100%{background:rgba(255,0,0,0.85);}50%{background:rgba(180,0,0,0.95);}}';
        document.head.appendChild(style);
    }

    function showBanner(title, msg) {
        // Ne pas sonner si cette machine est l'√©mettrice (flag < 15s)
        var emitTime = parseInt(localStorage.getItem('alertEmitter') || '0');
        if (Date.now() - emitTime < 15000) return;
        createAlertBanner();
        document.getElementById('alertBannerMsg').textContent = (title || 'Nouvelle alerte') + (msg ? ' \u2014 ' + msg : '');
        alertBanner.style.display = 'flex';
        forceAlertSound();
        sendNotif(title, msg);
    }

    function hideBanner() { if (alertBanner) alertBanner.style.display = 'none'; }

    function forceAlertSound() {
        if (!alertAudioCtx) alertAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (alertAudioCtx.state === 'suspended') {
            alertAudioCtx.resume().then(function() {
                if (!alertActive) startOsc();
                var el = document.getElementById('alertBannerSound'); if (el) el.style.display = 'none';
            });
        } else {
            if (!alertActive) startOsc();
            var el = document.getElementById('alertBannerSound'); if (el) el.style.display = 'none';
        }
    }

    var alertChimeAudio = new Audio('alert-chime.mp3');
    alertChimeAudio.preload = 'auto'; alertChimeAudio.volume = 0.3;
    var alertLoopTimer = null;

    function startOsc() {
        alertActive = true;
        function playSequence() {
            if (!alertActive) return;
            alertChimeAudio.currentTime = 0; alertChimeAudio.volume = 0.3;
            alertChimeAudio.play().catch(function(){});
            alertLoopTimer = setTimeout(function(){ if (!alertActive) return; speakAlert(); }, 8800);
        }
        function speakAlert() {
            if (!('speechSynthesis' in window)) { scheduleNext(); return; }
            var stored = [];
            try { stored = JSON.parse(localStorage.getItem('studioAlerts') || '[]'); } catch(e){}
            var lastNew = null;
            for (var i=0;i<stored.length;i++) { if (stored[i].status === 'sent') { lastNew = stored[i]; break; } }
            var text = 'Attention, alerte studio.';
            if (lastNew) {
                var prenom = lastNew.emitter ? lastNew.emitter.name.split(' ')[0] : '';
                var desc = lastNew.title || lastNew.description || '';
                if (prenom && desc) text = prenom + ' signale : ' + desc;
                else if (prenom) text = 'Alerte de ' + prenom;
                else if (desc) text = 'Attention : ' + desc;
            }
            window.speechSynthesis.cancel();
            var utt = new SpeechSynthesisUtterance(text);
            utt.lang = 'fr-FR'; utt.rate = 0.9; utt.pitch = 1.05; utt.volume = 0.3;
            var voices = window.speechSynthesis.getVoices();
            var pref = null;
            for (var v=0;v<voices.length;v++) {
                if (voices[v].lang==='fr-FR' && voices[v].name.indexOf('Amelie')>-1) { pref=voices[v]; break; }
                if (voices[v].lang==='fr-FR' && voices[v].name.indexOf('Thomas')>-1 && !pref) pref=voices[v];
                if (voices[v].lang.indexOf('fr')===0 && !pref) pref=voices[v];
            }
            if (pref) utt.voice = pref;
            utt.onend = function(){ scheduleNext(); };
            utt.onerror = function(){ scheduleNext(); };
            window.speechSynthesis.speak(utt);
        }
        function scheduleNext() { alertLoopTimer = setTimeout(function(){ if (alertActive) playSequence(); }, 2000); }
        if ('speechSynthesis' in window) window.speechSynthesis.getVoices();
        playSequence();
    }

    function stopSound() {
        alertActive = false;
        if (alertChimeAudio) { alertChimeAudio.pause(); alertChimeAudio.currentTime = 0; }
        if (alertLoopTimer) { clearTimeout(alertLoopTimer); alertLoopTimer = null; }
        if (window.speechSynthesis) window.speechSynthesis.cancel();
        alertNodes.forEach(function(n){ try{n.osc.stop();}catch(e){} });
        alertNodes = [];
        hideBanner();
    }

    function sendNotif(title, msg) {
        if (!('Notification' in window) || Notification.permission !== 'granted') return;
        try {
            var n = new Notification('\uD83D\uDEA8 ALERTE STUDIO', {
                body: (title || 'Alerte') + (msg ? ' \u2014 ' + msg : ''),
                requireInteraction: true, tag: 'studio-alert'
            });
            n.onclick = function() { window.focus(); n.close(); };
        } catch(e) {}
    }

    window._ackStudioAlert = function() {
        stopSound();
        if (alertWs && alertWs.readyState === WebSocket.OPEN) {
            var stored = [];
            try { stored = JSON.parse(localStorage.getItem('studioAlerts') || '[]'); } catch(e){}
            stored.forEach(function(a) {
                if (a.status === 'sent') {
                    a.status = 'handled'; a.handledAt = new Date().toISOString();
                    alertWs.send(JSON.stringify({type:'studio-alert-update', data:{id:a.id, status:'handled'}}));
                }
            });
            localStorage.setItem('studioAlerts', JSON.stringify(stored));
        }
    };

    var alertProxyTimer = null;
    var alertWsFails = 0;
    function startAlertProxyPolling() {
        if (alertProxyTimer) return;
        alertProxyTimer = setInterval(function() {
            fetch(ALERT_PROXY_URL + '?action=sync').then(function(r){ return r.json(); }).then(function(data) {
                if (!Array.isArray(data)) return;
                var stored = [];
                try { stored = JSON.parse(localStorage.getItem('studioAlerts') || '[]'); } catch(e){}
                var newOnes = data.filter(function(d){ return d.status === 'sent' && !stored.find(function(s){ return s.id === d.id; }); });
                localStorage.setItem('studioAlerts', JSON.stringify(data));
                if (newOnes.length > 0) {
                    showBanner(newOnes[0].title, newOnes[0].emitter ? newOnes[0].emitter.name : '');
                }
                if (!data.some(function(d){ return d.status === 'sent'; })) { stopSound(); }
            }).catch(function(){});
        }, 3000);
    }

    function connectAlertWS() {
        alertWs = new WebSocket(ALERT_WS_URL);
        alertWs.onmessage = function(e) {
            try {
                var msg = JSON.parse(e.data);
                if (msg.type === 'studio-alert' && msg.data && msg.data.status === 'sent') {
                    var stored = [];
                    try { stored = JSON.parse(localStorage.getItem('studioAlerts') || '[]'); } catch(ex){}
                    if (!stored.find(function(a){return a.id === msg.data.id;})) {
                        stored.unshift(msg.data); localStorage.setItem('studioAlerts', JSON.stringify(stored));
                    }
                    showBanner(msg.data.title, msg.data.emitter ? msg.data.emitter.name : '');
                }
                if (msg.type === 'studio-alert-update' && msg.data && msg.data.status !== 'sent') { stopSound(); }
            } catch(err) {}
        };
        alertWs.onclose = function(){
            alertWsFails = (alertWsFails || 0) + 1;
            if (alertWsFails >= 1) { startAlertProxyPolling(); } else { setTimeout(connectAlertWS, 3000); }
        };
        alertWs.onerror = function(){ alertWs.close(); };
    }

    // Check on load
    try {
        var existing = JSON.parse(localStorage.getItem('studioAlerts') || '[]');
        if (existing.some(function(a){return a.status === 'sent';})) {
            var last = existing.find(function(a){return a.status === 'sent';});
            setTimeout(function(){ showBanner(last.title, last.emitter ? last.emitter.name : ''); }, 500);
        }
    } catch(e){}

    connectAlertWS();
})();
</script>

<div id="versionBadge" style="position:fixed;bottom:6px;left:8px;z-index:9998;font-family:-apple-system,sans-serif;font-size:9px;color:rgba(255,255,255,0.45);pointer-events:none;background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:4px;">v48</div>
</body>
</html>
