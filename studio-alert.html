<!-- studio-alert v3.0 - 2026-02-18 -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Alert</title>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Helvetica Neue', Helvetica, Arial, sans-serif !important; }
        body { background: #0f0f15; color: #fff; min-height: 100vh; padding: 20px; }

        .header { display: flex; align-items: center; justify-content: space-between; max-width: 1100px; margin: 0 auto 24px; }
        .header-left { display: flex; align-items: center; gap: 14px; }
        .header h1 { font-size: 24px; font-weight: 700; letter-spacing: -0.3px; }
        .header h1 span { color: #ff4444; }
        .back-btn { color: rgba(255,255,255,0.4); text-decoration: none; font-size: 13px; padding: 6px 14px; border-radius: 8px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); transition: all 0.2s; }
        .back-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .week-label { font-size: 13px; color: rgba(255,255,255,0.35); }

        .alert-trigger-zone { max-width: 1100px; margin: 0 auto 30px; text-align: center; }
        .alert-big-btn {
            display: inline-flex; align-items: center; gap: 12px;
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: #fff; font-size: 16px; font-weight: 700; padding: 16px 40px;
            border: none; border-radius: 14px; cursor: pointer;
            box-shadow: 0 4px 20px rgba(255,65,108,0.4); transition: all 0.2s;
        }
        .alert-big-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(255,65,108,0.5); }
        .alert-big-btn:active { transform: scale(0.97); }
        .alert-big-btn svg { width: 22px; height: 22px; fill: none; stroke: #fff; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .sound-test { font-size: 11px; color: rgba(255,255,255,0.3); cursor: pointer; margin-left: 12px; }
        .sound-test:hover { color: #fff; }

        /* FORM */
        .alert-form { display: none; max-width: 1100px; margin: 0 auto 30px; background: rgba(255,65,108,0.08); border: 1px solid rgba(255,65,108,0.2); border-radius: 16px; padding: 24px; }
        .alert-form.visible { display: block; }
        .alert-form h3 { font-size: 15px; margin-bottom: 16px; color: #ff416c; }

        /* EMITTER PICKER */
        .emitter-label { font-size: 11px; color: rgba(255,255,255,0.4); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }
        .emitter-grid { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; max-height: 200px; overflow-y: auto; padding: 4px; }
        .prsnet-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; max-height: 280px; overflow-y: auto; margin-bottom: 10px; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.1) transparent; }
        .prsnet-row { display: flex; align-items: center; gap: 7px; padding: 4px 6px; border-radius: 6px; cursor: pointer; transition: all 0.15s; border: 1px solid transparent; }
        .prsnet-row:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.08); }
        .prsnet-row.selected { background: rgba(255,165,0,0.08); border-color: rgba(255,165,0,0.4); }
        .prsnet-thumb { width: 56px; height: 38px; border-radius: 5px; background-size: cover; background-position: center; flex-shrink: 0; position: relative; overflow: hidden; }
        .prsnet-thumb::after { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.1); }
        .prsnet-info { flex: 1; min-width: 0; }
        .prsnet-em-badge { display: inline-block; border-radius: 3px; padding: 1px 5px; font-size: 8px; font-weight: 800; color: #fff; letter-spacing: 0.2px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); vertical-align: middle; }
        .prsnet-title { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.9); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3; }
        .prsnet-meta { font-size: 8px; color: rgba(255,255,255,0.3); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .prsnet-state { font-size: 8px; margin-left: 3px; }
        .prsnet-state.pub { color: rgba(74,222,128,0.7); }
        .prsnet-state.draft { color: rgba(251,191,36,0.7); }
        .problem-grid { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
        .problem-btn {
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            padding: 10px 6px 8px; min-width: 72px; border-radius: 14px; cursor: pointer;
            background: linear-gradient(135deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
            border: 1.5px solid rgba(255,255,255,0.06);
            transition: all 0.2s; backdrop-filter: blur(4px);
        }
        .problem-btn:hover { border-color: rgba(255,255,255,0.15); background: linear-gradient(135deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03)); transform: translateY(-1px); }
        .problem-btn.selected { border-color: rgba(255,100,100,0.5); background: linear-gradient(135deg, rgba(255,80,80,0.15), rgba(200,50,50,0.08)); box-shadow: 0 4px 15px rgba(255,80,80,0.12); transform: translateY(-1px); }
        .problem-btn .pb-icon {
            width: 34px; height: 34px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
        }
        .problem-btn .pb-icon svg { width: 18px; height: 18px; stroke: #fff; stroke-width: 1.8; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .problem-btn .pb-label { font-size: 7.5px; font-weight: 700; color: rgba(255,255,255,0.45); text-align: center; line-height: 1.2; text-transform: uppercase; letter-spacing: 0.3px; }
        .emitter-card {
            display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 10px 12px;
            border-radius: 14px; cursor: pointer; transition: all 0.15s; border: 2px solid transparent;
            background: rgba(255,255,255,0.03); min-width: 85px;
        }
        .emitter-card:hover { background: rgba(255,255,255,0.08); }
        .emitter-card.selected { border-color: #ff416c; background: rgba(255,65,108,0.12); }
        .emitter-avatar {
            width: 56px; height: 56px; border-radius: 50%; background: rgba(255,255,255,0.08);
            display: flex; align-items: center; justify-content: center; font-size: 17px; font-weight: 700;
            overflow: hidden; color: rgba(255,255,255,0.4);
        }
        .emitter-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .emitter-name { font-size: 11px; color: rgba(255,255,255,0.5); text-align: center; max-width: 85px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .form-row { margin-bottom: 12px; }
        .form-row input, .form-row textarea {
            width: 100%; padding: 10px 14px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px; color: #fff; font-size: 14px; outline: none; resize: vertical;
        }
        .form-row input:focus, .form-row textarea:focus { border-color: rgba(255,65,108,0.5); }
        .form-row input::placeholder, .form-row textarea::placeholder { color: rgba(255,255,255,0.2); }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .btn-cancel { padding: 9px 20px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: rgba(255,255,255,0.5); cursor: pointer; font-size: 13px; font-weight: 600; }
        .btn-send { padding: 9px 20px; background: linear-gradient(135deg, #ff416c, #ff4b2b); border: none; border-radius: 10px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 700; }

        /* STATUS BAR */
        .status-bar { max-width: 1100px; margin: 0 auto 20px; display: flex; gap: 12px; }
        .stat-box { flex: 1; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 12px 14px; text-align: center; }
        .stat-number { font-size: 24px; font-weight: 700; }
        .stat-number.c1 { color: #ff4444; }
        .stat-number.c2 { color: #ffaa00; }
        .stat-number.c3 { color: #0070f3; }
        .stat-number.c4 { color: #44cc66; }
        .stat-label { font-size: 9px; color: rgba(255,255,255,0.3); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }

        /* TABS */
        .tabs { display: flex; gap: 4px; max-width: 1100px; margin: 0 auto 20px; background: rgba(255,255,255,0.04); border-radius: 12px; padding: 4px; }
        .tab { flex: 1; text-align: center; padding: 10px; font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.4); border-radius: 9px; cursor: pointer; transition: all 0.2s; }
        .tab.active { background: rgba(255,255,255,0.08); color: #fff; }
        .tab .count { display: inline-block; background: rgba(255,65,108,0.3); color: #ff6b6b; font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 10px; margin-left: 6px; }

        /* ALERTS LIST */
        .alerts-container { max-width: 1100px; margin: 0 auto; }
        .alert-card {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
            border-radius: 14px; padding: 16px 20px; margin-bottom: 10px; transition: all 0.2s;
        }
        .alert-card:hover { background: rgba(255,255,255,0.05); }
        .alert-top { display: flex; align-items: center; gap: 14px; margin-bottom: 10px; }
        .alert-emitter-photo { width: 50px; height: 50px; border-radius: 50%; overflow: hidden; background: rgba(255,255,255,0.08); flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; color: rgba(255,255,255,0.3); }
        .alert-emitter-photo img { width: 100%; height: 100%; object-fit: cover; }
        .alert-info { flex: 1; }
        .alert-title { font-size: 14px; font-weight: 600; }
        .alert-meta { font-size: 11px; color: rgba(255,255,255,0.3); display: flex; gap: 12px; margin-top: 2px; }
        .alert-desc { font-size: 12px; color: rgba(255,255,255,0.45); margin-top: 6px; padding: 8px 12px; background: rgba(255,255,255,0.02); border-radius: 8px; line-height: 1.5; }

        /* STATUS PIPELINE */
        .status-pipeline { display: flex; align-items: center; gap: 0; margin-top: 12px; }
        .pipeline-step {
            flex: 1; text-align: center; padding: 8px 4px; font-size: 10px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.4px; cursor: pointer; transition: all 0.15s;
            border: 1px solid rgba(255,255,255,0.06); position: relative;
        }
        .pipeline-step:first-child { border-radius: 8px 0 0 8px; }
        .pipeline-step:last-child { border-radius: 0 8px 8px 0; }
        .pipeline-step.inactive { background: rgba(255,255,255,0.02); color: rgba(255,255,255,0.2); }
        .pipeline-step.active-sent { background: rgba(255,68,68,0.15); color: #ff6666; border-color: rgba(255,68,68,0.3); }
        .pipeline-step.active-handled { background: rgba(255,170,0,0.15); color: #ffcc44; border-color: rgba(255,170,0,0.3); }
        .pipeline-step.active-modif { background: rgba(0,112,243,0.15); color: #4da8ff; border-color: rgba(0,112,243,0.3); }
        .pipeline-step.active-fixed { background: rgba(68,204,102,0.15); color: #66dd88; border-color: rgba(68,204,102,0.3); }
        .pipeline-step:hover:not(.done) { background: rgba(255,255,255,0.06); }
        .pipeline-step.done { opacity: 0.5; }

        .alert-footer { display: flex; justify-content: flex-end; margin-top: 8px; }
        .btn-delete { background: rgba(255,255,255,0.04); color: rgba(255,255,255,0.2); border: none; padding: 5px 12px; border-radius: 6px; font-size: 10px; cursor: pointer; font-weight: 600; }
        .btn-delete:hover { background: rgba(255,68,68,0.15); color: #ff6666; }

        .empty-state { text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.2); font-size: 14px; }
        .empty-state svg { width: 48px; height: 48px; stroke: rgba(255,255,255,0.1); fill: none; stroke-width: 1.5; margin-bottom: 12px; display: block; margin: 0 auto 12px; }

        /* WEEKLY */
        .summary-section { margin-bottom: 24px; }
        .summary-title { font-size: 13px; font-weight: 700; color: rgba(255,255,255,0.5); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.8px; }
        .summary-item { display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 10px; padding: 12px 16px; margin-bottom: 6px; font-size: 13px; }
        .summary-icon { font-size: 16px; }
        .summary-item-title { flex: 1; }
        .summary-item-date { font-size: 11px; color: rgba(255,255,255,0.25); }

        .sync-status { font-size: 11px; color: rgba(255,255,255,0.3); display: flex; align-items: center; gap: 6px; }
        .sync-dot { width: 6px; height: 6px; border-radius: 50%; background: #44cc66; }
        .sync-dot.offline { background: #ff4444; }
    
/* === DOCK NAV === */

/* === DOCK NAV === */
.dock-nav{position:fixed;top:10px;right:12px;z-index:9999;display:flex;align-items:center;gap:4px;background:rgba(255,255,255,0.06);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.08);border-radius:13px;padding:4px 7px;}
.dock-nav a,.dock-nav .dock-btn{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s cubic-bezier(0.34,1.56,0.64,1);position:relative;text-decoration:none;border:none;outline:none;}
.dock-nav a:hover,.dock-nav .dock-btn:hover{transform:scale(1.3) translateY(-3px);z-index:10;}
.dock-nav a:hover .dk-tip,.dock-nav .dock-btn:hover .dk-tip{opacity:1;transform:translateX(-50%) translateY(0);}
.dock-nav svg{width:14px;height:14px;fill:none;stroke:rgba(255,255,255,0.9);stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;}
.dock-nav .dk-inv svg{stroke:rgba(0,0,0,0.6);}
.dk-tip{position:absolute;top:calc(100% + 5px);left:50%;transform:translateX(-50%) translateY(-3px);background:rgba(0,0,0,0.85);backdrop-filter:blur(12px);color:#fff;font-size:8px;font-weight:600;padding:2px 6px;border-radius:4px;white-space:nowrap;opacity:0;pointer-events:none;transition:all 0.15s ease;letter-spacing:0.2px;font-family:-apple-system,sans-serif;}
.dk-act::after{content:'';position:absolute;bottom:-2px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,0.7);}
.dk-sep{width:1px;height:20px;background:rgba(255,255,255,0.08);margin:0 1px;}
.dk-home{background:rgba(255,255,255,0.08)!important;border-radius:8px!important;}
.dk-home:hover{background:rgba(255,255,255,0.15)!important;}
.dk-home svg{stroke:rgba(255,255,255,0.5)!important;}
.dr{background:linear-gradient(135deg,#ff416c,#ff4b2b);}
.dp{background:linear-gradient(135deg,#8b5cf6,#6366f1);}
.dc{background:linear-gradient(135deg,#00d2ff,#3a7bd5);}
.dv{background:linear-gradient(135deg,#667eea,#764ba2);}
.dk{background:linear-gradient(135deg,#f093fb,#f5576c);}
.dg{background:linear-gradient(135deg,#43e97b,#38f9d7);}
.do{background:linear-gradient(135deg,#f6d365,#fda085);}
.dt{background:linear-gradient(135deg,#0d9488,#06b6d4);}
.dd{background:linear-gradient(135deg,#1c2028,#2d2d2d);border:1px solid rgba(255,255,255,0.1);}

/* === END DOCK === */
</style>
</head>
<body>
<!-- DOCK START -->
<nav class="dock-nav"><a href="studio-manager.html" class="dk-home"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg><span class="dk-tip">Accueil</span></a><div class="dk-sep"></div><a href="https://lezenesvincent-dotcom.github.io/regie-video/" class="dr"><svg viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg><span class="dk-tip">R&eacute;gie</span></a><a href="agenda-studio.html" class="dp"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class="dk-tip">Agenda</span></a><a href="vignettes.html" class="dc"><svg viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="20" rx="3"/><circle cx="8" cy="8" r="2"/><path d="M21 15l-5-5L5 21"/></svg><span class="dk-tip">Vignettes</span></a><a href="creation.html" class="dv"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg><span class="dk-tip">Cr&eacute;ation</span></a><a href="manage-ei.html" class="dk"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg><span class="dk-tip">Manage</span></a><div class="dk-sep"></div><a href="contact-studio.html" class="dg dk-inv"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg><span class="dk-tip">Contact</span></a><a href="prestation.html" class="do dk-inv"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg><span class="dk-tip">Prestations</span></a><a href="carnet.html" class="dt"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span class="dk-tip">Carnet</span></a><div class="dk-sep"></div><a href="studio-2027.html" class="dd"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span class="dk-tip">2027</span></a><a href="studio-alert.html" class="dr dk-act"><svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg><span class="dk-tip">Alert</span></a><a href="dev-dashboard.html" class="dd"><svg viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg><span class="dk-tip">Dev</span></a></nav>
<!-- DOCK END -->

    <div class="header">
        <div class="header-left">
            <a href="studio-manager.html" class="back-btn">&larr; Studio</a>
            <h1>&#x1F6A8; Studio <span>Alert</span></h1>
        </div>
        <div style="display:flex;align-items:center;gap:16px;">
            <div class="week-label" id="weekLabel"></div>
            <button onclick="clearAllAlerts()" style="background:rgba(255,80,80,0.1);border:1.5px solid rgba(255,80,80,0.4);color:rgba(255,80,80,0.8);font-size:12px;padding:6px 16px;border-radius:8px;cursor:pointer;font-weight:700;letter-spacing:0.3px;transition:all 0.2s;" onmouseover="this.style.background='rgba(255,80,80,0.2)';this.style.borderColor='rgba(255,80,80,0.7)';this.style.color='#ff5050'" onmouseout="this.style.background='rgba(255,80,80,0.1)';this.style.borderColor='rgba(255,80,80,0.4)';this.style.color='rgba(255,80,80,0.8)'">&#x1F5D1; Clear all</button>
            <div class="sync-status"><div class="sync-dot" id="syncDot"></div><span id="syncText">Connexion...</span></div>
        </div>
    </div>

    <div class="status-bar">
        <div class="stat-box"><div class="stat-number c1" id="countSent">0</div><div class="stat-label">Envoy&eacute;es</div></div>
        <div class="stat-box"><div class="stat-number c2" id="countHandled">0</div><div class="stat-label">Prises en charge</div></div>
        <div class="stat-box"><div class="stat-number c3" id="countModif">0</div><div class="stat-label">Modification</div></div>
        <div class="stat-box"><div class="stat-number c4" id="countFixed">0</div><div class="stat-label">R&eacute;par&eacute;</div></div>
    </div>

    <div class="alert-trigger-zone">
        <button class="alert-big-btn" onclick="toggleAlertForm()">
            <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
            D&Eacute;CLENCHER UNE ALERTE
        </button>
        <span class="sound-test" onclick="testSound()">&#x1F50A; Tester le son</span>
    </div>

    <div class="alert-form" id="alertForm">
        <h3>&#x26A0;&#xFE0F; Nouvelle alerte</h3>
        <div class="emitter-label">&Eacute;metteur</div>
        <div class="emitter-grid" id="emitterGrid"></div>
        <div class="emitter-label" style="margin-top:12px;">Contenus PRSNET <span style="font-weight:400;opacity:0.4" id="prsnetCount"></span></div>
        <div class="form-row" style="margin-bottom:4px;">
            <input type="text" id="prsnetSearch" placeholder="&#x1F50D; Rechercher..." oninput="filterAllContent()" style="font-size:10px;padding:5px 10px;" />
        </div>
        <div class="prsnet-list" id="allContentGrid"></div>
        <div class="emitter-label" style="margin-top:8px;">Type de probl&egrave;me</div>
        <div class="problem-grid" id="problemGrid"></div>
        <div class="form-row">
            <input type="text" id="alertTitle" placeholder="Titre de l'alerte..." />
        </div>
        <div class="form-row">
            <textarea id="alertDesc" placeholder="Description d&eacute;taill&eacute;e..." rows="4"></textarea>
        </div>
        <div class="form-actions">
            <button class="btn-cancel" onclick="toggleAlertForm()">Annuler</button>
            <button class="btn-send" onclick="sendAlert()">&#x1F6A8; Envoyer l'alerte</button>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('alerts')" id="tabAlerts">Alertes <span class="count" id="alertCount">0</span></div>
        <div class="tab" onclick="switchTab('week')" id="tabWeek">Semaine</div>
    </div>

    <div class="alerts-container" id="alertsView"></div>
    <div class="alerts-container" id="weekView" style="display:none;"></div>

    <script>
    const WS_URL = 'wss://ecamm-overlay-server.onrender.com';
    const API_URL = 'https://ecamm-overlay-server.onrender.com';
    const PROXY_URL = 'https://script.google.com/macros/s/AKfycbzjO0-wHGd-uIIJhnpmBAVQxIruHnQUpnvFpsrEqAsSDkerG8z0Cp47HYgojMHlOG9pFQ/exec';
    var useProxy = false;
    let ws = null;
    let alerts = [];
    let contacts = [];
    let selectedEmitter = null;
    let selectedDraft = null;
    let selectedProblem = null;
    let weekContent = { vignettes: [], agenda: [] };

    const PROBLEMS = [
        { id: 'vignette_ko', icon: '<div style="background:linear-gradient(135deg,#ff6b6b,#ee5a24);border-radius:10px;width:34px;height:34px;display:flex;align-items:center;justify-content:center"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="3"/><line x1="9" y1="9" x2="15" y2="15"/><line x1="15" y1="9" x2="9" y2="15"/></svg></div>', label: 'Vignettes\nKO' },
        { id: 'debut_gen', icon: '<div style="background:linear-gradient(135deg,#a55eea,#8854d0);border-radius:10px;width:34px;height:34px;display:flex;align-items:center;justify-content:center"><svg viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg></div>', label: 'DÃ©faut DÃ©but\ngÃ©nÃ©rique' },
        { id: 'fin_gen', icon: '<div style="background:linear-gradient(135deg,#8854d0,#6c5ce7);border-radius:10px;width:34px;height:34px;display:flex;align-items:center;justify-content:center"><svg viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"/><polygon points="14,4 22,12 14,20"/></svg></div>', label: 'DÃ©faut Fin\ngÃ©nÃ©rique' },
        { id: 'pb_synthe', icon: '<div style="background:linear-gradient(135deg,#0984e3,#74b9ff);border-radius:10px;width:34px;height:34px;display:flex;align-items:center;justify-content:center"><svg viewBox="0 0 24 24"><rect x="3" y="12" width="4" height="9" rx="1"/><rect x="10" y="7" width="4" height="14" rx="1"/><rect x="17" y="3" width="4" height="18" rx="1"/></svg></div>', label: 'Pb SynthÃ©' },
        { id: 'pb_son', icon: '<div style="background:linear-gradient(135deg,#e17055,#d63031);border-radius:10px;width:34px;height:34px;display:flex;align-items:center;justify-content:center"><svg viewBox="0 0 24 24"><polygon points="11,5 6,9 2,9 2,15 6,15 11,19"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg></div>', label: 'Pb Direct\nSon' },
        { id: 'pb_image', icon: '<div style="background:linear-gradient(135deg,#fdcb6e,#e17055);border-radius:10px;width:34px;height:34px;display:flex;align-items:center;justify-content:center"><svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="18" rx="3"/><circle cx="8" cy="10" r="2"/><path d="M21 15l-5-5L5 21"/></svg></div>', label: 'Pb Direct\nImage' },
        { id: 'pb_bandeau', icon: '<div style="background:linear-gradient(135deg,#00b894,#00cec9);border-radius:10px;width:34px;height:34px;display:flex;align-items:center;justify-content:center"><svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="10" rx="2"/><line x1="6" y1="12" x2="18" y2="12"/></svg></div>', label: 'Pb Bandeau' },
        { id: 'pb_ibm', icon: '<div style="background:linear-gradient(135deg,#636e72,#2d3436);border-radius:10px;width:34px;height:34px;display:flex;align-items:center;justify-content:center"><svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></div>', label: 'Pb IBM TV' },
        { id: 'pb_chat', icon: '<div style="background:linear-gradient(135deg,#0984e3,#6c5ce7);border-radius:10px;width:34px;height:34px;display:flex;align-items:center;justify-content:center"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>', label: 'Pb Chat' },
        { id: 'pb_qr', icon: '<div style="background:linear-gradient(135deg,#fdcb6e,#f39c12);border-radius:10px;width:34px;height:34px;display:flex;align-items:center;justify-content:center"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div>', label: 'Pb Q&R' }
    ];

    function renderProblemGrid() {
        const grid = document.getElementById('problemGrid');
        grid.innerHTML = PROBLEMS.map(p => {
            const sel = selectedProblem === p.id ? ' selected' : '';
            const labelHtml = p.label.replace(/\n/g, '<br>');
            return '<div class="problem-btn' + sel + '" onclick="selectProblem(\'' + p.id + '\')">' +
                '<div class="pb-icon">' + p.icon + '</div>' +
                '<div class="pb-label">' + labelHtml + '</div></div>';
        }).join('');
    }

    function selectProblem(id) {
        if (selectedProblem === id) {
            selectedProblem = null;
            document.getElementById('alertTitle').value = '';
        } else {
            selectedProblem = id;
            const p = PROBLEMS.find(x => x.id === id);
            if (p) {
                const problemLabel = p.label.replace(/\n/g, ' ');
                const currentTitle = document.getElementById('alertTitle').value;
                if (!currentTitle || PROBLEMS.some(x => currentTitle === x.label.replace(/\n/g, ' '))) {
                    document.getElementById('alertTitle').value = problemLabel;
                } else {
                    document.getElementById('alertTitle').value = currentTitle + ' â€” ' + problemLabel;
                }
            }
        }
        renderProblemGrid();
    }

    // GitHub access for PRSNET drafts
    const GH_TOKEN = ['s6Q6VG_phg','71QRNKGR8m','EiaK9FWAqE','cWTym0zJLw'].map(s => s.split('').reverse().join('')).join('');
    const GH_REPO = 'lezenesvincent-dotcom/mon-content-manager';

    const EMISSION_GRADIENTS_REF = { morning:'#f6d365', conf:'#667eea', hot:'#ff416c', da:'#00d2ff', dc:'#1a3a8a', expert:'#43e97b', echo:'#f093fb', decryptage:'#a18cd1' };

    function detectEmission(tags, title) {
        var t = (tags||'').toLowerCase(), ti = (title||'').toLowerCase();
        // Ordre important : spÃ©cifique d'abord
        if (ti.indexOf('direct corporate') > -1 || t.indexOf('direct corporate') > -1) return 'dc';
        if (t.indexOf('direct analystes') > -1 || ti.indexOf('direct analystes') > -1 || ti.indexOf('direct analyste') > -1) return 'da';
        if (t.indexOf('direct expert') > -1 || ti.indexOf('direct expert') > -1) return 'expert';
        if (t.indexOf('confÃ©rence hebdo') > -1 || t.indexOf('conference hebdo') > -1 || ti.indexOf('conf call') > -1 || ti.indexOf('confÃ©rence hebdo') > -1) return 'conf';
        if (t.indexOf('echo hebdo') > -1 || t.indexOf("l'echo hebdo") > -1 || ti.indexOf('echo hebdo') > -1 || ti.indexOf("l'Ã©cho hebdo") > -1 || ti.indexOf("l'echo hebdo") > -1) return 'echo';
        if (t.indexOf('chart solutions') > -1 || ti.indexOf('chart solutions') > -1) return 'hot';
        if (t.indexOf('chart equity') > -1 || ti.indexOf('chart equity') > -1) return 'hot';
        if (t.indexOf('morning meeting') > -1 || t.indexOf('morning') > -1 || t.indexOf("l'eclaireur") > -1 || t.indexOf("l'Ã©claireur") > -1) return 'morning';
        if (ti.indexOf('morning') > -1) return 'morning';
        if (t.indexOf('dÃ©cryptage') > -1 || t.indexOf('decryptage') > -1 || ti.indexOf('dÃ©cryptage') > -1 || ti.indexOf('decryptage') > -1) return 'decryptage';
        // Fallback: si titre contient "NOM : sujet" sans emission, c'est probablement un DA
        if (!t && ti.match(/^[^:]+:\s+/)) return 'da';
        return '';
    }

    function extractSubject(title, emission) {
        var t = title || '';
        if (t.indexOf(':') > -1) {
            var beforeColon = t.split(':')[0].trim();
            var prefixes = ['Direct Corporate DÃ©veloppement Durable','Direct Corporate','Direct Analystes','Direct Expert'];
            for (var i = 0; i < prefixes.length; i++) {
                if (beforeColon.toLowerCase().indexOf(prefixes[i].toLowerCase()) === 0) {
                    var afterColon = t.split(':').slice(1).join(':').trim();
                    if (afterColon.indexOf(':') > -1) return afterColon.split(':')[0].trim();
                    return afterColon;
                }
            }
            if (emission === 'morning') return beforeColon;
            return beforeColon;
        }
        return t;
    }

    const EM_GRADIENTS = { morning:'linear-gradient(135deg,#f6d365,#fda085)', conf:'linear-gradient(135deg,#667eea,#764ba2)', hot:'linear-gradient(135deg,#ff416c,#ff4b2b)', da:'linear-gradient(135deg,#00d2ff,#3a7bd5)', dc:'linear-gradient(135deg,#1a3a8a,#6b2fa0)', expert:'linear-gradient(135deg,#43e97b,#38f9d7)', echo:'linear-gradient(135deg,#f093fb,#f5576c)', decryptage:'linear-gradient(135deg,#a18cd1,#fbc2eb)' };
    const EM_NAMES = { morning:'Morning', conf:'Conf Hebdo', hot:'Hot', da:'Direct Analystes', dc:'Direct Corporate', expert:'Direct Expert', echo:'Ã‰cho Hebdo', decryptage:'DÃ©cryptage' };
    const EM_IMGS = { morning:'vignette-assets/MORNING_FOND.png', conf:'vignette-assets/CONF_CALL_FOND.png', hot:'vignette-assets/MODELE_HOT_001.png', da:'vignette-assets/FOND_DIRECT_ANALYSTE_001.png', dc:'vignette-assets/FOND_DIRECT_CORPORATE_png_001.png', expert:'vignette-assets/MORNING_FOND.png', echo:'vignette-assets/ECHO_HEBDO_FOND.png', decryptage:'vignette-assets/MORNING_FOND.png' };

    let prsnetData = { drafts: [], published: [], recent: [] };
    let allPrsnetItems = [];

    function renderDraftSlot(item, grid) {
        const row = document.createElement('div');
        row.className = 'prsnet-row';
        const title = item.title || '';
        const date = item.date || '';
        const tags = item.tags || '';
        const emission = detectEmission(tags, title);
        const displayTitle = extractSubject(title, emission);
        const grad = EM_GRADIENTS[emission] || '';
        const emName = EM_NAMES[emission] || '';
        const emImg = EM_IMGS[emission] || '';

        const thumb = emImg ? '<div class="prsnet-thumb" style="background-image:url(' + emImg + ')"></div>' : '<div class="prsnet-thumb" style="background:rgba(255,255,255,0.06)"></div>';
        const badge = emission ? '<span class="prsnet-em-badge" style="background:' + grad + '">' + emName + '</span> ' : '';
        const stateIcon = item.state === 'publie' ? '<span class="prsnet-state pub">âœ“</span>' : (item.state === 'brouillon' ? '<span class="prsnet-state draft">âœŽ Brouillon</span>' : '');
        const author = item.author ? ' Â· ' + item.author : '';

        row.innerHTML = thumb +
            '<div class="prsnet-info">' +
            '<div class="prsnet-title">' + badge + displayTitle + stateIcon + '</div>' +
            '<div class="prsnet-meta">' + date + author + '</div>' +
            '</div>';
        row.title = title + (item.author ? ' â€” ' + item.author : '');
        row.onclick = (() => {
            document.querySelectorAll('.prsnet-row').forEach(d => d.classList.remove('selected'));
            if (selectedDraft && selectedDraft.title === item.title) {
                selectedDraft = null;
                document.getElementById('alertTitle').value = '';
            } else {
                selectedDraft = item;
                row.classList.add('selected');
                const emLabel = EM_NAMES[emission] || '';
                document.getElementById('alertTitle').value = (emLabel ? emLabel + ' â€” ' : '') + displayTitle;
            }
        });
        grid.appendChild(row);
    }

    function renderAllContent(items) {
        const grid = document.getElementById('allContentGrid');
        grid.innerHTML = '';
        if (items.length === 0) {
            grid.innerHTML = '<div style="text-align:center;font-size:9px;color:rgba(255,255,255,0.2);padding:8px;">Aucun contenu</div>';
            return;
        }
        items.forEach(item => renderDraftSlot(item, grid));
        document.getElementById('prsnetCount').textContent = '(' + items.length + ')';
    }

    function filterAllContent() {
        const q = (document.getElementById('prsnetSearch').value || '').toLowerCase().trim();
        if (!q) {
            renderAllContent(allPrsnetItems);
            return;
        }
        const seen = {};
        const filtered = allPrsnetItems.filter(item => {
            const match = (item.title || '').toLowerCase().indexOf(q) > -1 ||
                   (item.tags || '').toLowerCase().indexOf(q) > -1 ||
                   (item.author || '').toLowerCase().indexOf(q) > -1;
            if (!match || seen[item.id]) return false;
            seen[item.id] = true;
            return true;
        });
        renderAllContent(filtered);
    }

    function parsePrsnetDate(dateStr) {
        if (!dateStr) return null;
        var m = dateStr.match(/(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2}):(\d{2})/);
        if (!m) return null;
        return new Date(+m[3], +m[2]-1, +m[1], +m[4], +m[5], +m[6]);
    }

    function getLastNBusinessDays(n) {
        var days = [];
        var d = new Date();
        while (days.length < n) {
            d.setDate(d.getDate() - (days.length === 0 ? 0 : 1));
            var dow = d.getDay();
            if (dow !== 0 && dow !== 6) {
                days.push(new Date(d.getFullYear(), d.getMonth(), d.getDate()));
            }
            if (days.length === 0) d.setDate(d.getDate() - 1);
        }
        return days[days.length - 1]; // oldest date
    }

    async function loadPrsnetDrafts() {
        try {
            const r = await fetch('https://api.github.com/repos/' + GH_REPO + '/contents/prsnet-drafts.json', {
                headers: { 'Authorization': 'token ' + GH_TOKEN, 'Accept': 'application/vnd.github.v3+json' }, cache: 'no-store'
            });
            if (!r.ok) return;
            const d = await r.json();
            prsnetData = JSON.parse(decodeURIComponent(escape(atob(d.content))));

            // Fusionner tous les items, dÃ©dup par id
            var all = [], seen = {};
            var sources = [prsnetData.drafts || [], prsnetData.published || [], prsnetData.recent || []];
            sources.forEach(function(src) {
                src.forEach(function(item) {
                    if (!seen[item.id]) { seen[item.id] = true; all.push(item); }
                });
            });

            // Trier par date dÃ©croissante
            all.sort(function(a, b) {
                var da = parsePrsnetDate(a.date), db = parsePrsnetDate(b.date);
                if (!da && !db) return 0;
                if (!da) return 1;
                if (!db) return -1;
                return db - da;
            });

            allPrsnetItems = all;
            renderAllContent(all);
        } catch(e) { console.error('PRSNET drafts:', e); }
    }

    const STATUSES = ['sent','handled','modif','fixed'];
    const STATUS_LABELS = { sent: 'EnvoyÃ©', handled: 'Prise en charge', modif: 'Modification', fixed: 'RÃ©parÃ©' };
    const STATUS_CLASSES = { sent: 'active-sent', handled: 'active-handled', modif: 'active-modif', fixed: 'active-fixed' };

    // ===== WEEK LABEL =====
    function updateWeekLabel() {
        const now = new Date();
        const monday = new Date(now);
        monday.setDate(now.getDate() - ((now.getDay() + 6) % 7));
        const friday = new Date(monday);
        friday.setDate(monday.getDate() + 4);
        const fmt = d => d.getDate() + '/' + (d.getMonth()+1);
        document.getElementById('weekLabel').textContent = 'Semaine du ' + fmt(monday) + ' au ' + fmt(friday);
    }
    updateWeekLabel();

    // ===== FORM =====
    function toggleAlertForm() {
        const form = document.getElementById('alertForm');
        form.classList.toggle('visible');
        if (form.classList.contains('visible')) {
            document.getElementById('alertTitle').focus();
            loadPrsnetDrafts();
            renderProblemGrid();
        }
    }

    // ===== EMITTER GRID =====
    function renderEmitterGrid() {
        const grid = document.getElementById('emitterGrid');
        grid.innerHTML = EMITTERS.map(c => {
            const initials = (c.firstName[0] || '') + (c.lastName[0] || '');
            const photoHtml = c.photo && c.photo.length > 10
                ? '<img src="' + c.photo + '" onerror="this.parentElement.textContent=\'' + initials + '\'">'
                : initials;
            const sel = selectedEmitter === c.id ? ' selected' : '';
            return '<div class="emitter-card' + sel + '" onclick="selectEmitter(\'' + c.id + '\')">' +
                '<div class="emitter-avatar">' + photoHtml + '</div>' +
                '<div class="emitter-name">' + c.firstName + '</div>' +
            '</div>';
        }).join('');
    }

    function selectEmitter(id) {
        selectedEmitter = selectedEmitter === id ? null : id;
        renderEmitterGrid();
    }

    // ===== ALARM SOUND - MP3 CHIME + VOICE =====
    let audioCtx = null;
    let alarmNodes = [];
    let alarmActive = false;
    let chimeAudio = null;
    let chimeLoopTimer = null;

    // PrÃ©charger le MP3
    function preloadChime() {
        chimeAudio = new Audio('alert-chime.mp3');
        chimeAudio.preload = 'auto';
        chimeAudio.volume = 0.3;
    }
    preloadChime();

    function startAlarm() {
        showAlarmOverlay();
    }

    function stopAlarm() {
        alarmActive = false;
        if (chimeAudio) { chimeAudio.pause(); chimeAudio.currentTime = 0; }
        if (chimeLoopTimer) { clearTimeout(chimeLoopTimer); chimeLoopTimer = null; }
        window.speechSynthesis && window.speechSynthesis.cancel();
        alarmNodes.forEach(n => { try { n.osc.stop(); } catch(e) {} });
        alarmNodes = [];
        hideAlarmOverlay();
    }

    function playAlertSound() { startAlarm(); }
    function testSound() {
        if (chimeAudio) {
            chimeAudio.currentTime = 0;
            chimeAudio.play().catch(() => {});
        }
    }

    // ===== ALARM OVERLAY (red flashing fullscreen) =====
    function showAlarmOverlay() {
        let ov = document.getElementById('alarmOverlay');
        if (!ov) {
            ov = document.createElement('div');
            ov.id = 'alarmOverlay';
            ov.style.cssText = 'position:fixed;inset:0;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(255,0,0,0.85);animation:alarmFlash 0.5s infinite;cursor:pointer;';
            ov.innerHTML = '<div style="font-size:72px;margin-bottom:20px;">&#x1F6A8;</div>' +
                '<div style="font-size:28px;font-weight:800;color:#fff;text-align:center;margin-bottom:12px;">ALERTE STUDIO</div>' +
                '<div style="font-size:16px;color:rgba(255,255,255,0.8);margin-bottom:10px;" id="alarmMsg"></div>' +
                '<div style="font-size:14px;color:rgba(255,255,255,0.6);margin-bottom:30px;" id="alarmNoSound">&#x1F50A; Cliquez n\'importe o&ugrave; pour activer le son</div>' +
                '<button onclick="acknowledgeAlarm()" style="padding:18px 50px;font-size:18px;font-weight:800;background:#fff;color:#ff0000;border:none;border-radius:14px;cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,0.3);text-transform:uppercase;letter-spacing:1px;">&#x2705; PRISE EN CHARGE</button>';
            document.body.appendChild(ov);
            if (!document.getElementById('alarmStyle')) {
                const style = document.createElement('style');
                style.id = 'alarmStyle';
                style.textContent = '@keyframes alarmFlash { 0%,100% { background:rgba(255,0,0,0.85); } 50% { background:rgba(180,0,0,0.95); } }';
                document.head.appendChild(style);
            }
            // Any click on overlay (not on button) will start sound
            ov.addEventListener('click', function(e) {
                if (e.target.tagName !== 'BUTTON') {
                    forceStartSound();
                }
            });
        }
        ov.style.display = 'flex';
        const lastNew = alerts.find(a => a.status === 'sent');
        if (lastNew) {
            document.getElementById('alarmMsg').textContent = lastNew.title + (lastNew.emitter ? ' â€” ' + lastNew.emitter.name : '');
        }
        // Try to start sound immediately
        forceStartSound();
        // Also send browser notification
        sendBrowserNotification(lastNew);
    }

    function forceStartSound() {
        if (!alarmActive) startAlarmLoop();
        const el = document.getElementById('alarmNoSound');
        if (el) el.style.display = 'none';
    }

    function startAlarmLoop() {
        alarmActive = true;

        function playSequence() {
            if (!alarmActive) return;
            // 1) Jouer le MP3 chime
            if (chimeAudio) {
                chimeAudio.currentTime = 0;
                chimeAudio.volume = 0.3;
                chimeAudio.play().catch(() => {});
            }
            // 2) AprÃ¨s le chime (~8s pour Ãªtre safe), lancer la voix
            chimeLoopTimer = setTimeout(() => {
                if (!alarmActive) return;
                speakAlert();
            }, 8800);
        }

        function speakAlert() {
            if (!('speechSynthesis' in window)) { scheduleNext(); return; }
            const lastNew = alerts.find(a => a.status === 'sent');
            let text = 'Attention, alerte studio.';
            if (lastNew) {
                const prenom = lastNew.emitter ? lastNew.emitter.name.split(' ')[0] : '';
                const desc = lastNew.title || lastNew.description || '';
                if (prenom && desc) text = prenom + ' signale : ' + desc;
                else if (prenom) text = 'Alerte de ' + prenom;
                else if (desc) text = 'Attention : ' + desc;
            }
            window.speechSynthesis.cancel();
            const utt = new SpeechSynthesisUtterance(text);
            utt.lang = 'fr-FR';
            utt.rate = 0.9;
            utt.pitch = 1.05;
            utt.volume = 0.3;
            // PrÃ©fÃ©rer une voix fÃ©minine franÃ§aise de qualitÃ©
            const voices = window.speechSynthesis.getVoices();
            const preferred = voices.find(v => v.lang === 'fr-FR' && v.name.includes('Amelie')) ||
                              voices.find(v => v.lang === 'fr-FR' && v.name.includes('Thomas')) ||
                              voices.find(v => v.lang === 'fr-FR' && !v.localService) ||
                              voices.find(v => v.lang.startsWith('fr'));
            if (preferred) utt.voice = preferred;
            utt.onend = () => { scheduleNext(); };
            utt.onerror = () => { scheduleNext(); };
            window.speechSynthesis.speak(utt);
        }

        function scheduleNext() {
            chimeLoopTimer = setTimeout(() => { if (alarmActive) playSequence(); }, 2000);
        }

        // Preload voices
        if ('speechSynthesis' in window) window.speechSynthesis.getVoices();
        playSequence();
    }

    // ===== BROWSER NOTIFICATIONS (work even when tab is in background) =====
    function requestNotifPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    }
    requestNotifPermission();

    function sendBrowserNotification(alert) {
        if (!('Notification' in window) || Notification.permission !== 'granted') return;
        try {
            const n = new Notification('ðŸš¨ ALERTE STUDIO', {
                body: (alert ? alert.title : 'Nouvelle alerte') + (alert && alert.emitter ? ' â€” ' + alert.emitter.name : ''),
                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ðŸš¨</text></svg>',
                requireInteraction: true,
                tag: 'studio-alert'
            });
            n.onclick = function() { window.focus(); n.close(); };
        } catch(e) {}
    }

    function hideAlarmOverlay() {
        const ov = document.getElementById('alarmOverlay');
        if (ov) ov.style.display = 'none';
    }

    function acknowledgeAlarm() {
        // Set all 'sent' alerts to 'handled'
        alerts.forEach(a => {
            if (a.status === 'sent') {
                a.status = 'handled';
                a.handledAt = new Date().toISOString();
                if (ws && ws.readyState === WebSocket.OPEN)
                    ws.send(JSON.stringify({ type: 'studio-alert-update', data: { id: a.id, status: 'handled' } }));
            }
        });
        stopAlarm();
        saveAlerts();
        renderAlerts();
    }

    // ===== SEND =====
    function sendAlert() {
        const title = document.getElementById('alertTitle').value.trim();
        if (!title) { document.getElementById('alertTitle').style.borderColor = '#ff4444'; return; }
        const emitter = EMITTERS.find(c => c.id === selectedEmitter);
        const a = {
            id: Date.now().toString(),
            title: title,
            description: document.getElementById('alertDesc').value.trim(),
            emitter: emitter ? { id: emitter.id, name: emitter.firstName + ' ' + emitter.lastName, photo: emitter.photo || '' } : null,
            status: 'sent',
            createdAt: new Date().toISOString()
        };
        alerts.unshift(a);
        saveAlerts(); broadcastAlert(a);
        // Marquer cette machine comme Ã©mettrice pour 15 secondes
        localStorage.setItem('alertEmitter', Date.now().toString());
        // PAS de sonnerie sur le poste Ã©metteur â€” seules les machines rÃ©ceptrices sonnent
        toggleAlertForm();
        document.getElementById('alertTitle').value = '';
        document.getElementById('alertDesc').value = '';
        selectedEmitter = null; selectedDraft = null; selectedProblem = null; renderEmitterGrid(); renderProblemGrid(); renderAlerts();
    }

    // ===== STATUS CHANGE =====
    function setStatus(id, status) {
        const a = alerts.find(x => x.id === id);
        if (!a) return;
        a.status = status;
        a[status + 'At'] = new Date().toISOString();
        saveAlerts(); renderAlerts();
        if (ws && ws.readyState === WebSocket.OPEN)
            ws.send(JSON.stringify({ type: 'studio-alert-update', data: { id, status } }));
    }

    function deleteAlert(id) {
        if (!confirm('Supprimer cette alerte ?')) return;
        alerts = alerts.filter(x => x.id !== id);
        saveAlerts(); renderAlerts();
    }

    function clearAllAlerts() {
        if (!confirm('Supprimer TOUTES les alertes de la semaine ?')) return;
        alerts = [];
        saveAlerts(); renderAlerts();
        if (ws && ws.readyState === WebSocket.OPEN)
            ws.send(JSON.stringify({ type: 'studio-alert-update', data: { clearAll: true } }));
        fetch(API_URL + '/api/studio-alerts', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify([])
        }).catch(() => {});
    }

    // ===== BROADCAST =====
    function broadcastAlert(alert) {
        if (ws && ws.readyState === WebSocket.OPEN)
            ws.send(JSON.stringify({ type: 'studio-alert', data: alert }));
        fetch(API_URL + '/api/studio-alerts', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(alerts)
        }).catch(() => {});
    }

    // ===== RENDER =====
    function renderAlerts() {
        const container = document.getElementById('alertsView');
        const counts = { sent: 0, handled: 0, modif: 0, fixed: 0 };
        alerts.forEach(a => { if (counts[a.status] !== undefined) counts[a.status]++; });
        document.getElementById('countSent').textContent = counts.sent;
        document.getElementById('countHandled').textContent = counts.handled;
        document.getElementById('countModif').textContent = counts.modif;
        document.getElementById('countFixed').textContent = counts.fixed;
        document.getElementById('alertCount').textContent = counts.sent + counts.handled + counts.modif;

        if (alerts.length === 0) {
            container.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg><p>Aucune alerte</p></div>';
            return;
        }

        container.innerHTML = alerts.map(a => {
            const time = new Date(a.createdAt);
            const timeStr = time.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            const dateStr = time.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });

            // Emitter photo
            let emitterHtml = '<div class="alert-emitter-photo">?</div>';
            if (a.emitter && a.emitter.photo && a.emitter.photo.length > 10) {
                emitterHtml = '<div class="alert-emitter-photo"><img src="' + a.emitter.photo + '" onerror="this.parentElement.textContent=\'' + (a.emitter.name || '?').substring(0,2) + '\'"></div>';
            } else if (a.emitter) {
                const ini = a.emitter.name ? a.emitter.name.split(' ').map(n=>n[0]).join('') : '?';
                emitterHtml = '<div class="alert-emitter-photo">' + ini + '</div>';
            }

            // Pipeline
            const statusIdx = STATUSES.indexOf(a.status);
            const pipelineHtml = STATUSES.map((s, i) => {
                let cls = 'pipeline-step';
                if (i < statusIdx) cls += ' done ' + STATUS_CLASSES[s];
                else if (i === statusIdx) cls += ' ' + STATUS_CLASSES[s];
                else cls += ' inactive';
                return '<div class="' + cls + '" onclick="setStatus(\'' + a.id + '\',\'' + s + '\')">' + STATUS_LABELS[s] + '</div>';
            }).join('');

            // Description
            const descHtml = a.description ? '<div class="alert-desc">' + a.description + '</div>' : '';

            return '<div class="alert-card">' +
                '<div class="alert-top">' +
                    emitterHtml +
                    '<div class="alert-info">' +
                        '<div class="alert-title">' + a.title + '</div>' +
                        '<div class="alert-meta">' +
                            '<span>' + dateStr + ' Ã  ' + timeStr + '</span>' +
                            (a.emitter ? '<span>' + a.emitter.name + '</span>' : '') +
                        '</div>' +
                    '</div>' +
                '</div>' +
                descHtml +
                '<div class="status-pipeline">' + pipelineHtml + '</div>' +
                '<div class="alert-footer"><button class="btn-delete" onclick="deleteAlert(\'' + a.id + '\')">Supprimer</button></div>' +
            '</div>';
        }).join('');
    }

    // ===== WEEK VIEW =====
    function renderWeekView() {
        const container = document.getElementById('weekView');
        let html = '';
        html += '<div class="summary-section"><div class="summary-title">&#x1F3A8; Vignettes cette semaine</div>';
        if (weekContent.vignettes.length === 0) html += '<div class="summary-item" style="color:rgba(255,255,255,0.2);">Aucune vignette</div>';
        else weekContent.vignettes.forEach(v => { html += '<div class="summary-item"><span class="summary-icon">&#x1F5BC;</span><span class="summary-item-title">' + v.title + '</span><span class="summary-item-date">' + v.date + '</span></div>'; });
        html += '</div>';
        html += '<div class="summary-section"><div class="summary-title">&#x1F4C5; Agenda cette semaine</div>';
        if (weekContent.agenda.length === 0) html += '<div class="summary-item" style="color:rgba(255,255,255,0.2);">Aucun Ã©vÃ©nement</div>';
        else weekContent.agenda.forEach(e => { html += '<div class="summary-item"><span class="summary-icon">&#x1F4CC;</span><span class="summary-item-title">' + e.title + '</span><span class="summary-item-date">' + e.date + '</span></div>'; });
        html += '</div>';
        container.innerHTML = html;
    }

    function switchTab(tab) {
        document.getElementById('tabAlerts').classList.toggle('active', tab === 'alerts');
        document.getElementById('tabWeek').classList.toggle('active', tab === 'week');
        document.getElementById('alertsView').style.display = tab === 'alerts' ? 'block' : 'none';
        document.getElementById('weekView').style.display = tab === 'week' ? 'block' : 'none';
        if (tab === 'week') { loadWeekContent(); renderWeekView(); }
    }

    // ===== PERSISTENCE =====
    function saveAlerts() { localStorage.setItem('studioAlerts', JSON.stringify(alerts)); }
    function loadAlerts() { try { alerts = JSON.parse(localStorage.getItem('studioAlerts')) || []; } catch(e) { alerts = []; } }

    function loadWeekContent() {
        const now = new Date();
        const monday = new Date(now); monday.setDate(now.getDate() - ((now.getDay() + 6) % 7)); monday.setHours(0,0,0,0);
        const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6); sunday.setHours(23,59,59,999);
        fetch('calendar-data.json').then(r => r.json()).then(cal => {
            weekContent.agenda = (cal.events || []).filter(e => { const d = new Date(e.start || e.date); return d >= monday && d <= sunday; })
                .map(e => ({ title: e.subject || e.title || 'Sans titre', date: new Date(e.start || e.date).toLocaleDateString('fr-FR', { weekday:'short', day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' }) }));
            renderWeekView();
        }).catch(() => {});
    }

    // ===== EMITTERS (fixed list) =====
    const EMITTERS = [
        { id: 'e_vincent', firstName: 'Vincent', lastName: 'Lezenes', email: 'vincent.lezenes@cic.fr' },
        { id: 'e_manon', firstName: 'Manon', lastName: 'Lignier', email: 'manon.lignier@cic.fr' },
        { id: 'e_anissa', firstName: 'Anissa', lastName: 'Aiouaz', email: 'anissa.aiouaz@cic.fr' },
        { id: 'e_josephine', firstName: 'JosÃ©phine', lastName: 'Weber', email: 'josephine.weber@cic.fr' },
        { id: 'e_charlotte', firstName: 'Charlotte', lastName: 'Douet-Dupouet', email: 'charlotte.douetdupouet@cic.fr' },
        { id: 'e_juliette', firstName: 'Juliette', lastName: 'Cordoba Millan', email: 'juliette.cordobamillan@cic.fr' },
        { id: 'e_emeline', firstName: 'Emeline', lastName: 'Ferreira', email: 'emeline.ferreira@cic.fr' },
        { id: 'e_pauline', firstName: 'Pauline', lastName: 'Valaize', email: 'pauline.valaize@cic.fr' },
        { id: 'e_stephanie', firstName: 'StÃ©phanie', lastName: 'Stahr', email: 'stephanie.stahr@cic.fr' },
        { id: 'e_segolene', firstName: 'SÃ©golÃ¨ne', lastName: 'Bergeron', email: 'segolene.bergeron@cic.fr' },
        { id: 'e_melanie', firstName: 'MÃ©lanie', lastName: 'Gillet', email: 'melanie.gillet@cic.fr' }
    ];

    // ===== CONTACTS (for photo matching) =====
    function normalize(str) { return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim(); }
    function loadContacts() {
        fetch('contacts.json').then(r => r.json()).then(data => {
            contacts = data;
            // Match photos to emitters (souple : prÃ©nom + dÃ©but nom sans accents)
            EMITTERS.forEach(em => {
                const emFirst = normalize(em.firstName);
                const emLast = normalize(em.lastName.split(' ')[0].split('-')[0]);
                const match = contacts.find(c => {
                    if (!c.firstName || !c.lastName) return false;
                    const cFirst = normalize(c.firstName);
                    const cLast = normalize(c.lastName.split(' ')[0].split('-')[0]);
                    return cFirst === emFirst && cLast === emLast;
                });
                if (match && match.photo && match.photo.length > 10) em.photo = match.photo;
            });
            renderEmitterGrid();
        }).catch(() => { renderEmitterGrid(); });
    }

    // ===== WEBSOCKET =====
    var proxyPollTimer = null;
    function startProxyPolling() {
        if (proxyPollTimer) return;
        useProxy = true;
        document.getElementById('syncDot').classList.remove('offline');
        document.getElementById('syncText').textContent = 'Proxy';
        proxyPollTimer = setInterval(() => {
            fetch(PROXY_URL + '?action=sync').then(r => r.json()).then(data => {
                if (Array.isArray(data)) {
                    var hadSent = alerts.some(a => a.status === 'sent');
                    var newAlerts = data.filter(d => !alerts.find(a => a.id === d.id) && d.status === 'sent');
                    alerts = data; saveAlerts(); renderAlerts();
                    if (newAlerts.length > 0) startAlarm();
                    if (hadSent && !data.some(d => d.status === 'sent')) stopAlarm();
                }
            }).catch(() => {});
        }, 3000);
    }

    var wsFailCount = 0;
    function connectWS() {
        ws = new WebSocket(WS_URL);
        ws.onopen = () => { wsFailCount = 0; document.getElementById('syncDot').classList.remove('offline'); document.getElementById('syncText').textContent = 'ConnectÃ©'; };
        ws.onmessage = e => {
            try {
                const msg = JSON.parse(e.data);
                if (msg.type === 'studio-alert') {
                    if (!alerts.find(a => a.id === msg.data.id)) {
                        alerts.unshift(msg.data);
                        saveAlerts(); renderAlerts();
                        // Start alarm sauf si cette machine est l'Ã©mettrice
                        var emitTime = parseInt(localStorage.getItem('alertEmitter') || '0');
                        if (msg.data.status === 'sent' && (Date.now() - emitTime > 15000)) startAlarm();
                    }
                }
                if (msg.type === 'studio-alert-update') {
                    const a = alerts.find(x => x.id === msg.data.id);
                    if (a) { a.status = msg.data.status; saveAlerts(); renderAlerts(); }
                    // Stop alarm if no more 'sent' alerts
                    if (!alerts.some(x => x.status === 'sent')) stopAlarm();
                }
            } catch(err) {}
        };
        ws.onclose = () => {
            wsFailCount++;
            document.getElementById('syncDot').classList.add('offline');
            document.getElementById('syncText').textContent = 'DÃ©connectÃ©';
            if (wsFailCount >= 1) { startProxyPolling(); } else { setTimeout(connectWS, 3000); }
        };
        ws.onerror = () => { ws.close(); };
    }

    function loadFromServer() {
        var loaded = false;
        // Essayer Render
        fetch(API_URL + '/api/studio-alerts', { signal: AbortSignal.timeout(4000) })
            .then(r => { if (!r.ok) throw new Error('fail'); return r.json(); })
            .then(data => {
                if (!loaded && Array.isArray(data) && data.length > 0) { loaded = true; alerts = data; saveAlerts(); renderAlerts(); }
            }).catch(() => {});
        // Essayer Proxy en parallÃ¨le (pour PC EI)
        fetch(PROXY_URL + '?action=sync')
            .then(r => r.json())
            .then(data => {
                if (!loaded && Array.isArray(data) && data.length > 0) { loaded = true; useProxy = true; alerts = data; saveAlerts(); renderAlerts(); }
            }).catch(() => {});
    }

    // ===== INIT =====
    loadAlerts(); renderAlerts(); renderWeekView(); connectWS(); loadFromServer(); loadContacts();
    // Check if there are unacknowledged alerts
    setTimeout(() => { if (alerts.some(a => a.status === 'sent')) startAlarm(); }, 1000);
    </script>
<div id="versionBadge" style="position:fixed;bottom:6px;left:8px;z-index:9998;font-family:-apple-system,sans-serif;font-size:9px;color:rgba(255,255,255,0.45);pointer-events:none;background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:4px;">v35</div>
</body>
</html>
