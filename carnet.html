<!-- deploy: 2026-02-16 17:15:00 -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carnet d'adresses — Studio Manager</title>
    
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Helvetica Neue', Helvetica, Arial, sans-serif !important; }
        html, body, div, span, p, a, h1, h2, h3, h4, h5, h6, input, select, textarea, button, option, label, table, tr, td, th { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Helvetica Neue', Helvetica, Arial, sans-serif !important; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
            background: #0a0c14; color: #fff; min-height: 100vh;
        }
        .album-bg { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; overflow: hidden; }
        .album-bg .cover {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            filter: blur(60px) saturate(2.5) brightness(0.7);
            transition: opacity 2s ease-in-out; opacity: 0; transform: scale(1.4);
        }
        .album-bg .cover.active { opacity: 1; }
        .album-bg::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.1); z-index: 1; }

        .page-wrap { position: relative; z-index: 2; min-height: 100vh; }

        .header {
            padding: 20px 32px; display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .header h1 { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
        .header h1 span { color: rgba(255,255,255,0.3); font-weight: 400; margin-left: 8px; font-size: 18px; }
        .back-btn {
            color: rgba(255,255,255,0.4); text-decoration: none; font-size: 13px; font-weight: 600;
            display: flex; align-items: center; gap: 6px; transition: color 0.2s;
        }
        .back-btn:hover { color: #fff; }

        .toolbar {
            padding: 16px 32px; display: flex; gap: 12px; align-items: center;
        }
        .search-box {
            flex: 1; max-width: 400px; position: relative;
        }
        .search-box input {
            width: 100%; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; padding: 10px 14px 10px 38px; color: #fff; font-family: inherit;
            font-size: 14px; outline: none; font-weight: 500;
        }
        .search-box input:focus { border-color: rgba(0,140,255,0.5); background: rgba(255,255,255,0.08); }
        .search-box input::placeholder { color: rgba(255,255,255,0.25); }
        .search-box svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.3; }

        .filter-btns { display: flex; gap: 6px; }
        .filter-btn {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px; padding: 8px 16px; color: rgba(255,255,255,0.5);
            font-family: inherit; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .filter-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .filter-btn.active { background: rgba(0,140,255,0.15); border-color: rgba(0,140,255,0.4); color: #4da8ff; }

        .btn-add {
            background: linear-gradient(135deg, #0070f3, #0050c8); border: none; border-radius: 12px;
            padding: 10px 20px; color: #fff; font-family: inherit; font-size: 13px; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;
            box-shadow: 0 4px 16px rgba(0,112,243,0.3); margin-left: auto;
        }
        .btn-add:hover { transform: translateY(-2px); box-shadow: 0 6px 24px rgba(0,112,243,0.4); }

        .contacts-grid {
            padding: 16px 32px; display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 14px;
        }

        .contact-card {
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.2s;
            position: relative; overflow: hidden;
        }
        .contact-card:hover { background: rgba(255,255,255,0.08); transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
        .contact-card .card-top { display: flex; align-items: center; gap: 14px; margin-bottom: 12px; }
        .contact-card .avatar {
            width: 48px; height: 48px; border-radius: 14px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: 800; color: #fff; flex-shrink: 0;
            overflow: hidden;
        }
        .contact-card .avatar img { width: 100%; height: 100%; object-fit: cover; object-position: 25% 15%; }
        .contact-card .card-name { font-size: 16px; font-weight: 700; }
        .contact-card .card-function { font-size: 12px; color: rgba(255,255,255,0.45); margin-top: 2px; font-weight: 500; }
        .contact-card .card-tags { display: flex; flex-wrap: wrap; gap: 4px; }
        .contact-card .tag {
            font-size: 10px; font-weight: 700; padding: 3px 10px; border-radius: 8px;
            letter-spacing: 0.3px;
        }
        .tag-actions { background: rgba(99,102,241,0.15); color: #818cf8; }
        .tag-eco { background: rgba(16,185,129,0.15); color: #34d399; }
        .tag-esg { background: rgba(245,158,11,0.15); color: #fbbf24; }
        .tag-technique { background: rgba(239,68,68,0.15); color: #f87171; }
        .tag-credit { background: rgba(59,130,246,0.15); color: #60a5fa; }
        .contact-card .card-company { font-size: 11px; color: rgba(255,255,255,0.3); margin-top: 8px; font-weight: 500; }

        .contact-card .card-actions {
            position: absolute; top: 12px; right: 12px; display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s;
        }
        .contact-card:hover .card-actions { opacity: 1; }
        .card-action-btn {
            width: 28px; height: 28px; border-radius: 8px; border: none;
            background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 12px; transition: all 0.2s;
        }
        .card-action-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }
        .card-action-btn.delete:hover { background: rgba(239,68,68,0.3); color: #f87171; }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 500; backdrop-filter: blur(8px);
            align-items: center; justify-content: center;
        }
        .modal-overlay.visible { display: flex; }
        .modal {
            background: rgba(18,20,38,0.95); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px; padding: 28px 32px; width: 420px; max-width: 90vw;
            backdrop-filter: blur(40px); box-shadow: 0 24px 64px rgba(0,0,0,0.7);
        }
        .modal h3 { font-size: 20px; font-weight: 800; margin-bottom: 20px; }
        .modal .field { margin-bottom: 12px; }
        .modal .field label { display: block; font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.4); margin-bottom: 4px; letter-spacing: 0.5px; text-transform: uppercase; }
        .modal .field input, .modal .field select { font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif !important;
            width: 100%; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px; padding: 10px 14px; color: #fff; font-family: inherit;
            font-size: 14px; outline: none; font-weight: 500;
        }
        .modal .field input:focus, .modal .field select:focus { border-color: rgba(0,140,255,0.5); }
        .modal .field input::placeholder { color: rgba(255,255,255,0.2); }
        .modal .field select option { background: #1a1c28; font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif !important; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btns button {
            flex: 1; padding: 11px 16px; border-radius: 12px; border: none;
            font-family: inherit; font-size: 13px; font-weight: 700; cursor: pointer;
        }
        .modal-btn-cancel { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.6); }
        .modal-btn-save { background: linear-gradient(135deg, #0070f3, #0050c8); color: #fff; }
        .modal-btn-delete { background: rgba(220,38,38,0.8); color: #fff; }

        .count-label { font-size: 12px; color: rgba(255,255,255,0.3); padding: 0 32px 8px; font-weight: 500; }
    </style>
</head>
<body>
    <div class="album-bg" id="albumBg"></div>
    <div class="page-wrap">
        <div class="header">
            <h1>Carnet d'adresses <span>Intervenants Studio</span></h1>
            <a href="studio-manager.html" class="back-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Studio Manager
            </a>
        </div>
        <div class="toolbar">
            <div class="search-box">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" id="searchInput" placeholder="Rechercher un analyste..." oninput="renderContacts()">
            </div>
            <div class="filter-btns">
                <button class="filter-btn active" data-filter="all" onclick="setFilter(this)">Tous</button>
                <button class="filter-btn" data-filter="actions" onclick="setFilter(this)">Actions</button>
                <button class="filter-btn" data-filter="eco" onclick="setFilter(this)">Éco</button>
                <button class="filter-btn" data-filter="esg" onclick="setFilter(this)">ESG</button>
                <button class="filter-btn" data-filter="technique" onclick="setFilter(this)">Technique</button>
                <button class="filter-btn" data-filter="credit" onclick="setFilter(this)">Crédit</button>
            </div>
            <button class="btn-add" onclick="openModal()">+ Ajouter</button>
        </div>
        <div class="count-label" id="countLabel"></div>
        <div class="contacts-grid" id="contactsGrid"></div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <h3 id="modalTitle">Ajouter un contact</h3>
            <div class="field"><label>Prénom</label><input type="text" id="mFirstName" placeholder="Ex: Éric"></div>
            <div class="field"><label>Nom</label><input type="text" id="mLastName" placeholder="Ex: Lemarié"></div>
            <div class="field"><label>Spécialité</label>
                <select id="mSpeciality">
                    <option value="actions">Recherche Actions</option>
                    <option value="eco">Économie & Marchés Financiers</option>
                    <option value="esg">Recherche Développement Durable</option>
                    <option value="technique">Analyse Technique</option>
                    <option value="credit">Crédit</option>
                </select>
            </div>
            <div class="field"><label>Fonction</label><input type="text" id="mFunction" placeholder="Ex: Analyste Biens d'équipement"></div>
            <div class="field"><label>Société</label><input type="text" id="mCompany" placeholder="Ex: CIC Corporate & Institutional Banking" value="CIC Corporate & Institutional Banking"></div>
            <div class="field"><label>Email</label><input type="email" id="mEmail" placeholder="Ex: eric.lemarie@cic.fr"></div>
            <div class="modal-btns" id="modalBtns">
                <button class="modal-btn-cancel" onclick="closeModal()">Annuler</button>
                <button class="modal-btn-save" onclick="saveContact()">Enregistrer</button>
            </div>
        </div>
    </div>

    <script>
    // === DATA ===
    var GH_TOKEN_PARTS = ['s6Q6VG_phg','71QRNKGR8m','EiaK9FWAqE','cWTym0zJLw'];
    var GH_TOKEN = GH_TOKEN_PARTS.map(function(s){return s.split('').reverse().join('')}).join('');
    var GH_REPO = 'lezenesvincent-dotcom/mon-content-manager';
    var GH_CONTACTS_FILE = 'contacts.json';
    var GH_CONTACTS_API = 'https://api.github.com/repos/' + GH_REPO + '/contents/' + GH_CONTACTS_FILE;

    var contacts = [];
    var contactsSha = null;
    var currentFilter = 'all';
    var editingId = null;

    var SPEC_LABELS = {
        actions: 'RECHERCHE ACTIONS',
        eco: 'ÉCONOMIE & MARCHÉS FINANCIERS',
        esg: 'RECHERCHE DÉVELOPPEMENT DURABLE',
        technique: 'ANALYSE TECHNIQUE', credit: 'CRÉDIT'
    };
    var SPEC_TAGS = {
        actions: 'tag-actions',
        eco: 'tag-eco',
        esg: 'tag-esg',
        technique: 'tag-technique', credit: 'tag-credit'
    };

    // Default analysts
    var DEFAULT_CONTACTS = [
        { id: 'c01', firstName: 'Christian', lastName: 'Devismes', speciality: 'actions', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/christian-devismes.png' },
        { id: 'c02', firstName: 'Hervé', lastName: 'Drouet', speciality: 'actions', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/herve-drouet.png' },
        { id: 'c03', firstName: 'Eric', lastName: 'Ravary', speciality: 'actions', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/eric-ravary.png' },
        { id: 'c04', firstName: 'Emmanuel', lastName: 'Chevalier', speciality: 'actions', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/emmanuel-chevalier.png' },
        { id: 'c05', firstName: 'Ebrahim', lastName: 'Homani', speciality: 'actions', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/ebrahim-homani.png' },
        { id: 'c06', firstName: 'Éric', lastName: 'Lemarié', speciality: 'actions', function: 'Analyste Biens d\'équipement', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/eric-lemarie.png' },
        { id: 'c07', firstName: 'Arnaud', lastName: 'Palliez', speciality: 'eco', function: 'Économiste', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/arnaud-palliez.png' },
        { id: 'c08', firstName: 'Jean-Luc', lastName: 'Romain', speciality: 'actions', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/jean-luc-romain.png' },
        { id: 'c09', firstName: 'Alexandre', lastName: 'Plaud', speciality: 'technique', function: 'Analyste Technique', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/alexandre-plaud.png' },
        { id: 'c10', firstName: 'Virginie', lastName: 'Royère', speciality: 'actions', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/virginie-royere.png' },
        { id: 'c11', firstName: 'Arnaud', lastName: 'Cadart', speciality: 'esg', function: 'Analyste ESG', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/arnaud-cadart.png' },
        { id: 'c12', firstName: 'David', lastName: 'Da Maia', speciality: 'actions', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/david-da-maia.png' },
        { id: 'c13', firstName: 'Pierre', lastName: 'Chédeville', speciality: 'actions', function: 'Analyste Construction & Matériaux', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/pierre-chedeville.png' },
        { id: 'c14', firstName: 'Dominique', lastName: 'Descours', speciality: 'actions', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/dominique-descours.png' },
        { id: 'c15', firstName: 'Alexandre', lastName: 'Gérard', speciality: 'technique', function: 'Analyste Technique', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/alexandre-gerard.png' },
        { id: 'c16', firstName: 'Adrien', lastName: 'Régnier-Laurent', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/adrien-regnier-laurent.png' },
        { id: 'c17', firstName: 'Anne-Lise', lastName: 'Cornen', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/anne-lise-cornen.png' },
        { id: 'c18', firstName: 'Benoît', lastName: 'Rodriguez', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/benoit-rodriguez.png' },
        { id: 'c19', firstName: 'Emmanuelle', lastName: 'Thollon-Pommerol', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/emmanuelle-thollon-pommerol.png' },
        { id: 'c20', firstName: 'Eric', lastName: 'Baron', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/eric-baron.png' },
        { id: 'c21', firstName: 'Eva', lastName: 'Bellin', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/eva-bellin.png' },
        { id: 'c22', firstName: 'Eva', lastName: 'Zarbo', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/eva-zarbo.png' },
        { id: 'c23', firstName: 'Fabrissa', lastName: 'Tassin', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/fabrissa-tassin.png' },
        { id: 'c24', firstName: 'François', lastName: 'Duhen', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/francois-duhen.png' },
        { id: 'c25', firstName: 'Françoise', lastName: 'Étienne', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/francoise-etienne.png' },
        { id: 'c26', firstName: 'Gabriel', lastName: 'Corbassière', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/gabriel-corbassiere.png' },
        { id: 'c27', firstName: 'Marc', lastName: 'Gontran', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/marc-gontran.png' },
        { id: 'c28', firstName: 'Martin', lastName: 'Gicquiau', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/martin-gicquiau.png' },
        { id: 'c29', firstName: 'Nicolas', lastName: 'Bouthors', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/nicolas-bouthors.png' },
        { id: 'c30', firstName: 'Nicolas', lastName: 'Haese', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/nicolas-haese.png' },
        { id: 'c31', firstName: 'Stéphane', lastName: 'Leandri', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/stephane-leandri.png' },
        { id: 'c32', firstName: 'William', lastName: 'Honvo', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/william-honvo.png' },
    ];

    // === LOAD / SAVE ===
    async function loadContacts() {
        try {
            var resp = await fetch(GH_CONTACTS_API, { headers: { 'Authorization': 'token '+GH_TOKEN, 'Accept': 'application/vnd.github.v3+json' }, cache: 'no-store' });
            if (resp.ok) {
                var data = await resp.json();
                contactsSha = data.sha;
                contacts = JSON.parse(decodeURIComponent(escape(atob(data.content))));
            } else {
                contacts = DEFAULT_CONTACTS;
                await saveToGitHub();
            }
        } catch(e) {
            console.error('Load error:', e);
            contacts = DEFAULT_CONTACTS;
        }
        renderContacts();
    }

    async function saveToGitHub() {
        try {
            var body = { message: 'contacts update', content: btoa(unescape(encodeURIComponent(JSON.stringify(contacts, null, 2)))), branch: 'main' };
            if (contactsSha) body.sha = contactsSha;
            var resp = await fetch(GH_CONTACTS_API, {
                method: 'PUT',
                headers: { 'Authorization': 'token '+GH_TOKEN, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (resp.ok) {
                var data = await resp.json();
                contactsSha = data.content.sha;
            }
        } catch(e) { console.error('Save error:', e); }
    }

    // === RENDER ===
    function renderContacts() {
        var search = document.getElementById('searchInput').value.toLowerCase();
        var filtered = contacts.filter(function(c) {
            if (currentFilter !== 'all' && c.speciality !== currentFilter) return false;
            if (search) {
                var full = (c.firstName + ' ' + c.lastName + ' ' + c.function + ' ' + c.company).toLowerCase();
                return full.indexOf(search) > -1;
            }
            return true;
        });

        // Tri par prénom
        filtered.sort(function(a, b) {
            return a.firstName.localeCompare(b.firstName, 'fr');
        });

        document.getElementById('countLabel').textContent = filtered.length + ' contact' + (filtered.length > 1 ? 's' : '');
        var grid = document.getElementById('contactsGrid');
        grid.innerHTML = '';

        filtered.forEach(function(c) {
            var initials = (c.firstName[0] || '') + (c.lastName[0] || '');
            var specLabel = SPEC_LABELS[c.speciality] || c.speciality;
            var tagClass = SPEC_TAGS[c.speciality] || 'tag-actions';

            var avatarContent = c.photo ? '<img src="'+c.photo+'" alt="" onerror="this.style.display=\'none\';this.parentNode.textContent=\''+initials.toUpperCase()+'\';">' : initials.toUpperCase();
            var div = document.createElement('div');
            div.className = 'contact-card';
            div.onclick = function() { openModal(c.id); };
            div.innerHTML =
                '<div class="card-actions">' +
                    '<button class="card-action-btn delete" onclick="event.stopPropagation();deleteContact(\''+c.id+'\')">✕</button>' +
                '</div>' +
                '<div class="card-top">' +
                    '<div class="avatar">' + avatarContent + '</div>' +
                    '<div><div class="card-name">' + c.firstName + ' ' + c.lastName + '</div>' +
                    '<div class="card-function">' + (c.function || '') + '</div></div>' +
                '</div>' +
                '<div class="card-tags"><span class="tag ' + tagClass + '">' + specLabel + '</span></div>' +
                '<div class="card-company">' + (c.company || '') + '</div>';
            grid.appendChild(div);
        });
    }

    function setFilter(btn) {
        document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderContacts();
    }

    // === MODAL ===
    function openModal(id) {
        editingId = id || null;
        if (id) {
            var c = contacts.find(function(x) { return x.id === id; });
            if (!c) return;
            document.getElementById('modalTitle').textContent = 'Modifier';
            document.getElementById('mFirstName').value = c.firstName;
            document.getElementById('mLastName').value = c.lastName;
            document.getElementById('mSpeciality').value = c.speciality;
            document.getElementById('mFunction').value = c.function || '';
            document.getElementById('mCompany').value = c.company || '';
            document.getElementById('mEmail').value = c.email || '';
            document.getElementById('modalBtns').innerHTML =
                '<button class="modal-btn-delete" onclick="deleteContact(\''+id+'\');closeModal()">Supprimer</button>' +
                '<div style="flex:1"></div>' +
                '<button class="modal-btn-cancel" onclick="closeModal()">Annuler</button>' +
                '<button class="modal-btn-save" onclick="saveContact()">Modifier</button>';
        } else {
            document.getElementById('modalTitle').textContent = 'Ajouter un contact';
            document.getElementById('mFirstName').value = '';
            document.getElementById('mLastName').value = '';
            document.getElementById('mSpeciality').value = 'actions';
            document.getElementById('mFunction').value = '';
            document.getElementById('mCompany').value = 'CIC Corporate & Institutional Banking';
            document.getElementById('mEmail').value = '';
            document.getElementById('modalBtns').innerHTML =
                '<button class="modal-btn-cancel" onclick="closeModal()">Annuler</button>' +
                '<button class="modal-btn-save" onclick="saveContact()">Enregistrer</button>';
        }
        document.getElementById('modalOverlay').classList.add('visible');
        setTimeout(function() { document.getElementById('mFirstName').focus(); }, 50);
    }

    function closeModal() {
        document.getElementById('modalOverlay').classList.remove('visible');
        editingId = null;
    }

    function saveContact() {
        var firstName = document.getElementById('mFirstName').value.trim();
        var lastName = document.getElementById('mLastName').value.trim();
        if (!firstName || !lastName) return;

        var data = {
            firstName: firstName,
            lastName: lastName,
            speciality: document.getElementById('mSpeciality').value,
            function: document.getElementById('mFunction').value.trim(),
            company: document.getElementById('mCompany').value.trim(),
            email: document.getElementById('mEmail').value.trim()
        };

        if (editingId) {
            var idx = contacts.findIndex(function(c) { return c.id === editingId; });
            if (idx > -1) {
                data.id = editingId;
                data.photo = contacts[idx].photo || '';
                contacts[idx] = data;
            }
        } else {
            data.id = 'c_' + Date.now();
            contacts.push(data);
        }

        saveToGitHub();
        renderContacts();
        closeModal();
    }

    function deleteContact(id) {
        if (!confirm('Supprimer ce contact ?')) return;
        contacts = contacts.filter(function(c) { return c.id !== id; });
        saveToGitHub();
        renderContacts();
    }

    // === KEYBOARD ===
    document.addEventListener('keydown', function(e) {
        if (!document.getElementById('modalOverlay').classList.contains('visible')) return;
        if (e.key === 'Enter') saveContact();
        if (e.key === 'Escape') closeModal();
    });

    // === ALBUM BG ===
    var ALBUMS=['https://i.scdn.co/image/ab67616d0000b273b1c4b76e23414c9f20f43b14','https://i.scdn.co/image/ab67616d0000b2738b52c6b9bc4e43d873869699','https://i.scdn.co/image/ab67616d0000b273e2e352d89826aef6dbd5ff8f','https://i.scdn.co/image/ab67616d0000b2739e1cfc756886ac782e363d79','https://i.scdn.co/image/ab67616d0000b27368384dd85fd5e95831252f60','https://i.scdn.co/image/ab67616d0000b273879e9318cb9f4e05ee552ac9','https://i.scdn.co/image/ab67616d0000b273b46f74097655d7f353caab14','https://i.scdn.co/image/ab67616d0000b2730b51f8d91f3a21e8426361ae','https://i.scdn.co/image/ab67616d0000b2734718e2b124f79258be7571c1','https://i.scdn.co/image/ab67616d0000b27395f754318336a07e85ec59bc','https://i.scdn.co/image/ab67616d0000b273d9985092cd88bffd97653b58','https://i.scdn.co/image/ab67616d0000b2738940ac99f49e44f59e6f7fb3','https://i.scdn.co/image/ab67616d0000b273ba5db46f4b838ef6027e6f96','https://i.scdn.co/image/ab67616d0000b2734637341b9f507521afa9a778','https://i.scdn.co/image/ab67616d0000b273e787cffec20aa2a396a61647'];
    var idx=0,bg=document.getElementById('albumBg'),l1=document.createElement('div'),l2=document.createElement('div');
    l1.className='cover active';l2.className='cover';bg.appendChild(l1);bg.appendChild(l2);
    for(var i=ALBUMS.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=ALBUMS[i];ALBUMS[i]=ALBUMS[j];ALBUMS[j]=t;}
    l1.style.backgroundImage='url('+ALBUMS[0]+')';
    setInterval(function(){idx=(idx+1)%ALBUMS.length;var a=l1.classList.contains('active')?l1:l2,b=(a===l1)?l2:l1;b.style.backgroundImage='url('+ALBUMS[idx]+')';b.classList.add('active');a.classList.remove('active');},30000);

    // === INIT ===
    loadContacts();
    </script>


<script>
(function(){
    var ALERT_WS_URL = 'wss://ecamm-overlay-server.onrender.com';
    var alertWs = null;
    var alertAudioCtx = null;
    var alertNodes = [];
    var alertActive = false;
    var alertBanner = null;

    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();

    function createAlertBanner() {
        if (alertBanner) return;
        alertBanner = document.createElement('div');
        alertBanner.id = 'studioAlertBanner';
        alertBanner.style.cssText = 'position:fixed;inset:0;z-index:99999;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(255,0,0,0.85);animation:alertFlash 0.5s infinite;cursor:pointer;';
        alertBanner.innerHTML = '<div style="font-size:72px;margin-bottom:20px;">&#x1F6A8;</div>' +
            '<div style="font-size:28px;font-weight:800;color:#fff;margin-bottom:12px;">ALERTE STUDIO</div>' +
            '<div style="font-size:16px;color:rgba(255,255,255,0.8);margin-bottom:10px;" id="alertBannerMsg"></div>' +
            '<div style="font-size:14px;color:rgba(255,255,255,0.6);margin-bottom:30px;" id="alertBannerSound">&#x1F50A; Cliquez n\'importe o\u00f9 pour activer le son</div>' +
            '<button onclick="window._ackStudioAlert()" style="padding:18px 50px;font-size:18px;font-weight:800;background:#fff;color:#ff0000;border:none;border-radius:14px;cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,0.3);text-transform:uppercase;">&#x2705; PRISE EN CHARGE</button>';
        alertBanner.addEventListener('click', function(e) {
            if (e.target.tagName !== 'BUTTON') forceAlertSound();
        });
        document.body.appendChild(alertBanner);
        var style = document.createElement('style');
        style.textContent = '@keyframes alertFlash{0%,100%{background:rgba(255,0,0,0.85);}50%{background:rgba(180,0,0,0.95);}}';
        document.head.appendChild(style);
    }

    function showBanner(title, msg) {
        createAlertBanner();
        document.getElementById('alertBannerMsg').textContent = (title || 'Nouvelle alerte') + (msg ? ' \u2014 ' + msg : '');
        alertBanner.style.display = 'flex';
        forceAlertSound();
        sendNotif(title, msg);
    }

    function hideBanner() { if (alertBanner) alertBanner.style.display = 'none'; }

    function forceAlertSound() {
        if (!alertAudioCtx) alertAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (alertAudioCtx.state === 'suspended') {
            alertAudioCtx.resume().then(function() {
                if (!alertActive) startOsc();
                var el = document.getElementById('alertBannerSound'); if (el) el.style.display = 'none';
            });
        } else {
            if (!alertActive) startOsc();
            var el = document.getElementById('alertBannerSound'); if (el) el.style.display = 'none';
        }
    }

    function startOsc() {
        alertActive = true;
        var sncfNotes = [
            { freq: 587.33, dur: 0.35 },
            { freq: 880.00, dur: 0.35 },
            { freq: 739.99, dur: 0.35 },
            { freq: 293.66, dur: 0.7 }
        ];
        var chimeDur = 0; sncfNotes.forEach(function(n){ chimeDur += n.dur; });

        function playChime() {
            if (!alertActive) return;
            var t = alertAudioCtx.currentTime;
            sncfNotes.forEach(function(note) {
                var o = alertAudioCtx.createOscillator(), g = alertAudioCtx.createGain();
                o.connect(g); g.connect(alertAudioCtx.destination);
                o.type = 'sine'; o.frequency.value = note.freq;
                g.gain.setValueAtTime(0.6, t);
                g.gain.exponentialRampToValueAtTime(0.001, t + note.dur - 0.02);
                o.start(t); o.stop(t + note.dur);
                alertNodes.push({osc:o, gain:g});
                t += note.dur;
            });
            setTimeout(function(){ if (!alertActive) return; speakAlert(); }, chimeDur * 1000 + 200);
        }

        function speakAlert() {
            if (!('speechSynthesis' in window)) { scheduleNext(); return; }
            var stored = [];
            try { stored = JSON.parse(localStorage.getItem('studioAlerts') || '[]'); } catch(e){}
            var lastNew = null;
            for (var i=0;i<stored.length;i++) { if (stored[i].status === 'sent') { lastNew = stored[i]; break; } }
            var text = 'Alerte studio';
            if (lastNew) {
                var prenom = lastNew.emitter ? lastNew.emitter.name.split(' ')[0] : '';
                var desc = lastNew.title || lastNew.description || '';
                if (prenom && desc) text = prenom + ' signale : ' + desc;
                else if (prenom) text = 'Alerte de ' + prenom;
                else if (desc) text = desc;
            }
            window.speechSynthesis.cancel();
            var utt = new SpeechSynthesisUtterance(text);
            utt.lang = 'fr-FR'; utt.rate = 0.95; utt.pitch = 1.0; utt.volume = 1.0;
            var voices = window.speechSynthesis.getVoices();
            for (var v=0;v<voices.length;v++) { if (voices[v].lang.indexOf('fr')===0) { utt.voice = voices[v]; break; } }
            utt.onend = function(){ setTimeout(function(){ if (alertActive) playChime(); }, 1500); };
            utt.onerror = function(){ scheduleNext(); };
            window.speechSynthesis.speak(utt);
        }

        function scheduleNext() { setTimeout(function(){ if (alertActive) playChime(); }, 3000); }

        if ('speechSynthesis' in window) window.speechSynthesis.getVoices();
        playChime();
    }

    function stopSound() {
        alertActive = false;
        alertNodes.forEach(function(n){ try{n.osc.stop();}catch(e){} });
        alertNodes = [];
        hideBanner();
    }

    function sendNotif(title, msg) {
        if (!('Notification' in window) || Notification.permission !== 'granted') return;
        try {
            var n = new Notification('\uD83D\uDEA8 ALERTE STUDIO', {
                body: (title || 'Alerte') + (msg ? ' \u2014 ' + msg : ''),
                requireInteraction: true, tag: 'studio-alert'
            });
            n.onclick = function() { window.focus(); n.close(); };
        } catch(e) {}
    }

    window._ackStudioAlert = function() {
        stopSound();
        if (alertWs && alertWs.readyState === WebSocket.OPEN) {
            var stored = [];
            try { stored = JSON.parse(localStorage.getItem('studioAlerts') || '[]'); } catch(e){}
            stored.forEach(function(a) {
                if (a.status === 'sent') {
                    a.status = 'handled'; a.handledAt = new Date().toISOString();
                    alertWs.send(JSON.stringify({type:'studio-alert-update', data:{id:a.id, status:'handled'}}));
                }
            });
            localStorage.setItem('studioAlerts', JSON.stringify(stored));
        }
    };

    function connectAlertWS() {
        alertWs = new WebSocket(ALERT_WS_URL);
        alertWs.onmessage = function(e) {
            try {
                var msg = JSON.parse(e.data);
                if (msg.type === 'studio-alert' && msg.data && msg.data.status === 'sent') {
                    var stored = [];
                    try { stored = JSON.parse(localStorage.getItem('studioAlerts') || '[]'); } catch(ex){}
                    if (!stored.find(function(a){return a.id === msg.data.id;})) {
                        stored.unshift(msg.data); localStorage.setItem('studioAlerts', JSON.stringify(stored));
                    }
                    showBanner(msg.data.title, msg.data.emitter ? msg.data.emitter.name : '');
                }
                if (msg.type === 'studio-alert-update' && msg.data && msg.data.status !== 'sent') { stopSound(); }
            } catch(err) {}
        };
        alertWs.onclose = function(){ setTimeout(connectAlertWS, 3000); };
        alertWs.onerror = function(){ alertWs.close(); };
    }

    // Check on load
    try {
        var existing = JSON.parse(localStorage.getItem('studioAlerts') || '[]');
        if (existing.some(function(a){return a.status === 'sent';})) {
            var last = existing.find(function(a){return a.status === 'sent';});
            setTimeout(function(){ showBanner(last.title, last.emitter ? last.emitter.name : ''); }, 500);
        }
    } catch(e){}

    connectAlertWS();
})();
</script>

<div id="versionBadge" style="position:fixed;bottom:6px;left:8px;z-index:9998;font-family:-apple-system,sans-serif;font-size:9px;color:rgba(255,255,255,0.2);pointer-events:none;">v8-sncf</div>
</body>
</html>
