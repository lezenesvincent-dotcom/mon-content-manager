<!-- deploy: 2026-02-16 17:15:00 -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carnet d'adresses ‚Äî Studio Manager</title>
    
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Helvetica Neue', Helvetica, Arial, sans-serif !important; }
        html, body, div, span, p, a, h1, h2, h3, h4, h5, h6, input, select, textarea, button, option, label, table, tr, td, th { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Helvetica Neue', Helvetica, Arial, sans-serif !important; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
            background: #0a0c14; color: #fff; min-height: 100vh;
        }
        .album-bg { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; overflow: hidden; }
        .album-bg .cover {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            filter: blur(60px) saturate(2.5) brightness(0.7);
            transition: opacity 2s ease-in-out; opacity: 0; transform: scale(1.4);
        }
        .album-bg .cover.active { opacity: 1; }
        .album-bg::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.1); z-index: 1; }

        .page-wrap { position: relative; z-index: 2; min-height: 100vh; }

        .header {
            padding: 20px 32px; display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .header h1 { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
        .header h1 span { color: rgba(255,255,255,0.3); font-weight: 400; margin-left: 8px; font-size: 18px; }
        .back-btn {
            color: rgba(255,255,255,0.4); text-decoration: none; font-size: 13px; font-weight: 600;
            display: flex; align-items: center; gap: 6px; transition: color 0.2s;
        }
        .back-btn:hover { color: #fff; }

        .toolbar {
            padding: 16px 32px; display: flex; gap: 12px; align-items: center;
        }
        .search-box {
            flex: 1; max-width: 400px; position: relative;
        }
        .search-box input {
            width: 100%; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; padding: 10px 14px 10px 38px; color: #fff; font-family: inherit;
            font-size: 14px; outline: none; font-weight: 500;
        }
        .search-box input:focus { border-color: rgba(0,140,255,0.5); background: rgba(255,255,255,0.08); }
        .search-box input::placeholder { color: rgba(255,255,255,0.25); }
        .search-box svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.3; }

        .filter-btns { display: flex; gap: 6px; }
        .filter-btn {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px; padding: 8px 16px; color: rgba(255,255,255,0.5);
            font-family: inherit; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .filter-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .filter-btn.active { background: rgba(0,140,255,0.15); border-color: rgba(0,140,255,0.4); color: #4da8ff; }

        .btn-add {
            background: linear-gradient(135deg, #0070f3, #0050c8); border: none; border-radius: 12px;
            padding: 10px 20px; color: #fff; font-family: inherit; font-size: 13px; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;
            box-shadow: 0 4px 16px rgba(0,112,243,0.3); margin-left: auto;
        }
        .btn-add:hover { transform: translateY(-2px); box-shadow: 0 6px 24px rgba(0,112,243,0.4); }

        .contacts-grid {
            padding: 16px 32px; display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 14px;
        }

        .contact-card {
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.2s;
            position: relative; overflow: hidden;
        }
        .contact-card:hover { background: rgba(255,255,255,0.08); transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
        .contact-card .card-top { display: flex; align-items: center; gap: 14px; margin-bottom: 12px; }
        .contact-card .avatar {
            width: 48px; height: 48px; border-radius: 14px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: 800; color: #fff; flex-shrink: 0;
            overflow: hidden;
        }
        .contact-card .avatar img { width: 100%; height: 100%; object-fit: cover; object-position: 25% 15%; }
        .contact-card .card-name { font-size: 16px; font-weight: 700; }
        .contact-card .card-function { font-size: 12px; color: rgba(255,255,255,0.45); margin-top: 2px; font-weight: 500; }
        .contact-card .card-tags { display: flex; flex-wrap: wrap; gap: 4px; }
        .contact-card .tag {
            font-size: 10px; font-weight: 700; padding: 3px 10px; border-radius: 8px;
            letter-spacing: 0.3px;
        }
        .tag-actions { background: rgba(99,102,241,0.15); color: #818cf8; }
        .tag-eco { background: rgba(16,185,129,0.15); color: #34d399; }
        .tag-esg { background: rgba(245,158,11,0.15); color: #fbbf24; }
        .tag-technique { background: rgba(239,68,68,0.15); color: #f87171; }
        .tag-credit { background: rgba(59,130,246,0.15); color: #60a5fa; }
        .contact-card .card-company { font-size: 11px; color: rgba(255,255,255,0.3); margin-top: 8px; font-weight: 500; }

        .contact-card .card-actions {
            position: absolute; top: 12px; right: 12px; display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s;
        }
        .contact-card:hover .card-actions { opacity: 1; }
        .card-action-btn {
            width: 28px; height: 28px; border-radius: 8px; border: none;
            background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 12px; transition: all 0.2s;
        }
        .card-action-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }
        .card-action-btn.delete:hover { background: rgba(239,68,68,0.3); color: #f87171; }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 500; backdrop-filter: blur(8px);
            align-items: center; justify-content: center;
        }
        .modal-overlay.visible { display: flex; }
        .modal {
            background: rgba(18,20,38,0.95); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px; padding: 28px 32px; width: 420px; max-width: 90vw;
            backdrop-filter: blur(40px); box-shadow: 0 24px 64px rgba(0,0,0,0.7);
        }
        .modal h3 { font-size: 20px; font-weight: 800; margin-bottom: 20px; }
        .modal .field { margin-bottom: 12px; }
        .modal .field label { display: block; font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.4); margin-bottom: 4px; letter-spacing: 0.5px; text-transform: uppercase; }
        .modal .field input, .modal .field select { font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif !important;
            width: 100%; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px; padding: 10px 14px; color: #fff; font-family: inherit;
            font-size: 14px; outline: none; font-weight: 500;
        }
        .modal .field input:focus, .modal .field select:focus { border-color: rgba(0,140,255,0.5); }
        .modal .field input::placeholder { color: rgba(255,255,255,0.2); }
        .modal .field select option { background: #1a1c28; font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif !important; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btns button {
            flex: 1; padding: 11px 16px; border-radius: 12px; border: none;
            font-family: inherit; font-size: 13px; font-weight: 700; cursor: pointer;
        }
        .modal-btn-cancel { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.6); }
        .modal-btn-save { background: linear-gradient(135deg, #0070f3, #0050c8); color: #fff; }
        .modal-btn-delete { background: rgba(220,38,38,0.8); color: #fff; }

        .photo-upload { display: flex; align-items: center; gap: 12px; }
        .photo-preview {
            width: 56px; height: 56px; border-radius: 50%; background: rgba(255,255,255,0.06);
            border: 2px dashed rgba(255,255,255,0.12); display: flex; align-items: center; justify-content: center;
            overflow: hidden; cursor: pointer; flex-shrink: 0; transition: all 0.15s;
        }
        .photo-preview:hover { border-color: rgba(0,140,255,0.4); background: rgba(0,140,255,0.05); }
        .photo-preview img { width: 100%; height: 100%; object-fit: cover; }
        .photo-preview .placeholder { font-size: 20px; opacity: 0.3; }
        .photo-upload-btn {
            font-size: 11px; color: rgba(0,140,255,0.8); cursor: pointer; padding: 4px 10px;
            background: rgba(0,140,255,0.08); border: 1px solid rgba(0,140,255,0.15); border-radius: 6px;
        }
        .photo-upload-btn:hover { background: rgba(0,140,255,0.15); }
        .photo-remove { font-size: 10px; color: rgba(255,100,100,0.6); cursor: pointer; margin-left: 4px; }
        .photo-remove:hover { color: #ff4444; }

        .count-label { font-size: 12px; color: rgba(255,255,255,0.3); padding: 0 32px 8px; font-weight: 500; }
    
/* === DOCK NAV === */

/* === DOCK NAV === */
.dock-nav{position:fixed;top:10px;right:12px;z-index:9999;display:flex;align-items:center;gap:4px;background:rgba(255,255,255,0.06);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.08);border-radius:13px;padding:4px 7px;}
.dock-nav a,.dock-nav .dock-btn{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s cubic-bezier(0.34,1.56,0.64,1);position:relative;text-decoration:none;border:none;outline:none;}
.dock-nav a:hover,.dock-nav .dock-btn:hover{transform:scale(1.3) translateY(-3px);z-index:10;}
.dock-nav a:hover .dk-tip,.dock-nav .dock-btn:hover .dk-tip{opacity:1;transform:translateX(-50%) translateY(0);}
.dock-nav svg{width:14px;height:14px;fill:none;stroke:rgba(255,255,255,0.9);stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;}
.dock-nav .dk-inv svg{stroke:rgba(0,0,0,0.6);}
.dk-tip{position:absolute;top:calc(100% + 5px);left:50%;transform:translateX(-50%) translateY(-3px);background:rgba(0,0,0,0.85);backdrop-filter:blur(12px);color:#fff;font-size:8px;font-weight:600;padding:2px 6px;border-radius:4px;white-space:nowrap;opacity:0;pointer-events:none;transition:all 0.15s ease;letter-spacing:0.2px;font-family:-apple-system,sans-serif;}
.dk-act::after{content:'';position:absolute;bottom:-2px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,0.7);}
.dk-sep{width:1px;height:20px;background:rgba(255,255,255,0.08);margin:0 1px;}
.dk-home{background:rgba(255,255,255,0.08)!important;border-radius:8px!important;}
.dk-home:hover{background:rgba(255,255,255,0.15)!important;}
.dk-home svg{stroke:rgba(255,255,255,0.5)!important;}
.dr{background:linear-gradient(135deg,#ff416c,#ff4b2b);}
.dp{background:linear-gradient(135deg,#8b5cf6,#6366f1);}
.dc{background:linear-gradient(135deg,#00d2ff,#3a7bd5);}
.dv{background:linear-gradient(135deg,#667eea,#764ba2);}
.dk{background:linear-gradient(135deg,#f093fb,#f5576c);}
.dg{background:linear-gradient(135deg,#43e97b,#38f9d7);}
.do{background:linear-gradient(135deg,#f6d365,#fda085);}
.dt{background:linear-gradient(135deg,#0d9488,#06b6d4);}
.dd{background:linear-gradient(135deg,#1c2028,#2d2d2d);border:1px solid rgba(255,255,255,0.1);}

/* === END DOCK === */
</style>
</head>
<body>
<!-- DOCK START -->
<nav class="dock-nav"><a href="studio-manager.html" class="dk-home"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg><span class="dk-tip">Accueil</span></a><div class="dk-sep"></div><a href="https://lezenesvincent-dotcom.github.io/regie-video/" class="dr"><svg viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg><span class="dk-tip">R&eacute;gie</span></a><a href="agenda-studio.html" class="dp"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class="dk-tip">Agenda</span></a><a href="vignettes.html" class="dc"><svg viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="20" rx="3"/><circle cx="8" cy="8" r="2"/><path d="M21 15l-5-5L5 21"/></svg><span class="dk-tip">Vignettes</span></a><a href="creation.html" class="dv"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg><span class="dk-tip">Cr&eacute;ation</span></a><a href="manage-ei.html" class="dk"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg><span class="dk-tip">Manage</span></a><div class="dk-sep"></div><a href="contact-studio.html" class="dg dk-inv"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg><span class="dk-tip">Contact</span></a><a href="prestation.html" class="do dk-inv"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg><span class="dk-tip">Prestations</span></a><a href="carnet.html" class="dt dk-act"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span class="dk-tip">Carnet</span></a><div class="dk-sep"></div><a href="studio-2027.html" class="dd"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span class="dk-tip">2027</span></a><a href="studio-alert.html" class="dr"><svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg><span class="dk-tip">Alert</span></a><a href="dev-dashboard.html" class="dd"><svg viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg><span class="dk-tip">Dev</span></a></nav>
<!-- DOCK END -->

    <div class="album-bg" id="albumBg"></div>
    <div class="page-wrap">
        <div class="header">
            <h1>Carnet d'adresses <span>Intervenants Studio</span></h1>
            <a href="studio-manager.html" class="back-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Studio Manager
            </a>
        </div>
        <div class="toolbar">
            <div class="search-box">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" id="searchInput" placeholder="Rechercher un analyste..." oninput="renderContacts()">
            </div>
            <div class="filter-btns">
                <button class="filter-btn active" data-filter="all" onclick="setFilter(this)">Tous</button>
                <button class="filter-btn" data-filter="actions" onclick="setFilter(this)">Actions</button>
                <button class="filter-btn" data-filter="eco" onclick="setFilter(this)">√âco</button>
                <button class="filter-btn" data-filter="esg" onclick="setFilter(this)">ESG</button>
                <button class="filter-btn" data-filter="technique" onclick="setFilter(this)">Technique</button>
                <button class="filter-btn" data-filter="credit" onclick="setFilter(this)">Cr√©dit</button>
            </div>
            <button class="btn-add" onclick="openModal()">+ Ajouter</button>
        </div>
        <div class="count-label" id="countLabel"></div>
        <div class="contacts-grid" id="contactsGrid"></div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <h3 id="modalTitle">Ajouter un contact</h3>
            <div class="field"><label>Photos</label>
                <div class="photo-upload">
                    <div id="photosGallery" style="display:flex;gap:6px;flex-wrap:wrap"></div>
                    <div style="display:flex;align-items:center;gap:8px;margin-top:4px">
                        <span class="photo-upload-btn" onclick="document.getElementById('photoInput').click()">+ Ajouter une photo</span>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" onchange="handlePhotoUpload(this)" style="display:none" multiple>
                </div>
            </div>
            <div class="field"><label>Pr√©nom</label><input type="text" id="mFirstName" placeholder="Ex: √âric"></div>
            <div class="field"><label>Nom</label><input type="text" id="mLastName" placeholder="Ex: Lemari√©"></div>
            <div class="field"><label>Sp√©cialit√©</label>
                <select id="mSpeciality">
                    <option value="actions">Recherche Actions</option>
                    <option value="eco">√âconomie & March√©s Financiers</option>
                    <option value="esg">Recherche D√©veloppement Durable</option>
                    <option value="technique">Analyse Technique</option>
                    <option value="credit">Cr√©dit</option>
                </select>
            </div>
            <div class="field"><label>Fonction</label><input type="text" id="mFunction" placeholder="Ex: Analyste Biens d'√©quipement"></div>
            <div class="field"><label>Soci√©t√©</label><input type="text" id="mCompany" placeholder="Ex: CIC Corporate & Institutional Banking" value="CIC Corporate & Institutional Banking"></div>
            <div class="field"><label>Email</label><input type="email" id="mEmail" placeholder="Ex: eric.lemarie@cic.fr"></div>
            <div class="modal-btns" id="modalBtns">
                <button class="modal-btn-cancel" onclick="closeModal()">Annuler</button>
                <button class="modal-btn-save" onclick="saveContact()">Enregistrer</button>
            </div>
        </div>
    </div>

    <script>
    // === DATA ===
    var GH_TOKEN_PARTS = ['s6Q6VG_phg','71QRNKGR8m','EiaK9FWAqE','cWTym0zJLw'];
    var GH_TOKEN = GH_TOKEN_PARTS.map(function(s){return s.split('').reverse().join('')}).join('');
    var GH_REPO = 'lezenesvincent-dotcom/mon-content-manager';
    var GH_CONTACTS_FILE = 'contacts.json';
    var GH_CONTACTS_API = 'https://api.github.com/repos/' + GH_REPO + '/contents/' + GH_CONTACTS_FILE;

    var contacts = [];
    var contactsSha = null;
    var currentFilter = 'all';
    var editingId = null;
    var pendingPhotos = null; // null=garder existantes, []=modifi√©es

    // === PHOTOS MULTIPLES ===
    function handlePhotoUpload(input) {
        if (!input.files || input.files.length === 0) return;
        if (pendingPhotos === null) pendingPhotos = [];
        Array.from(input.files).forEach(function(file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var img = new Image();
                img.onload = function() {
                    var maxW = 1150, maxH = 650;
                    var w = img.width, h = img.height;
                    if (w > maxW || h > maxH) {
                        var ratio = Math.min(maxW / w, maxH / h);
                        w = Math.round(w * ratio); h = Math.round(h * ratio);
                    }
                    var canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    pendingPhotos.push(canvas.toDataURL('image/png'));
                    renderPhotosGallery();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
        input.value = '';
    }

    function removePhotoAt(idx) {
        if (!pendingPhotos) return;
        pendingPhotos.splice(idx, 1);
        renderPhotosGallery();
    }

    function renderPhotosGallery() {
        var g = document.getElementById('photosGallery'); if (!g) return;
        g.innerHTML = '';
        var photos = pendingPhotos || [];
        photos.forEach(function(src, i) {
            var d = document.createElement('div');
            d.style.cssText = 'position:relative;width:60px;height:60px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.1);flex-shrink:0';
            d.innerHTML = '<img src="' + src + '" style="width:100%;height:100%;object-fit:cover">' +
                '<div onclick="removePhotoAt(' + i + ')" style="position:absolute;top:2px;right:2px;width:14px;height:14px;background:rgba(0,0,0,0.7);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:8px;color:#fff">‚úï</div>' +
                '<div style="position:absolute;bottom:2px;left:2px;font-size:7px;color:rgba(255,255,255,0.7);background:rgba(0,0,0,0.5);padding:0 3px;border-radius:3px">#' + (i + 1) + '</div>';
            g.appendChild(d);
        });
        if (photos.length === 0) {
            g.innerHTML = '<div style="width:60px;height:60px;border-radius:8px;border:1px dashed rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-size:18px;color:rgba(255,255,255,0.2);cursor:pointer" onclick="document.getElementById(\'photoInput\').click()">üì∑</div>';
        }
    }

    function resetPhotoField() {
        pendingPhotos = null;
        renderPhotosGallery();
    }

    var SPEC_LABELS = {
        actions: 'RECHERCHE ACTIONS',
        eco: '√âCONOMIE & MARCH√âS FINANCIERS',
        esg: 'RECHERCHE D√âVELOPPEMENT DURABLE',
        technique: 'ANALYSE TECHNIQUE', credit: 'CR√âDIT'
    };
    var SPEC_TAGS = {
        actions: 'tag-actions',
        eco: 'tag-eco',
        esg: 'tag-esg',
        technique: 'tag-technique', credit: 'tag-credit'
    };

    // Default analysts
    var DEFAULT_CONTACTS = [
        { id: 'c01', firstName: 'Christian', lastName: 'Devismes', speciality: 'actions', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/christian-devismes.png' },
        { id: 'c02', firstName: 'Herv√©', lastName: 'Drouet', speciality: 'actions', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/herve-drouet.png' },
        { id: 'c03', firstName: 'Eric', lastName: 'Ravary', speciality: 'actions', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/eric-ravary.png' },
        { id: 'c04', firstName: 'Emmanuel', lastName: 'Chevalier', speciality: 'actions', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/emmanuel-chevalier.png' },
        { id: 'c05', firstName: 'Ebrahim', lastName: 'Homani', speciality: 'actions', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/ebrahim-homani.png' },
        { id: 'c06', firstName: '√âric', lastName: 'Lemari√©', speciality: 'actions', function: 'Analyste Biens d\'√©quipement', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/eric-lemarie.png' },
        { id: 'c07', firstName: 'Arnaud', lastName: 'Palliez', speciality: 'eco', function: '√âconomiste', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/arnaud-palliez.png' },
        { id: 'c08', firstName: 'Jean-Luc', lastName: 'Romain', speciality: 'actions', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/jean-luc-romain.png' },
        { id: 'c09', firstName: 'Alexandre', lastName: 'Plaud', speciality: 'technique', function: 'Analyste Technique', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/alexandre-plaud.png' },
        { id: 'c10', firstName: 'Virginie', lastName: 'Roy√®re', speciality: 'actions', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/virginie-royere.png' },
        { id: 'c11', firstName: 'Arnaud', lastName: 'Cadart', speciality: 'esg', function: 'Analyste ESG', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/arnaud-cadart.png' },
        { id: 'c12', firstName: 'David', lastName: 'Da Maia', speciality: 'actions', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/david-da-maia.png' },
        { id: 'c13', firstName: 'Pierre', lastName: 'Ch√©deville', speciality: 'actions', function: 'Analyste Construction & Mat√©riaux', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/pierre-chedeville.png' },
        { id: 'c14', firstName: 'Dominique', lastName: 'Descours', speciality: 'actions', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/dominique-descours.png' },
        { id: 'c15', firstName: 'Alexandre', lastName: 'G√©rard', speciality: 'technique', function: 'Analyste Technique', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/alexandre-gerard.png' },
        { id: 'c16', firstName: 'Adrien', lastName: 'R√©gnier-Laurent', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/adrien-regnier-laurent.png' },
        { id: 'c17', firstName: 'Anne-Lise', lastName: 'Cornen', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/anne-lise-cornen.png' },
        { id: 'c18', firstName: 'Beno√Æt', lastName: 'Rodriguez', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/benoit-rodriguez.png' },
        { id: 'c19', firstName: 'Emmanuelle', lastName: 'Thollon-Pommerol', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/emmanuelle-thollon-pommerol.png' },
        { id: 'c20', firstName: 'Eric', lastName: 'Baron', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/eric-baron.png' },
        { id: 'c21', firstName: 'Eva', lastName: 'Bellin', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/eva-bellin.png' },
        { id: 'c22', firstName: 'Eva', lastName: 'Zarbo', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/eva-zarbo.png' },
        { id: 'c23', firstName: 'Fabrissa', lastName: 'Tassin', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/fabrissa-tassin.png' },
        { id: 'c24', firstName: 'Fran√ßois', lastName: 'Duhen', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/francois-duhen.png' },
        { id: 'c25', firstName: 'Fran√ßoise', lastName: '√âtienne', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/francoise-etienne.png' },
        { id: 'c26', firstName: 'Gabriel', lastName: 'Corbassi√®re', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/gabriel-corbassiere.png' },
        { id: 'c27', firstName: 'Marc', lastName: 'Gontran', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/marc-gontran.png' },
        { id: 'c28', firstName: 'Martin', lastName: 'Gicquiau', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/martin-gicquiau.png' },
        { id: 'c29', firstName: 'Nicolas', lastName: 'Bouthors', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/nicolas-bouthors.png' },
        { id: 'c30', firstName: 'Nicolas', lastName: 'Haese', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/nicolas-haese.png' },
        { id: 'c31', firstName: 'St√©phane', lastName: 'Leandri', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/stephane-leandri.png' },
        { id: 'c32', firstName: 'William', lastName: 'Honvo', speciality: 'eco', function: '', company: 'CIC Corporate & Institutional Banking', email: '', photo: 'contacts-photos/william-honvo.png' },
    ];

    // === LOAD / SAVE ===
    async function loadContacts() {
        try {
            var resp = await fetch(GH_CONTACTS_API, { headers: { 'Authorization': 'token '+GH_TOKEN, 'Accept': 'application/vnd.github.v3+json' }, cache: 'no-store' });
            if (resp.ok) {
                var data = await resp.json();
                contactsSha = data.sha;
                contacts = JSON.parse(decodeURIComponent(escape(atob(data.content))));
            } else {
                contacts = DEFAULT_CONTACTS;
                await saveToGitHub();
            }
        } catch(e) {
            console.error('Load error:', e);
            contacts = DEFAULT_CONTACTS;
        }
        renderContacts();
    }

    async function saveToGitHub() {
        try {
            var body = { message: 'contacts update', content: btoa(unescape(encodeURIComponent(JSON.stringify(contacts, null, 2)))), branch: 'main' };
            if (contactsSha) body.sha = contactsSha;
            var resp = await fetch(GH_CONTACTS_API, {
                method: 'PUT',
                headers: { 'Authorization': 'token '+GH_TOKEN, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (resp.ok) {
                var data = await resp.json();
                contactsSha = data.content.sha;
            }
        } catch(e) { console.error('Save error:', e); }
    }

    // === RENDER ===
    function renderContacts() {
        var search = document.getElementById('searchInput').value.toLowerCase();
        var filtered = contacts.filter(function(c) {
            if (currentFilter !== 'all' && c.speciality !== currentFilter) return false;
            if (search) {
                var full = (c.firstName + ' ' + c.lastName + ' ' + c.function + ' ' + c.company).toLowerCase();
                return full.indexOf(search) > -1;
            }
            return true;
        });

        // Tri par pr√©nom
        filtered.sort(function(a, b) {
            return a.firstName.localeCompare(b.firstName, 'fr');
        });

        document.getElementById('countLabel').textContent = filtered.length + ' contact' + (filtered.length > 1 ? 's' : '');
        var grid = document.getElementById('contactsGrid');
        grid.innerHTML = '';

        filtered.forEach(function(c) {
            var initials = (c.firstName[0] || '') + (c.lastName[0] || '');
            var specLabel = SPEC_LABELS[c.speciality] || c.speciality;
            var tagClass = SPEC_TAGS[c.speciality] || 'tag-actions';

            var avatarContent = c.photo ? '<img src="'+c.photo+'" alt="" onerror="this.style.display=\'none\';this.parentNode.textContent=\''+initials.toUpperCase()+'\';">' : initials.toUpperCase();
            var div = document.createElement('div');
            div.className = 'contact-card';
            div.onclick = function() { openModal(c.id); };
            div.innerHTML =
                '<div class="card-actions">' +
                    '<button class="card-action-btn delete" onclick="event.stopPropagation();deleteContact(\''+c.id+'\')">‚úï</button>' +
                '</div>' +
                '<div class="card-top">' +
                    '<div class="avatar">' + avatarContent + '</div>' +
                    '<div><div class="card-name">' + c.firstName + ' ' + c.lastName + '</div>' +
                    '<div class="card-function">' + (c.function || '') + '</div></div>' +
                '</div>' +
                '<div class="card-tags"><span class="tag ' + tagClass + '">' + specLabel + '</span></div>' +
                '<div class="card-company">' + (c.company || '') + '</div>';
            grid.appendChild(div);
        });
    }

    function setFilter(btn) {
        document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderContacts();
    }

    // === MODAL ===
    function openModal(id) {
        editingId = id || null;
        resetPhotoField();
        if (id) {
            var c = contacts.find(function(x) { return x.id === id; });
            if (!c) return;
            document.getElementById('modalTitle').textContent = 'Modifier';
            document.getElementById('mFirstName').value = c.firstName;
            document.getElementById('mLastName').value = c.lastName;
            document.getElementById('mSpeciality').value = c.speciality;
            document.getElementById('mFunction').value = c.function || '';
            document.getElementById('mCompany').value = c.company || '';
            document.getElementById('mEmail').value = c.email || '';
            // Charger photos existantes
            var existingPhotos = c.photos || (c.photo && c.photo.length > 10 ? [c.photo] : []);
            if (existingPhotos.length > 0) {
                pendingPhotos = existingPhotos.slice(); // copie
                renderPhotosGallery();
            }
            document.getElementById('modalBtns').innerHTML =
                '<button class="modal-btn-delete" onclick="deleteContact(\''+id+'\');closeModal()">Supprimer</button>' +
                '<div style="flex:1"></div>' +
                '<button class="modal-btn-cancel" onclick="closeModal()">Annuler</button>' +
                '<button class="modal-btn-save" onclick="saveContact()">Modifier</button>';
        } else {
            document.getElementById('modalTitle').textContent = 'Ajouter un contact';
            document.getElementById('mFirstName').value = '';
            document.getElementById('mLastName').value = '';
            document.getElementById('mSpeciality').value = 'actions';
            document.getElementById('mFunction').value = '';
            document.getElementById('mCompany').value = 'CIC Corporate & Institutional Banking';
            document.getElementById('mEmail').value = '';
            document.getElementById('modalBtns').innerHTML =
                '<button class="modal-btn-cancel" onclick="closeModal()">Annuler</button>' +
                '<button class="modal-btn-save" onclick="saveContact()">Enregistrer</button>';
        }
        document.getElementById('modalOverlay').classList.add('visible');
        setTimeout(function() { document.getElementById('mFirstName').focus(); }, 50);
    }

    function closeModal() {
        document.getElementById('modalOverlay').classList.remove('visible');
        editingId = null;
    }

    async function uploadPhotoToGitHub(contactId, photoIdx, dataUrl) {
        var b64 = dataUrl.split(',')[1];
        if (!b64) return null;
        var slug = contactId.replace(/[^a-z0-9_-]/gi, '');
        var path = 'contacts-photos/' + slug + '-' + (photoIdx + 1) + '.png';
        // Check if already a path (not data URL)
        if (dataUrl.indexOf('data:') !== 0) return dataUrl;
        try {
            // Get existing sha
            var sha = null;
            try {
                var existing = await fetch('https://api.github.com/repos/' + GH_REPO + '/contents/' + path, {
                    headers: { 'Authorization': 'token ' + GH_TOKEN, 'Accept': 'application/vnd.github.v3+json' }
                });
                if (existing.ok) { var ed = await existing.json(); sha = ed.sha; }
            } catch(e) {}
            var body = { message: 'photo ' + slug + '-' + (photoIdx + 1), content: b64, branch: 'main' };
            if (sha) body.sha = sha;
            var r = await fetch('https://api.github.com/repos/' + GH_REPO + '/contents/' + path, {
                method: 'PUT',
                headers: { 'Authorization': 'token ' + GH_TOKEN, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (r.ok) return path;
        } catch(e) { console.error('Photo upload error:', e); }
        return null;
    }

    async function saveContact() {
        var firstName = document.getElementById('mFirstName').value.trim();
        var lastName = document.getElementById('mLastName').value.trim();
        if (!firstName || !lastName) return;

        // Feedback visuel
        var saveBtn = document.querySelector('.modal-btn-save');
        if (saveBtn) { saveBtn.textContent = '‚è≥ Sauvegarde...'; saveBtn.disabled = true; }

        var data = {
            firstName: firstName,
            lastName: lastName,
            speciality: document.getElementById('mSpeciality').value,
            function: document.getElementById('mFunction').value.trim(),
            company: document.getElementById('mCompany').value.trim(),
            email: document.getElementById('mEmail').value.trim()
        };

        var contactId;
        if (editingId) {
            contactId = editingId;
            data.id = editingId;
        } else {
            contactId = 'c_' + Date.now();
            data.id = contactId;
        }

        // Upload photos s√©par√©ment sur GitHub
        var photoPaths = [];
        var photosToSave = pendingPhotos;
        if (pendingPhotos === null && editingId) {
            var existing = contacts.find(function(c) { return c.id === editingId; });
            photosToSave = existing ? (existing.photos || (existing.photo ? [existing.photo] : [])) : [];
        }
        if (photosToSave === null) photosToSave = [];

        for (var i = 0; i < photosToSave.length; i++) {
            var src = photosToSave[i];
            if (src.indexOf('data:') === 0) {
                // Upload to GitHub as file
                var path = await uploadPhotoToGitHub(contactId, i, src);
                photoPaths.push(path || src);
            } else {
                photoPaths.push(src); // Already a path
            }
        }

        data.photos = photoPaths;
        data.photo = photoPaths[0] || '';

        if (editingId) {
            var idx = contacts.findIndex(function(c) { return c.id === editingId; });
            if (idx > -1) contacts[idx] = data;
        } else {
            contacts.push(data);
        }

        saveToGitHub();
        renderContacts();
        closeModal();
    }

    function deleteContact(id) {
        if (!confirm('Supprimer ce contact ?')) return;
        contacts = contacts.filter(function(c) { return c.id !== id; });
        saveToGitHub();
        renderContacts();
    }

    // === KEYBOARD ===
    document.addEventListener('keydown', function(e) {
        if (!document.getElementById('modalOverlay').classList.contains('visible')) return;
        if (e.key === 'Enter') saveContact();
        if (e.key === 'Escape') closeModal();
    });

    // === ALBUM BG ===
    var ALBUMS=['https://i.scdn.co/image/ab67616d0000b273b1c4b76e23414c9f20f43b14','https://i.scdn.co/image/ab67616d0000b2738b52c6b9bc4e43d873869699','https://i.scdn.co/image/ab67616d0000b273e2e352d89826aef6dbd5ff8f','https://i.scdn.co/image/ab67616d0000b2739e1cfc756886ac782e363d79','https://i.scdn.co/image/ab67616d0000b27368384dd85fd5e95831252f60','https://i.scdn.co/image/ab67616d0000b273879e9318cb9f4e05ee552ac9','https://i.scdn.co/image/ab67616d0000b273b46f74097655d7f353caab14','https://i.scdn.co/image/ab67616d0000b2730b51f8d91f3a21e8426361ae','https://i.scdn.co/image/ab67616d0000b2734718e2b124f79258be7571c1','https://i.scdn.co/image/ab67616d0000b27395f754318336a07e85ec59bc','https://i.scdn.co/image/ab67616d0000b273d9985092cd88bffd97653b58','https://i.scdn.co/image/ab67616d0000b2738940ac99f49e44f59e6f7fb3','https://i.scdn.co/image/ab67616d0000b273ba5db46f4b838ef6027e6f96','https://i.scdn.co/image/ab67616d0000b2734637341b9f507521afa9a778','https://i.scdn.co/image/ab67616d0000b273e787cffec20aa2a396a61647'];
    var idx=0,bg=document.getElementById('albumBg'),l1=document.createElement('div'),l2=document.createElement('div');
    l1.className='cover active';l2.className='cover';bg.appendChild(l1);bg.appendChild(l2);
    for(var i=ALBUMS.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=ALBUMS[i];ALBUMS[i]=ALBUMS[j];ALBUMS[j]=t;}
    l1.style.backgroundImage='url('+ALBUMS[0]+')';
    setInterval(function(){idx=(idx+1)%ALBUMS.length;var a=l1.classList.contains('active')?l1:l2,b=(a===l1)?l2:l1;b.style.backgroundImage='url('+ALBUMS[idx]+')';b.classList.add('active');a.classList.remove('active');},30000);

    // === INIT ===
    loadContacts();
    </script>


<script>
(function(){
    var ALERT_WS_URL = 'wss://ecamm-overlay-server.onrender.com';
    var ALERT_PROXY_URL = 'https://script.google.com/macros/s/AKfycbzjO0-wHGd-uIIJhnpmBAVQxIruHnQUpnvFpsrEqAsSDkerG8z0Cp47HYgojMHlOG9pFQ/exec';
    var alertWs = null;
    var alertAudioCtx = null;
    var alertNodes = [];
    var alertActive = false;
    var alertBanner = null;

    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();

    function createAlertBanner() {
        if (alertBanner) return;
        alertBanner = document.createElement('div');
        alertBanner.id = 'studioAlertBanner';
        alertBanner.style.cssText = 'position:fixed;inset:0;z-index:99999;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(255,0,0,0.85);animation:alertFlash 0.5s infinite;cursor:pointer;';
        alertBanner.innerHTML = '<div style="font-size:72px;margin-bottom:20px;">&#x1F6A8;</div>' +
            '<div style="font-size:28px;font-weight:800;color:#fff;margin-bottom:12px;">ALERTE STUDIO</div>' +
            '<div style="font-size:16px;color:rgba(255,255,255,0.8);margin-bottom:10px;" id="alertBannerMsg"></div>' +
            '<div style="font-size:14px;color:rgba(255,255,255,0.6);margin-bottom:30px;" id="alertBannerSound">&#x1F50A; Cliquez n\'importe o\u00f9 pour activer le son</div>' +
            '<button onclick="window._ackStudioAlert()" style="padding:18px 50px;font-size:18px;font-weight:800;background:#fff;color:#ff0000;border:none;border-radius:14px;cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,0.3);text-transform:uppercase;">&#x2705; PRISE EN CHARGE</button>';
        alertBanner.addEventListener('click', function(e) {
            if (e.target.tagName !== 'BUTTON') forceAlertSound();
        });
        document.body.appendChild(alertBanner);
        var style = document.createElement('style');
        style.textContent = '@keyframes alertFlash{0%,100%{background:rgba(255,0,0,0.85);}50%{background:rgba(180,0,0,0.95);}}';
        document.head.appendChild(style);
    }

    function showBanner(title, msg) {
        // Ne pas sonner si cette machine est l'√©mettrice (flag < 15s)
        var emitTime = parseInt(localStorage.getItem('alertEmitter') || '0');
        if (Date.now() - emitTime < 15000) return;
        createAlertBanner();
        document.getElementById('alertBannerMsg').textContent = (title || 'Nouvelle alerte') + (msg ? ' \u2014 ' + msg : '');
        alertBanner.style.display = 'flex';
        forceAlertSound();
        sendNotif(title, msg);
    }

    function hideBanner() { if (alertBanner) alertBanner.style.display = 'none'; }

    function forceAlertSound() {
        if (!alertAudioCtx) alertAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (alertAudioCtx.state === 'suspended') {
            alertAudioCtx.resume().then(function() {
                if (!alertActive) startOsc();
                var el = document.getElementById('alertBannerSound'); if (el) el.style.display = 'none';
            });
        } else {
            if (!alertActive) startOsc();
            var el = document.getElementById('alertBannerSound'); if (el) el.style.display = 'none';
        }
    }

    var alertChimeAudio = new Audio('alert-chime.mp3');
    alertChimeAudio.preload = 'auto'; alertChimeAudio.volume = 0.3;
    var alertLoopTimer = null;

    function startOsc() {
        alertActive = true;
        function playSequence() {
            if (!alertActive) return;
            alertChimeAudio.currentTime = 0; alertChimeAudio.volume = 0.3;
            alertChimeAudio.play().catch(function(){});
            alertLoopTimer = setTimeout(function(){ if (!alertActive) return; speakAlert(); }, 8800);
        }
        function speakAlert() {
            if (!('speechSynthesis' in window)) { scheduleNext(); return; }
            var stored = [];
            try { stored = JSON.parse(localStorage.getItem('studioAlerts') || '[]'); } catch(e){}
            var lastNew = null;
            for (var i=0;i<stored.length;i++) { if (stored[i].status === 'sent') { lastNew = stored[i]; break; } }
            var text = 'Attention, alerte studio.';
            if (lastNew) {
                var prenom = lastNew.emitter ? lastNew.emitter.name.split(' ')[0] : '';
                var desc = lastNew.title || lastNew.description || '';
                if (prenom && desc) text = prenom + ' signale : ' + desc;
                else if (prenom) text = 'Alerte de ' + prenom;
                else if (desc) text = 'Attention : ' + desc;
            }
            window.speechSynthesis.cancel();
            var utt = new SpeechSynthesisUtterance(text);
            utt.lang = 'fr-FR'; utt.rate = 0.9; utt.pitch = 1.05; utt.volume = 0.3;
            var voices = window.speechSynthesis.getVoices();
            var pref = null;
            for (var v=0;v<voices.length;v++) {
                if (voices[v].lang==='fr-FR' && voices[v].name.indexOf('Amelie')>-1) { pref=voices[v]; break; }
                if (voices[v].lang==='fr-FR' && voices[v].name.indexOf('Thomas')>-1 && !pref) pref=voices[v];
                if (voices[v].lang.indexOf('fr')===0 && !pref) pref=voices[v];
            }
            if (pref) utt.voice = pref;
            utt.onend = function(){ scheduleNext(); };
            utt.onerror = function(){ scheduleNext(); };
            window.speechSynthesis.speak(utt);
        }
        function scheduleNext() { alertLoopTimer = setTimeout(function(){ if (alertActive) playSequence(); }, 2000); }
        if ('speechSynthesis' in window) window.speechSynthesis.getVoices();
        playSequence();
    }

    function stopSound() {
        alertActive = false;
        if (alertChimeAudio) { alertChimeAudio.pause(); alertChimeAudio.currentTime = 0; }
        if (alertLoopTimer) { clearTimeout(alertLoopTimer); alertLoopTimer = null; }
        if (window.speechSynthesis) window.speechSynthesis.cancel();
        alertNodes.forEach(function(n){ try{n.osc.stop();}catch(e){} });
        alertNodes = [];
        hideBanner();
    }

    function sendNotif(title, msg) {
        if (!('Notification' in window) || Notification.permission !== 'granted') return;
        try {
            var n = new Notification('\uD83D\uDEA8 ALERTE STUDIO', {
                body: (title || 'Alerte') + (msg ? ' \u2014 ' + msg : ''),
                requireInteraction: true, tag: 'studio-alert'
            });
            n.onclick = function() { window.focus(); n.close(); };
        } catch(e) {}
    }

    window._ackStudioAlert = function() {
        stopSound();
        if (alertWs && alertWs.readyState === WebSocket.OPEN) {
            var stored = [];
            try { stored = JSON.parse(localStorage.getItem('studioAlerts') || '[]'); } catch(e){}
            stored.forEach(function(a) {
                if (a.status === 'sent') {
                    a.status = 'handled'; a.handledAt = new Date().toISOString();
                    alertWs.send(JSON.stringify({type:'studio-alert-update', data:{id:a.id, status:'handled'}}));
                }
            });
            localStorage.setItem('studioAlerts', JSON.stringify(stored));
        }
    };

    var alertProxyTimer = null;
    var alertWsFails = 0;
    function startAlertProxyPolling() {
        if (alertProxyTimer) return;
        alertProxyTimer = setInterval(function() {
            fetch(ALERT_PROXY_URL + '?action=sync').then(function(r){ return r.json(); }).then(function(data) {
                if (!Array.isArray(data)) return;
                var stored = [];
                try { stored = JSON.parse(localStorage.getItem('studioAlerts') || '[]'); } catch(e){}
                var newOnes = data.filter(function(d){ return d.status === 'sent' && !stored.find(function(s){ return s.id === d.id; }); });
                localStorage.setItem('studioAlerts', JSON.stringify(data));
                if (newOnes.length > 0) {
                    showBanner(newOnes[0].title, newOnes[0].emitter ? newOnes[0].emitter.name : '');
                }
                if (!data.some(function(d){ return d.status === 'sent'; })) { stopSound(); }
            }).catch(function(){});
        }, 3000);
    }

    function connectAlertWS() {
        alertWs = new WebSocket(ALERT_WS_URL);
        alertWs.onmessage = function(e) {
            try {
                var msg = JSON.parse(e.data);
                if (msg.type === 'studio-alert' && msg.data && msg.data.status === 'sent') {
                    var stored = [];
                    try { stored = JSON.parse(localStorage.getItem('studioAlerts') || '[]'); } catch(ex){}
                    if (!stored.find(function(a){return a.id === msg.data.id;})) {
                        stored.unshift(msg.data); localStorage.setItem('studioAlerts', JSON.stringify(stored));
                    }
                    showBanner(msg.data.title, msg.data.emitter ? msg.data.emitter.name : '');
                }
                if (msg.type === 'studio-alert-update' && msg.data && msg.data.status !== 'sent') { stopSound(); }
            } catch(err) {}
        };
        alertWs.onclose = function(){
            alertWsFails = (alertWsFails || 0) + 1;
            if (alertWsFails >= 1) { startAlertProxyPolling(); } else { setTimeout(connectAlertWS, 3000); }
        };
        alertWs.onerror = function(){ alertWs.close(); };
    }

    // Check on load
    try {
        var existing = JSON.parse(localStorage.getItem('studioAlerts') || '[]');
        if (existing.some(function(a){return a.status === 'sent';})) {
            var last = existing.find(function(a){return a.status === 'sent';});
            setTimeout(function(){ showBanner(last.title, last.emitter ? last.emitter.name : ''); }, 500);
        }
    } catch(e){}

    connectAlertWS();
})();
</script>

<div id="versionBadge" style="position:fixed;bottom:6px;left:8px;z-index:9998;font-family:-apple-system,sans-serif;font-size:9px;color:rgba(255,255,255,0.45);pointer-events:none;background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:4px;">v39</div>
</body>
</html>
