<!-- dev-dashboard v1.0 - 2026-02-18 -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dev Dashboard â€” Studio Manager</title>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Helvetica Neue', Helvetica, Arial, sans-serif !important; }
        body { background: #0a0c14; color: #fff; min-height: 100vh; }

        .header { padding: 18px 28px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .header-left { display: flex; align-items: center; gap: 14px; }
        .header h1 { font-size: 22px; font-weight: 700; letter-spacing: -0.3px; }
        .header h1 span { color: #0070f3; }
        .back-btn { color: rgba(255,255,255,0.4); text-decoration: none; font-size: 13px; padding: 6px 14px; border-radius: 8px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); transition: all 0.2s; }
        .back-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .sync-info { font-size: 11px; color: rgba(255,255,255,0.3); display: flex; align-items: center; gap: 6px; }
        .sync-dot { width: 6px; height: 6px; border-radius: 50%; background: #44cc66; }
        .sync-dot.offline { background: #ff4444; }

        .columns-wrap { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0; height: calc(100vh - 60px); }

        .dev-column { border-right: 1px solid rgba(255,255,255,0.06); display: flex; flex-direction: column; overflow: hidden; }
        .dev-column:last-child { border-right: none; }

        .dev-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.06); flex-shrink: 0; }
        .dev-avatar {
            width: 64px; height: 64px; border-radius: 50%; margin: 0 auto 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; font-weight: 700; overflow: hidden; position: relative; cursor: pointer;
        }
        .dev-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .dev-avatar.dl { background: linear-gradient(135deg, #667eea, #764ba2); }
        .dev-avatar.tj { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .dev-avatar.vl { background: linear-gradient(135deg, #43e97b, #38f9d7); color: #1a3a2a; }
        .dev-avatar input[type=file] { display: none; }
        .dev-avatar:hover::after {
            content: 'ðŸ“·'; position: absolute; inset: 0; background: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        .dev-name { font-size: 15px; font-weight: 700; }
        .dev-role { font-size: 11px; color: rgba(255,255,255,0.3); margin-top: 2px; }
        .dev-stats { display: flex; gap: 16px; justify-content: center; margin-top: 10px; }
        .dev-stat { text-align: center; }
        .dev-stat-num { font-size: 18px; font-weight: 700; }
        .dev-stat-num.dl-c { color: #667eea; }
        .dev-stat-num.tj-c { color: #f093fb; }
        .dev-stat-num.vl-c { color: #43e97b; }
        .dev-stat-label { font-size: 9px; color: rgba(255,255,255,0.25); text-transform: uppercase; letter-spacing: 0.5px; }

        .dev-entries { flex: 1; overflow-y: auto; padding: 12px; }
        .dev-entries::-webkit-scrollbar { width: 4px; }
        .dev-entries::-webkit-scrollbar-track { background: transparent; }
        .dev-entries::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

        .entry {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 10px; padding: 10px 12px; margin-bottom: 8px; transition: all 0.15s;
        }
        .entry:hover { background: rgba(255,255,255,0.06); }
        .entry-time { font-size: 10px; color: rgba(255,255,255,0.2); margin-bottom: 3px; display: flex; align-items: center; gap: 6px; }
        .entry-time .tag { font-size: 9px; font-weight: 700; padding: 1px 6px; border-radius: 4px; }
        .tag-commit { background: rgba(0,112,243,0.15); color: #4da8ff; }
        .tag-claude { background: rgba(168,85,247,0.15); color: #c084fc; }
        .tag-file { background: rgba(234,179,8,0.15); color: #fbbf24; }
        .tag-deploy { background: rgba(34,197,94,0.15); color: #4ade80; }
        .entry-msg { font-size: 12px; font-weight: 500; line-height: 1.4; }
        .entry-files { margin-top: 4px; }
        .entry-file {
            display: inline-block; font-size: 10px; color: rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.04); padding: 2px 6px; border-radius: 4px; margin: 2px 2px 0 0;
        }
        .entry-link { font-size: 10px; color: rgba(0,112,243,0.6); text-decoration: none; margin-top: 3px; display: inline-block; }
        .entry-link:hover { color: #4da8ff; }

        .empty-col { text-align: center; padding: 40px 16px; color: rgba(255,255,255,0.15); font-size: 12px; }

        /* ADD ENTRY FORM */
        .add-entry-bar { padding: 10px 12px; border-top: 1px solid rgba(255,255,255,0.06); flex-shrink: 0; }
        .add-entry-row { display: flex; gap: 6px; }
        .add-entry-row input {
            flex: 1; padding: 8px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px; color: #fff; font-size: 12px; outline: none;
        }
        .add-entry-row input:focus { border-color: rgba(0,112,243,0.4); }
        .add-entry-row input::placeholder { color: rgba(255,255,255,0.2); }
        .add-entry-row button {
            padding: 8px 12px; background: rgba(0,112,243,0.2); border: 1px solid rgba(0,112,243,0.3);
            border-radius: 8px; color: #4da8ff; font-size: 12px; font-weight: 600; cursor: pointer;
        }

        @media (max-width: 900px) { .columns-wrap { grid-template-columns: 1fr; height: auto; } .dev-column { border-right: none; border-bottom: 1px solid rgba(255,255,255,0.06); max-height: 500px; } }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <a href="studio-manager.html" class="back-btn">&larr; Studio</a>
            <h1>&#x1F6E0;&#xFE0F; <span>Dev</span> Dashboard</h1>
        </div>
        <div style="display:flex;align-items:center;gap:16px;">
            <button onclick="refreshAll()" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:6px 14px;color:rgba(255,255,255,0.5);font-size:11px;cursor:pointer;">&#x21BB; Rafra&icirc;chir</button>
            <div class="sync-info"><div class="sync-dot" id="syncDot"></div><span id="syncText">Connexion...</span></div>
        </div>
    </div>

    <div class="columns-wrap">
        <!-- DAVID LANG -->
        <div class="dev-column">
            <div class="dev-header">
                <div class="dev-avatar dl" id="avatarDL" onclick="document.getElementById('photoDL').click()">DL<input type="file" id="photoDL" accept="image/*" onchange="uploadAvatar('DL',this)"></div>
                <div class="dev-name">David Lang</div>
                <div class="dev-role">Direction &amp; Strat&eacute;gie</div>
                <div class="dev-stats">
                    <div class="dev-stat"><div class="dev-stat-num dl-c" id="statDL">0</div><div class="dev-stat-label">modifs</div></div>
                </div>
            </div>
            <div class="dev-entries" id="entriesDL"></div>
            <div class="add-entry-bar">
                <div class="add-entry-row">
                    <input type="text" id="inputDL" placeholder="Ajouter une note..." onkeydown="if(event.key==='Enter')addManualEntry('DL')">
                    <button onclick="addManualEntry('DL')">+</button>
                </div>
            </div>
        </div>

        <!-- THOMAS JUMENTIER -->
        <div class="dev-column">
            <div class="dev-header">
                <div class="dev-avatar tj" id="avatarTJ" onclick="document.getElementById('photoTJ').click()">TJ<input type="file" id="photoTJ" accept="image/*" onchange="uploadAvatar('TJ',this)"></div>
                <div class="dev-name">Thomas Jumentier</div>
                <div class="dev-role">Backend &amp; Serveur</div>
                <div class="dev-stats">
                    <div class="dev-stat"><div class="dev-stat-num tj-c" id="statTJ">0</div><div class="dev-stat-label">modifs</div></div>
                </div>
            </div>
            <div class="dev-entries" id="entriesTJ"></div>
            <div class="add-entry-bar">
                <div class="add-entry-row">
                    <input type="text" id="inputTJ" placeholder="Ajouter une note..." onkeydown="if(event.key==='Enter')addManualEntry('TJ')">
                    <button onclick="addManualEntry('TJ')">+</button>
                </div>
            </div>
        </div>

        <!-- VINCENT LEZENES -->
        <div class="dev-column">
            <div class="dev-header">
                <div class="dev-avatar vl" id="avatarVL" onclick="document.getElementById('photoVL').click()">VL<input type="file" id="photoVL" accept="image/*" onchange="uploadAvatar('VL',this)"></div>
                <div class="dev-name">Vincent Lezenes</div>
                <div class="dev-role">3D, Cam&eacute;ras &amp; Int&eacute;gration</div>
                <div class="dev-stats">
                    <div class="dev-stat"><div class="dev-stat-num vl-c" id="statVL">0</div><div class="dev-stat-label">modifs</div></div>
                </div>
            </div>
            <div class="dev-entries" id="entriesVL"></div>
            <div class="add-entry-bar">
                <div class="add-entry-row">
                    <input type="text" id="inputVL" placeholder="Ajouter une note..." onkeydown="if(event.key==='Enter')addManualEntry('VL')">
                    <button onclick="addManualEntry('VL')">+</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    var API_URL = 'https://ecamm-overlay-server.onrender.com';
    var WS_URL = 'wss://ecamm-overlay-server.onrender.com';
    var GH_USER = 'lezenesvincent-dotcom';
    var GH_REPOS = ['mon-content-manager', 'ecamm-overlay-server', 'regie-video', 'overlay-manager2', 'overlay-backend'];

    var devLog = { DL: [], TJ: [], VL: [] };
    var avatars = {};
    var ws = null;

    // ===== AVATAR UPLOAD =====
    function uploadAvatar(who, input) {
        if (!input.files || !input.files[0]) return;
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = new Image();
            img.onload = function() {
                var canvas = document.createElement('canvas');
                canvas.width = 128; canvas.height = 128;
                var ctx = canvas.getContext('2d');
                var size = Math.min(img.width, img.height);
                var sx = (img.width - size) / 2, sy = (img.height - size) / 2;
                ctx.drawImage(img, sx, sy, size, size, 0, 0, 128, 128);
                avatars[who] = canvas.toDataURL('image/jpeg', 0.8);
                document.getElementById('avatar' + who).innerHTML = '<img src="' + avatars[who] + '"><input type="file" id="photo' + who + '" accept="image/*" onchange="uploadAvatar(\'' + who + '\',this)">';
                saveDevData();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }

    // ===== RENDER ENTRIES =====
    function renderEntries(who) {
        var container = document.getElementById('entries' + who);
        var entries = devLog[who] || [];
        document.getElementById('stat' + who).textContent = entries.length;

        if (entries.length === 0) {
            container.innerHTML = '<div class="empty-col">Aucune modification</div>';
            return;
        }

        container.innerHTML = entries.sort(function(a, b) { return new Date(b.time) - new Date(a.time); }).map(function(e) {
            var d = new Date(e.time);
            var timeStr = d.toLocaleDateString('fr-FR', {day:'2-digit',month:'2-digit'}) + ' ' + d.toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'});
            var tagClass = e.type === 'commit' ? 'tag-commit' : e.type === 'claude' ? 'tag-claude' : e.type === 'deploy' ? 'tag-deploy' : 'tag-file';
            var tagLabel = e.type === 'commit' ? 'COMMIT' : e.type === 'claude' ? 'CLAUDE' : e.type === 'deploy' ? 'DEPLOY' : 'NOTE';

            var filesHtml = '';
            if (e.files && e.files.length > 0) {
                filesHtml = '<div class="entry-files">' + e.files.slice(0, 5).map(function(f) { return '<span class="entry-file">' + f + '</span>'; }).join('') + (e.files.length > 5 ? '<span class="entry-file">+' + (e.files.length - 5) + '</span>' : '') + '</div>';
            }

            var linkHtml = e.url ? '<a href="' + e.url + '" target="_blank" class="entry-link">Voir &rarr;</a>' : '';
            var repoHtml = e.repo ? '<span style="color:rgba(255,255,255,0.15);">' + e.repo + '</span>' : '';

            return '<div class="entry">' +
                '<div class="entry-time"><span class="tag ' + tagClass + '">' + tagLabel + '</span> ' + timeStr + ' ' + repoHtml + '</div>' +
                '<div class="entry-msg">' + (e.message || '') + '</div>' +
                filesHtml + linkHtml +
            '</div>';
        }).join('');
    }

    function renderAll() {
        renderEntries('DL');
        renderEntries('TJ');
        renderEntries('VL');
        // Restore avatars
        ['DL','TJ','VL'].forEach(function(w) {
            if (avatars[w]) {
                document.getElementById('avatar' + w).innerHTML = '<img src="' + avatars[w] + '"><input type="file" id="photo' + w + '" accept="image/*" onchange="uploadAvatar(\'' + w + '\',this)">';
            }
        });
    }

    // ===== MANUAL ENTRY =====
    function addManualEntry(who) {
        var input = document.getElementById('input' + who);
        var msg = input.value.trim();
        if (!msg) return;
        devLog[who].push({
            type: 'note',
            message: msg,
            time: new Date().toISOString(),
            files: []
        });
        input.value = '';
        saveDevData();
        renderEntries(who);
        broadcastDevLog();
    }

    // ===== GITHUB COMMITS =====
    function fetchGitHubCommits() {
        var since = new Date();
        since.setDate(since.getDate() - 7);
        var sinceStr = since.toISOString();

        GH_REPOS.forEach(function(repo) {
            fetch('https://api.github.com/repos/' + GH_USER + '/' + repo + '/commits?since=' + sinceStr + '&per_page=30')
            .then(function(r) { return r.json(); })
            .then(function(commits) {
                if (!Array.isArray(commits)) return;
                commits.forEach(function(c) {
                    var msg = c.commit.message;
                    var time = c.commit.author.date;
                    var sha = c.sha.substring(0, 7);
                    var url = c.html_url;

                    // Detect author from commit message tags or default to VL
                    var who = 'VL';
                    if (msg.indexOf('[TJ]') > -1) who = 'TJ';
                    else if (msg.indexOf('[DL]') > -1) who = 'DL';
                    else if (msg.indexOf('[VL]') > -1) who = 'VL';
                    // Calendar sync = auto
                    if (msg.indexOf('sync calendar') > -1) return;

                    // Check if already exists
                    var exists = devLog[who].some(function(e) { return e.sha === sha; });
                    if (exists) return;

                    // Fetch files changed
                    fetch('https://api.github.com/repos/' + GH_USER + '/' + repo + '/commits/' + c.sha)
                    .then(function(r2) { return r2.json(); })
                    .then(function(detail) {
                        var files = (detail.files || []).map(function(f) { return f.filename; });
                        devLog[who].push({
                            type: 'commit',
                            message: msg.replace(/\[TJ\]|\[DL\]|\[VL\]/g, '').trim(),
                            time: time,
                            sha: sha,
                            repo: repo,
                            url: url,
                            files: files
                        });
                        saveDevData();
                        renderEntries(who);
                    }).catch(function() {
                        devLog[who].push({
                            type: 'commit',
                            message: msg.replace(/\[TJ\]|\[DL\]|\[VL\]/g, '').trim(),
                            time: time,
                            sha: sha,
                            repo: repo,
                            url: url,
                            files: []
                        });
                        saveDevData();
                        renderEntries(who);
                    });
                });
            }).catch(function() {});
        });
    }

    // ===== PERSISTENCE =====
    function saveDevData() {
        var data = { devLog: devLog, avatars: avatars };
        localStorage.setItem('devDashboard', JSON.stringify(data));
        // Also save to server
        fetch(API_URL + '/api/dev-dashboard', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).catch(function() {});
    }

    function loadDevData() {
        try {
            var saved = JSON.parse(localStorage.getItem('devDashboard'));
            if (saved) {
                if (saved.devLog) devLog = saved.devLog;
                if (saved.avatars) avatars = saved.avatars;
            }
        } catch(e) {}
    }

    function loadFromServer() {
        fetch(API_URL + '/api/dev-dashboard').then(function(r) { return r.json(); }).then(function(data) {
            if (data && data.devLog) {
                // Merge server data with local
                ['DL','TJ','VL'].forEach(function(who) {
                    if (data.devLog[who]) {
                        data.devLog[who].forEach(function(entry) {
                            var exists = devLog[who].some(function(e) {
                                return (e.sha && e.sha === entry.sha) || (e.time === entry.time && e.message === entry.message);
                            });
                            if (!exists) devLog[who].push(entry);
                        });
                    }
                });
                if (data.avatars) {
                    ['DL','TJ','VL'].forEach(function(w) {
                        if (data.avatars[w] && !avatars[w]) avatars[w] = data.avatars[w];
                    });
                }
                saveDevData();
                renderAll();
            }
        }).catch(function() {});
    }

    // ===== WEBSOCKET =====
    function connectWS() {
        ws = new WebSocket(WS_URL);
        ws.onopen = function() {
            document.getElementById('syncDot').classList.remove('offline');
            document.getElementById('syncText').textContent = 'Connect\u00e9';
        };
        ws.onmessage = function(e) {
            try {
                var msg = JSON.parse(e.data);
                if (msg.type === 'dev-dashboard-update') {
                    if (msg.data && msg.data.devLog) {
                        ['DL','TJ','VL'].forEach(function(who) {
                            if (msg.data.devLog[who]) {
                                msg.data.devLog[who].forEach(function(entry) {
                                    var exists = devLog[who].some(function(e2) {
                                        return (e2.sha && e2.sha === entry.sha) || (e2.time === entry.time && e2.message === entry.message);
                                    });
                                    if (!exists) devLog[who].push(entry);
                                });
                            }
                        });
                        saveDevData();
                        renderAll();
                    }
                }
            } catch(err) {}
        };
        ws.onclose = function() {
            document.getElementById('syncDot').classList.add('offline');
            document.getElementById('syncText').textContent = 'D\u00e9connect\u00e9';
            setTimeout(connectWS, 3000);
        };
        ws.onerror = function() { ws.close(); };
    }

    function broadcastDevLog() {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'dev-dashboard-update', data: { devLog: devLog, avatars: avatars } }));
        }
    }

    // ===== REFRESH =====
    function refreshAll() {
        fetchGitHubCommits();
        loadFromServer();
    }

    // ===== ADD CLAUDE ENTRY (callable from outside) =====
    function addClaudeEntry(who, message, files) {
        devLog[who || 'VL'].push({
            type: 'claude',
            message: message,
            time: new Date().toISOString(),
            files: files || []
        });
        saveDevData();
        renderAll();
        broadcastDevLog();
    }

    // ===== LOAD PHOTOS FROM CONTACTS =====
    var DEV_NAMES = {
        DL: ['david lang'],
        TJ: ['thomas jumentier'],
        VL: ['vincent lezenes', 'vincent lezÃ¨ne', 'vincent lÃ©zÃ©nÃ¨s']
    };

    function loadContactPhotos() {
        fetch('contacts.json').then(function(r) { return r.json(); }).then(function(data) {
            data.forEach(function(c) {
                var fullName = (c.firstName + ' ' + c.lastName).toLowerCase();
                ['DL','TJ','VL'].forEach(function(who) {
                    DEV_NAMES[who].forEach(function(name) {
                        if (fullName === name && c.photo && c.photo.length > 10 && !avatars[who]) {
                            avatars[who] = c.photo;
                            document.getElementById('avatar' + who).innerHTML = '<img src="' + avatars[who] + '"><input type="file" id="photo' + who + '" accept="image/*" onchange="uploadAvatar(\'' + who + '\',this)">';
                        }
                    });
                });
            });
        }).catch(function(e) { console.log('Contacts photo load error:', e); });
    }

    // ===== INIT =====
    loadDevData();
    renderAll();
    connectWS();
    loadFromServer();
    loadContactPhotos();
    setTimeout(fetchGitHubCommits, 1000);
    setInterval(refreshAll, 300000);
    </script>
</body>
</html>
