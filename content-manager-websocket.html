<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cr√©ation - Overlay eCamm</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #1a1a2e;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2rem;
            margin: 0;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-btn.active {
            background: #1a1a2e;
            color: white;
        }

        .nav-btn.inactive {
            background: white;
            color: #667eea;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: #16213e;
            border-bottom: 1px solid #0f3460;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #e4e4e4;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-connected {
            background: #00ff00;
        }

        .status-disconnected {
            background: #ff0000;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .content {
            padding: 40px;
            color: #e4e4e4;
        }

        .main-fields {
            margin-bottom: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 1rem;
            color: #b8c1ec;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #0f3460;
            border-radius: 10px;
            font-size: 1rem;
            background: #16213e;
            color: #e4e4e4;
            transition: all 0.3s;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .columns-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .column-section {
            background: linear-gradient(135deg, #2a2a3e 0%, #1f1f2e 100%);
            border: 1px solid #0f3460;
            border-radius: 15px;
            padding: 20px;
        }

        .column-section h3 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: -20px -20px 20px -20px;
            padding: 15px 20px;
            font-size: 1.2rem;
            text-align: center;
            border-radius: 15px 15px 0 0;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .column-section textarea {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            resize: vertical;
        }

        .char-counter {
            font-size: 0.85rem;
            color: #8b92a8;
            margin-top: 5px;
            text-align: right;
        }

        .char-counter.warning {
            color: #ffa500;
        }

        .char-counter.error {
            color: #ff0000;
        }

        .submit-section {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #16213e;
            color: #e4e4e4;
            border: 2px solid #0f3460;
        }

        .btn-secondary:hover {
            background: #0f3460;
        }

        .success-message {
            padding: 15px;
            background: rgba(0, 255, 0, 0.1);
            border: 2px solid #00ff00;
            border-radius: 10px;
            color: #00ff00;
            margin-top: 20px;
            display: none;
            text-align: center;
        }

        .helper-text {
            font-size: 0.85rem;
            color: #8b92a8;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>üöÄ Cr√©ation d'Overlay</h1>
                <div class="nav-buttons">
                    <a href="content-manager-websocket.html" class="nav-btn active">
                        üöÄ Cr√©ation
                    </a>
                    <a href="content-management-p1-p4.html" class="nav-btn inactive">
                        üìù Manage
                    </a>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot status-disconnected" id="statusDot"></div>
                <span id="statusText">Connexion...</span>
            </div>
            <div>
                <small id="lastUpdate" style="color: #8b92a8;">Jamais envoy√©</small>
            </div>
        </div>

        <div class="content">
            <form id="overlayForm">
                <!-- Champs principaux -->
                <div class="main-fields">
                    <div class="form-group">
                        <label for="titre">üìå TITRE</label>
                        <input type="text" id="titre" required>
                    </div>

                    <div class="form-group">
                        <label for="soustitre">üìÑ Sous-titre</label>
                        <input type="text" id="soustitre">
                    </div>
                </div>

                <!-- 4 colonnes -->
                <div class="columns-grid">
                    <!-- Colonne P1 -->
                    <div class="column-section">
                        <h3>P1</h3>
                        <div class="form-group">
                            <label for="p1_sujet">Sujet</label>
                            <input type="text" id="p1_sujet" maxlength="15">
                            <div class="char-counter" id="counter_p1_sujet">0 / 15</div>
                        </div>
                        <div class="form-group">
                            <label for="p1_contenu">Contenu</label>
                            <textarea id="p1_contenu" placeholder=""></textarea>
                        </div>
                    </div>

                    <!-- Colonne P2 -->
                    <div class="column-section">
                        <h3>P2</h3>
                        <div class="form-group">
                            <label for="p2_sujet">Sujet</label>
                            <input type="text" id="p2_sujet" maxlength="15">
                            <div class="char-counter" id="counter_p2_sujet">0 / 15</div>
                        </div>
                        <div class="form-group">
                            <label for="p2_contenu">Contenu</label>
                            <textarea id="p2_contenu" placeholder=""></textarea>
                        </div>
                    </div>

                    <!-- Colonne P3 -->
                    <div class="column-section">
                        <h3>P3</h3>
                        <div class="form-group">
                            <label for="p3_sujet">Sujet</label>
                            <input type="text" id="p3_sujet" maxlength="15">
                            <div class="char-counter" id="counter_p3_sujet">0 / 15</div>
                        </div>
                        <div class="form-group">
                            <label for="p3_contenu">Contenu</label>
                            <textarea id="p3_contenu" placeholder=""></textarea>
                        </div>
                    </div>

                    <!-- Colonne P4 -->
                    <div class="column-section">
                        <h3>P4</h3>
                        <div class="form-group">
                            <label for="p4_sujet">Sujet</label>
                            <input type="text" id="p4_sujet" maxlength="15">
                            <div class="char-counter" id="counter_p4_sujet">0 / 15</div>
                        </div>
                        <div class="form-group">
                            <label for="p4_contenu">Contenu</label>
                            <textarea id="p4_contenu" placeholder=""></textarea>
                        </div>
                    </div>
                </div>

                <!-- Boutons -->
                <div class="submit-section">
                    <button type="submit" class="btn btn-primary" id="sendBtn" disabled>
                        üöÄ Envoyer √† l'Overlay
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearForm()">
                        üóëÔ∏è Effacer tout
                    </button>
                </div>

                <div class="success-message" id="successMsg">
                    ‚úÖ Donn√©es envoy√©es avec succ√®s √† l'overlay !
                </div>
            </form>
        </div>
    </div>

    <script>
        const WS_URL = 'wss://ecamm-overlay-server.onrender.com';
        let ws = null;

        // Connexion WebSocket
        function connect() {
            try {
                updateStatus('connecting', 'Connexion...');
                ws = new WebSocket(WS_URL);

                ws.onopen = () => {
                    console.log('‚úì Connect√© au serveur');
                    updateStatus('connected', 'Connect√© au serveur');
                };

                ws.onerror = (error) => {
                    console.error('Erreur WebSocket:', error);
                    updateStatus('disconnected', 'Erreur de connexion');
                };

                ws.onclose = () => {
                    updateStatus('disconnected', 'D√©connect√© - Reconnexion dans 3s...');
                    setTimeout(connect, 3000);
                };
            } catch (error) {
                updateStatus('disconnected', 'Erreur: ' + error.message);
                setTimeout(connect, 3000);
            }
        }

        function updateStatus(status, message) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            const sendBtn = document.getElementById('sendBtn');
            
            dot.className = 'status-dot status-' + status;
            text.textContent = message;
            sendBtn.disabled = (status !== 'connected');
        }

        // Compteurs de caract√®res pour les sujets
        ['p1_sujet', 'p2_sujet', 'p3_sujet', 'p4_sujet'].forEach(id => {
            const input = document.getElementById(id);
            input.addEventListener('input', function() {
                const counter = document.getElementById('counter_' + id);
                const length = this.value.length;
                counter.textContent = `${length} / 15`;
                counter.className = 'char-counter';
                if (length > 12) counter.classList.add('warning');
                if (length === 15) counter.classList.add('error');
            });
        });

        // Validation des textareas (7 lignes, 18 caract√®res max par ligne, pas de coupure de mots)
        ['p1_contenu', 'p2_contenu', 'p3_contenu', 'p4_contenu'].forEach(id => {
            const textarea = document.getElementById(id);
            textarea.addEventListener('input', function() {
                let text = this.value;
                let lines = [];
                let words = text.split(/(\s+)/); // Garde les espaces
                let currentLine = '';
                
                for (let word of words) {
                    // Si c'est un retour √† la ligne manuel
                    if (word.includes('\n')) {
                        let parts = word.split('\n');
                        for (let i = 0; i < parts.length; i++) {
                            if (i > 0) {
                                lines.push(currentLine);
                                currentLine = '';
                            }
                            if (parts[i]) {
                                if ((currentLine + parts[i]).length <= 18) {
                                    currentLine += parts[i];
                                } else if (currentLine) {
                                    lines.push(currentLine);
                                    currentLine = parts[i].substring(0, 18);
                                } else {
                                    currentLine = parts[i].substring(0, 18);
                                }
                            }
                        }
                        continue;
                    }
                    
                    // Tester si on peut ajouter le mot √† la ligne actuelle
                    if ((currentLine + word).length <= 18) {
                        currentLine += word;
                    } else {
                        // Le mot ne rentre pas
                        if (currentLine.trim()) {
                            lines.push(currentLine);
                        }
                        // Si le mot seul est trop long, le couper
                        if (word.trim().length > 18) {
                            currentLine = word.trim().substring(0, 18);
                        } else {
                            // Supprimer les espaces en d√©but de mot pour l'alignement
                            currentLine = word.trimStart();
                        }
                    }
                }
                
                // Ajouter la derni√®re ligne
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                // Limiter √† 7 lignes
                if (lines.length > 7) {
                    lines = lines.slice(0, 7);
                }
                
                // Mettre √† jour le textarea
                this.value = lines.join('\n');
            });
        });

        // Soumission du formulaire
        document.getElementById('overlayForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('‚ùå Non connect√© au serveur WebSocket !');
                return;
            }

            // R√©cup√©rer les donn√©es
            const data = {
                titre: document.getElementById('titre').value,
                soustitre: document.getElementById('soustitre').value,
                p1: {
                    sujet: document.getElementById('p1_sujet').value,
                    contenu: document.getElementById('p1_contenu').value.split('\n')
                },
                p2: {
                    sujet: document.getElementById('p2_sujet').value,
                    contenu: document.getElementById('p2_contenu').value.split('\n')
                },
                p3: {
                    sujet: document.getElementById('p3_sujet').value,
                    contenu: document.getElementById('p3_contenu').value.split('\n')
                },
                p4: {
                    sujet: document.getElementById('p4_sujet').value,
                    contenu: document.getElementById('p4_contenu').value.split('\n')
                }
            };

            // Envoyer via WebSocket
            const message = {
                type: 'update',
                data: data
            };

            ws.send(JSON.stringify(message));
            
            // AUSSI sauvegarder dans localStorage pour la page Manage
            try {
                const manageData = {
                    id: 'local-' + Date.now(),
                    title: data.titre || '',
                    subtitle: data.soustitre || '',
                    p1_line1: (data.p1.contenu && data.p1.contenu[0]) ? data.p1.contenu[0] : '',
                    p1_line2: (data.p1.contenu && data.p1.contenu[1]) ? data.p1.contenu[1] : '',
                    p2_line3: (data.p2.contenu && data.p2.contenu[0]) ? data.p2.contenu[0] : '',
                    p2_line4: (data.p2.contenu && data.p2.contenu[1]) ? data.p2.contenu[1] : '',
                    p3_line5: (data.p3.contenu && data.p3.contenu[0]) ? data.p3.contenu[0] : '',
                    p3_line6: (data.p3.contenu && data.p3.contenu[1]) ? data.p3.contenu[1] : '',
                    p4_line7: (data.p4.contenu && data.p4.contenu[0]) ? data.p4.contenu[0] : '',
                    p4_line8: (data.p4.contenu && data.p4.contenu[1]) ? data.p4.contenu[1] : '',
                    timestamp: new Date().toLocaleString(),
                    source: 'creation'
                };
                
                // Charger l'historique existant
                let history = [];
                try {
                    const existingHistory = localStorage.getItem('overlay_content_history');
                    if (existingHistory) {
                        history = JSON.parse(existingHistory);
                    }
                } catch (e) {
                    console.log('Pas d\'historique existant');
                }
                
                // Ajouter au d√©but de l'historique
                history.unshift(manageData);
                
                // Limiter √† 50 √©l√©ments
                if (history.length > 50) {
                    history = history.slice(0, 50);
                }
                
                localStorage.setItem('overlay_content_history', JSON.stringify(history));
                console.log('üíæ Donn√©es sauvegard√©es dans localStorage (historique:', history.length, '√©l√©ments)');
            } catch (storageError) {
                console.error('Erreur localStorage:', storageError);
            }
            
            // Afficher le message de succ√®s
            const successMsg = document.getElementById('successMsg');
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);

            // Mettre √† jour la date
            document.getElementById('lastUpdate').textContent = 
                'Dernier envoi: ' + new Date().toLocaleTimeString();
            
            console.log('‚úì Donn√©es envoy√©es:', data);
        });

        function clearForm() {
            if (confirm('√ätes-vous s√ªr de vouloir tout effacer ?')) {
                document.getElementById('overlayForm').reset();
                // R√©initialiser les compteurs
                ['p1_sujet', 'p2_sujet', 'p3_sujet', 'p4_sujet'].forEach(id => {
                    document.getElementById('counter_' + id).textContent = '0 / 15';
                    document.getElementById('counter_' + id).className = 'char-counter';
                });
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            connect();
        });
    </script>
</body>
</html>
