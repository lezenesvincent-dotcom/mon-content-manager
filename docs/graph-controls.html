<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contr√¥les Graphique 3D - VORANGE</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 20px;
            overflow-y: auto;
        }
        h1 { text-align: center; margin-bottom: 30px; font-size: 32px; }
        .top-buttons {
            max-width: 1600px;
            margin: 0 auto 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .top-btn {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid;
        }
        .apply-btn {
            background: rgba(100, 255, 100, 0.3);
            border-color: #4ade80;
            color: white;
        }
        .apply-btn:hover {
            background: rgba(100, 255, 100, 0.5);
            transform: scale(1.05);
        }
        .reset-all-btn {
            background: rgba(255, 50, 50, 0.3);
            border-color: #ff4444;
            color: white;
        }
        .reset-all-btn:hover {
            background: rgba(255, 50, 50, 0.5);
            transform: scale(1.05);
        }
        .controllers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            max-width: 1600px;
            margin: 0 auto;
        }
        .controller {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 12px;
            padding: 12px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .controller h3 {
            margin: 0 0 12px 0;
            font-size: 15px;
            text-align: center;
            color: #4ade80;
        }
        .joystick-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .joystick-row {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        .joystick-btn {
            width: 42px;
            height: 42px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .joystick-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }
        .joystick-btn:active {
            transform: scale(0.95);
        }
        .reset-btn {
            margin-top: 8px;
            width: 100%;
            padding: 8px;
            background: rgba(255, 100, 100, 0.8);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 13px;
        }
        .reset-btn:hover {
            background: rgba(255, 100, 100, 1);
        }
        .info-display {
            margin-top: 8px;
            font-size: 11px;
            text-align: center;
            opacity: 0.7;
        }
        .status {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            opacity: 0.8;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            max-width: 600px;
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <h1>üéÆ Contr√¥les Graphique 3D - VORANGE</h1>
    
    <div class="top-buttons">
        <button class="top-btn apply-btn" onclick="applySettings()">‚úì Appliquer & Sauvegarder</button>
        <button class="top-btn reset-all-btn" onclick="clearStorageAndReload()">üóëÔ∏è Reset Tout</button>
    </div>

    <div class="controllers-grid" id="controllersContainer">
        <!-- Les contr√¥leurs seront inject√©s ici -->
    </div>

    <div class="status" id="status">
        üîÑ Chargement...
    </div>

    <script>
        const WS_URL = 'wss://ecamm-overlay-server.onrender.com';
        let ws = null;
        const STEP = 0.5;

        // Variables
        let cameraOffset = { x: 0, y: 5, z: 32 };
        let cameraAngle = { horizontal: 0, vertical: -20 };
        let graphMeshOffset = { x: 0, y: 0, z: 0 };
        let lightPosition = { x: 5, y: 10, z: 7 };
        let lightIntensity = 0.6;
        let labelsXOffset = { x: 0, y: 0 };
        let labelsYOffset = { x: 0, y: 0 };
        let barreRougeOffset = { x: 0, y: -7.5, z: 0 };
        let barreRougeIntensity = 1.5;
        let barreRougeSize = { width: 9, height: 0.325, depth: 8 };
        let graphWidth = 100;
        let fontSizeLabelsX = 100;
        let fontSizeLabelsY = 128;
        let labelsXSpacing = 1.0;
        let linesOffset = { x: 0, y: 0, z: 0 };
        let linesRightExtension = 0;
        let graphShadowSize = 35;
        let graphShadowDistance = -6.45;
        let graphShadowPosition = { x: 0, z: 0 };
        let barreShadowSize = 15;
        let barreShadowDistance = -6.4;
        let barreShadowPosition = { x: 0, z: 0 };

        // Injecter le HTML des contr√¥leurs
        document.getElementById('controllersContainer').innerHTML = `
            <!-- Contr√¥leur Cam√©ra Position -->
            <div class="controller">
                <h3>üìπ Position Cam√©ra</h3>
                <div class="joystick-container">
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveCamera('up')">‚Üë</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveCamera('left')">‚Üê</button>
                        <button class="joystick-btn" onclick="moveCamera('center')">‚óè</button>
                        <button class="joystick-btn" onclick="moveCamera('right')">‚Üí</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveCamera('down')">‚Üì</button>
                    </div>
                    <button class="reset-btn" onclick="resetCamera()">Reset Position</button>
                    <div class="info-display" id="cameraInfo">X:0 Y:5 Z:32</div>
                </div>
            </div>

            <!-- Contr√¥leur Angle Cam√©ra -->
            <div class="controller">
                <h3>üéØ Angle Cam√©ra</h3>
                <div class="joystick-container">
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="rotateCamera('up')" title="Plong√©e (regarder vers le bas)">‚ñ≤</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="rotateCamera('left')" title="Tourner √† gauche">‚óÄ</button>
                        <button class="joystick-btn" onclick="rotateCamera('center')">‚óè</button>
                        <button class="joystick-btn" onclick="rotateCamera('right')" title="Tourner √† droite">‚ñ∂</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="rotateCamera('down')" title="Contre-plong√©e (regarder vers le haut)">‚ñº</button>
                    </div>
                    <button class="reset-btn" onclick="resetCameraAngle()">Reset Angle</button>
                    <div class="info-display" id="angleInfo">H:0¬∞ V:-20¬∞</div>
                </div>
            </div>

            <!-- Contr√¥leur Graphique -->
            <div class="controller">
                <h3>üìä Graphique XY</h3>
                <div class="joystick-container">
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveGraph('up')">‚Üë</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveGraph('left')">‚Üê</button>
                        <button class="joystick-btn" onclick="moveGraph('center')">‚óè</button>
                        <button class="joystick-btn" onclick="moveGraph('right')">‚Üí</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveGraph('down')">‚Üì</button>
                    </div>
                    <div class="joystick-row" style="margin-top: 10px;">
                        <button class="joystick-btn" onclick="adjustGraphWidth('decrease')" title="R√©duire largeur">‚¨ÖÔ∏è</button>
                        <button class="joystick-btn" onclick="adjustGraphWidth('increase')" title="Augmenter largeur">‚û°Ô∏è</button>
                    </div>
                    <button class="reset-btn" onclick="resetGraph()">Reset</button>
                    <div class="info-display" id="graphInfo">X:0 Y:0 Z:0</div>
                    <div class="info-display" id="graphWidthInfo" style="margin-top: 5px;">L:100</div>
                </div>
            </div>

            <!-- Contr√¥leur Profondeur Graphique (Z) -->
            <div class="controller">
                <h3>üìä Profondeur (Z)</h3>
                <div class="joystick-container">
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveGraph('forward')" title="Rapprocher">‚¨ÜÔ∏è</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveGraph('center')">‚óè</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveGraph('backward')" title="√âloigner">‚¨áÔ∏è</button>
                    </div>
                    <button class="reset-btn" onclick="resetGraph()">Reset</button>
                    <div class="info-display" id="graphZInfo">Z:0</div>
                </div>
            </div>

            <!-- Contr√¥leur Lumi√®re UNIFI√â (Position XYZ + Intensit√©) -->
            <div class="controller">
                <h3>üí° Lumi√®re Compl√®te</h3>
                <div class="joystick-container">
                    <!-- Position XY -->
                    <div style="font-size: 10px; opacity: 0.6; text-align: center; margin-bottom: 5px;">Position XY</div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveLight('up')">‚Üë</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveLight('left')">‚Üê</button>
                        <button class="joystick-btn" onclick="moveLight('center')">‚óè</button>
                        <button class="joystick-btn" onclick="moveLight('right')">‚Üí</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveLight('down')">‚Üì</button>
                    </div>
                    
                    <!-- Profondeur Z -->
                    <div style="font-size: 10px; opacity: 0.6; text-align: center; margin: 10px 0 5px 0;">Profondeur Z</div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveLight('forward')" title="Rapprocher" style="font-size: 20px;">‚¨ÜÔ∏è</button>
                        <button class="joystick-btn" onclick="moveLight('backward')" title="√âloigner" style="font-size: 20px;">‚¨áÔ∏è</button>
                    </div>
                    
                    <!-- Intensit√© -->
                    <div style="font-size: 10px; opacity: 0.6; text-align: center; margin: 10px 0 5px 0;">Intensit√©</div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="adjustIntensity('up')" style="font-size: 24px;">‚òÄÔ∏è</button>
                        <button class="joystick-btn" onclick="adjustIntensity('down')" style="font-size: 24px;">üåô</button>
                    </div>
                    
                    <button class="reset-btn" onclick="resetLight()">Reset Tout</button>
                    <div class="info-display" id="lightInfo">X:5 Y:10 Z:7</div>
                    <div class="info-display" id="intensityInfo" style="margin-top: 3px;">üí° 60%</div>
                </div>
            </div>

            <!-- Contr√¥leur Labels X (ann√©es) -->
            <div class="controller">
                <h3>üè∑Ô∏è Labels X</h3>
                <div class="joystick-container">
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveLabels_Annees('up')">‚Üë</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveLabels_Annees('left')">‚Üê</button>
                        <button class="joystick-btn" onclick="moveLabels_Annees('center')">‚óè</button>
                        <button class="joystick-btn" onclick="moveLabels_Annees('right')">‚Üí</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveLabels_Annees('down')">‚Üì</button>
                    </div>
                    <div class="joystick-row" style="margin-top: 10px;">
                        <button class="joystick-btn" onclick="adjustFontSizeX('down')" title="R√©duire police">üÖ∞Ô∏è‚àí</button>
                        <button class="joystick-btn" onclick="adjustFontSizeX('up')" title="Augmenter police">üÖ∞Ô∏è+</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="adjustLabelsXSpacing('down')" title="R√©duire espacement">‚ÜîÔ∏è‚àí</button>
                        <button class="joystick-btn" onclick="adjustLabelsXSpacing('up')" title="Augmenter espacement">‚ÜîÔ∏è+</button>
                    </div>
                    <button class="reset-btn" onclick="resetLabels()">Reset</button>
                    <div class="info-display" id="labelsXInfo">X:0.0 Y:0.0</div>
                    <div class="info-display" id="fontSizeXInfo" style="margin-top: 5px;">100px</div>
                    <div class="info-display" id="labelsXSpacingInfo" style="margin-top: 5px;">100%</div>
                </div>
            </div>

            <!-- Contr√¥leur Labels Y (prix) -->
            <div class="controller">
                <h3>üè∑Ô∏è Labels Y</h3>
                <div class="joystick-container">
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveLabels_Prix('up')">‚Üë</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveLabels_Prix('left')">‚Üê</button>
                        <button class="joystick-btn" onclick="moveLabels_Prix('center')">‚óè</button>
                        <button class="joystick-btn" onclick="moveLabels_Prix('right')">‚Üí</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveLabels_Prix('down')">‚Üì</button>
                    </div>
                    <div class="joystick-row" style="margin-top: 10px;">
                        <button class="joystick-btn" onclick="adjustFontSizeY('down')" title="R√©duire police">üÖ∞Ô∏è‚àí</button>
                        <button class="joystick-btn" onclick="adjustFontSizeY('up')" title="Augmenter police">üÖ∞Ô∏è+</button>
                    </div>
                    <button class="reset-btn" onclick="resetLabels()">Reset</button>
                    <div class="info-display" id="labelsYInfo">X:0.0 Y:0.0</div>
                    <div class="info-display" id="fontSizeYInfo" style="margin-top: 5px;">128px</div>
                </div>
            </div>

            <!-- Contr√¥leur Barre Rouge (Valorisation) -->
            <div class="controller">
                <h3>üî¥ Barre Rouge</h3>
                <div class="joystick-container">
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveBarreRouge('up')">‚Üë</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveBarreRouge('left')">‚Üê</button>
                        <button class="joystick-btn" onclick="moveBarreRouge('center')">‚óè</button>
                        <button class="joystick-btn" onclick="moveBarreRouge('right')">‚Üí</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveBarreRouge('down')">‚Üì</button>
                    </div>
                    <div class="joystick-row" style="margin-top: 10px;">
                        <button class="joystick-btn" onclick="moveBarreRouge('forward')" title="Rapprocher">‚¨ÜÔ∏è</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveBarreRouge('backward')" title="√âloigner">‚¨áÔ∏è</button>
                    </div>
                    <div class="joystick-row" style="margin-top: 15px; gap: 10px;">
                        <button class="joystick-btn" onclick="adjustBarreRougeIntensity('decrease')" title="Moins lumineux">üí°-</button>
                        <button class="joystick-btn" onclick="adjustBarreRougeIntensity('increase')" title="Plus lumineux">üí°+</button>
                    </div>
                    <div class="joystick-row" style="margin-top: 10px; gap: 10px;">
                        <button class="joystick-btn" onclick="adjustBarreRougeSize('width', 'decrease')" title="R√©duire largeur">‚¨ÖÔ∏è</button>
                        <button class="joystick-btn" onclick="adjustBarreRougeSize('width', 'increase')" title="Augmenter largeur">‚û°Ô∏è</button>
                    </div>
                    <div class="joystick-row" style="margin-top: 5px; gap: 10px;">
                        <button class="joystick-btn" onclick="adjustBarreRougeSize('height', 'decrease')" title="R√©duire hauteur">‚¨áÔ∏è</button>
                        <button class="joystick-btn" onclick="adjustBarreRougeSize('height', 'increase')" title="Augmenter hauteur">‚¨ÜÔ∏è</button>
                    </div>
                    <div class="joystick-row" style="margin-top: 5px; gap: 10px;">
                        <button class="joystick-btn" onclick="adjustBarreRougeSize('depth', 'decrease')" title="R√©duire profondeur">üì¶-</button>
                        <button class="joystick-btn" onclick="adjustBarreRougeSize('depth', 'increase')" title="Augmenter profondeur">üì¶+</button>
                    </div>
                    <div class="joystick-row" style="margin-top: 5px; gap: 10px;">
                        <button class="joystick-btn" onclick="adjustBarreRougeSize('roundness', 'decrease')" title="Moins arrondi">‚óªÔ∏è</button>
                        <button class="joystick-btn" onclick="adjustBarreRougeSize('roundness', 'increase')" title="Plus arrondi">‚¨≠</button>
                    </div>
                    <button class="reset-btn" onclick="resetBarreRouge()">Reset</button>
                    <div class="info-display" id="barreRougeInfo">X:0.0 Y:-7.5 Z:0.0 üí°:1.5</div>
                    <div class="info-display" id="barreRougeSizeInfo" style="margin-top: 5px;">L:9 H:0.3 P:8</div>
                    <div class="info-display" id="barreRougeRoundInfo" style="margin-top: 5px;">‚¨≠:0.2</div>
                </div>
            </div>

            <!-- Contr√¥leur Ombre Graph -->
            <div class="controller">
                <h3>üåë Ombre Graph</h3>
                <div class="joystick-container">
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveGraphShadow('up')" title="D√©placer vers le haut">‚Üë</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveGraphShadow('left')" title="D√©placer vers la gauche">‚Üê</button>
                        <button class="joystick-btn" onclick="moveGraphShadow('center')" title="Centrer">‚óè</button>
                        <button class="joystick-btn" onclick="moveGraphShadow('right')" title="D√©placer vers la droite">‚Üí</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveGraphShadow('down')" title="D√©placer vers le bas">‚Üì</button>
                    </div>
                    <div class="joystick-row" style="margin-top: 8px; gap: 5px;">
                        <button class="joystick-btn" onclick="adjustGraphShadow('size', 'decrease')" title="R√©duire taille">üìè-</button>
                        <button class="joystick-btn" onclick="adjustGraphShadow('size', 'increase')" title="Augmenter taille">üìè+</button>
                    </div>
                    <div class="joystick-row" style="margin-top: 5px; gap: 5px;">
                        <button class="joystick-btn" onclick="adjustGraphShadow('distance', 'decrease')" title="Rapprocher">üìç-</button>
                        <button class="joystick-btn" onclick="adjustGraphShadow('distance', 'increase')" title="√âloigner">üìç+</button>
                    </div>
                    <button class="reset-btn" onclick="resetGraphShadow()">Reset</button>
                    <div class="info-display" id="graphShadowInfo">X:0 Z:0 üìè:35 üìç:-6.5</div>
                </div>
            </div>

            <!-- Contr√¥leur Ombre Barre Rouge -->
            <div class="controller">
                <h3>üåë Ombre Barre</h3>
                <div class="joystick-container">
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveBarreShadow('up')" title="D√©placer vers le haut">‚Üë</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveBarreShadow('left')" title="D√©placer vers la gauche">‚Üê</button>
                        <button class="joystick-btn" onclick="moveBarreShadow('center')" title="Centrer">‚óè</button>
                        <button class="joystick-btn" onclick="moveBarreShadow('right')" title="D√©placer vers la droite">‚Üí</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveBarreShadow('down')" title="D√©placer vers le bas">‚Üì</button>
                    </div>
                    <div class="joystick-row" style="margin-top: 8px; gap: 5px;">
                        <button class="joystick-btn" onclick="adjustBarreShadow('size', 'decrease')" title="R√©duire taille">üìè-</button>
                        <button class="joystick-btn" onclick="adjustBarreShadow('size', 'increase')" title="Augmenter taille">üìè+</button>
                    </div>
                    <div class="joystick-row" style="margin-top: 5px; gap: 5px;">
                        <button class="joystick-btn" onclick="adjustBarreShadow('distance', 'decrease')" title="Rapprocher">üìç-</button>
                        <button class="joystick-btn" onclick="adjustBarreShadow('distance', 'increase')" title="√âloigner">üìç+</button>
                    </div>
                    <button class="reset-btn" onclick="resetBarreShadow()">Reset</button>
                    <div class="info-display" id="barreShadowInfo">X:0 Z:0 üìè:15 üìç:-6.4</div>
                </div>
            </div>

            <!-- Contr√¥leur Lignes Horizontales -->
            <div class="controller">
                <h3>üìè Lignes Fond</h3>
                <div class="joystick-container">
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveLinesHorizontales('up')">‚Üë</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveLinesHorizontales('left')">‚Üê</button>
                        <button class="joystick-btn" onclick="moveLinesHorizontales('center')">‚óè</button>
                        <button class="joystick-btn" onclick="moveLinesHorizontales('right')">‚Üí</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveLinesHorizontales('down')">‚Üì</button>
                    </div>
                    <div class="joystick-row" style="margin-top: 10px;">
                        <button class="joystick-btn" onclick="moveLinesHorizontales('forward')" title="Rapprocher">‚¨ÜÔ∏è</button>
                    </div>
                    <div class="joystick-row">
                        <button class="joystick-btn" onclick="moveLinesHorizontales('backward')" title="√âloigner">‚¨áÔ∏è</button>
                    </div>
                    <div class="joystick-row" style="margin-top: 10px;">
                        <button class="joystick-btn" onclick="adjustLinesExtension('down')" title="R√©duire extension">‚ûñ</button>
                        <button class="joystick-btn" onclick="adjustLinesExtension('up')" title="Augmenter extension">‚ûï</button>
                    </div>
                    <button class="reset-btn" onclick="resetLinesHorizontales()">Reset</button>
                    <div class="info-display" id="linesInfo">X:0.0 Y:0.0 Z:0.0</div>
                    <div class="info-display" id="linesExtensionInfo" style="margin-top: 5px;">Ext: 0</div>
                </div>
            </div>
            
            <!-- Contr√¥leur D√©grad√© -->
            <div class="controller">
                <h3>üé® D√©grad√©</h3>
                <div class="joystick-container">
                    <div class="joystick-row" style="flex-direction: column; gap: 10px;">
                        <div style="display: flex; flex-direction: column; gap: 5px; width: 100%; margin-top: 5px;">
                            <label style="font-size: 11px; text-align: center;">D√©grad√© opacit√©: <span id="gradientOpacityPercentage">100%</span></label>
                            <input type="range" id="gradientOpacitySlider" min="0" max="100" value="100" 
                                   style="width: 100%;" 
                                   oninput="adjustGradientOpacityFromSlider()">
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px; width: 100%; margin-top: 10px;">
                            <label style="font-size: 11px; text-align: center;">Chapeau opacit√©: <span id="capOpacityPercentage">100%</span></label>
                            <input type="range" id="capOpacitySlider" min="0" max="100" value="100" 
                                   style="width: 100%;" 
                                   oninput="adjustCapOpacityFromSlider()">
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 12px; width: 70px;">Haut:</span>
                                <input type="color" id="colorTopPicker" value="#ffa500" style="width: 60px; height: 40px; border: none; cursor: pointer; border-radius: 5px;" onchange="syncColorFromPicker('top')">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 12px; width: 70px;">Bas:</span>
                                <input type="color" id="colorBottomPicker" value="#ffb380" style="width: 60px; height: 40px; border: none; cursor: pointer; border-radius: 5px;" onchange="syncColorFromPicker('bottom')">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 12px; width: 70px;">Face haute:</span>
                                <input type="color" id="topFaceColorPicker" value="#cccccc" style="width: 60px; height: 40px; border: none; cursor: pointer; border-radius: 5px;" onchange="syncTopFaceColorFromPicker()">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 12px; width: 70px;">Barre üî¥:</span>
                                <input type="color" id="barreColorPicker" value="#cc0000" style="width: 60px; height: 40px; border: none; cursor: pointer; border-radius: 5px;" onchange="syncBarreColorFromPicker()">
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 3px; width: 100%; margin-top: 10px;">
                                <label style="font-size: 10px; text-align: center;">Zone transition: <span id="transitionPercent">50%</span></label>
                                <input type="range" id="transitionSlider" min="0" max="100" value="50" 
                                       style="width: 100%;" 
                                       oninput="adjustGradientTransition()">
                                <div style="font-size: 9px; color: rgba(255,255,255,0.6); text-align: center; margin-top: 3px;">
                                    Couleurs: 0%=bas, 100%=haut
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 3px; width: 100%; margin-top: 10px;">
                                <label style="font-size: 10px; text-align: center;">Zone opacit√©: <span id="opacityTransitionPercent">50%</span></label>
                                <input type="range" id="opacityTransitionSlider" min="0" max="100" value="50" 
                                       style="width: 100%;" 
                                       oninput="adjustOpacityTransition()">
                                <div style="font-size: 9px; color: rgba(255,255,255,0.6); text-align: center; margin-top: 3px;">
                                    Opacit√©: 0%=bas, 100%=haut
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="reset-btn" onclick="resetGradient()">Reset</button>
                </div>
            </div>
        `;

        // Fonctions principales
        async function loadSettings() {
            try {
                const response = await fetch(`${WS_URL.replace('wss:', 'https:')}/api/graph`);
                const settings = await response.json();
                applyLoadedSettings(settings);
                updateAllDisplays();
                document.getElementById('status').textContent = '‚úÖ Param√®tres charg√©s';
            } catch(error) {
                const saved = localStorage.getItem('graphSettings_VORANGE');
                if (saved) {
                    applyLoadedSettings(JSON.parse(saved));
                    updateAllDisplays();
                    document.getElementById('status').textContent = '‚úÖ Local uniquement';
                } else {
                    document.getElementById('status').textContent = '‚ö†Ô∏è Aucun param√®tre sauvegard√©';
                }
            }
        }

        function applyLoadedSettings(s) {
            if (s.cameraOffset) cameraOffset = { ...s.cameraOffset };
            if (s.cameraAngle) cameraAngle = { ...s.cameraAngle };
            if (s.graphMeshOffset) graphMeshOffset = { ...s.graphMeshOffset };
            if (s.lightPosition) lightPosition = { ...s.lightPosition };
            if (s.lightIntensity !== undefined) lightIntensity = s.lightIntensity;
            if (s.labelsXOffset) labelsXOffset = { ...s.labelsXOffset };
            if (s.labelsYOffset) labelsYOffset = { ...s.labelsYOffset };
            if (s.barreRougeOffset) barreRougeOffset = { ...s.barreRougeOffset };
            if (s.barreRougeIntensity !== undefined) barreRougeIntensity = s.barreRougeIntensity;
            if (s.barreRougeSize) barreRougeSize = { ...s.barreRougeSize };
            if (s.graphWidth !== undefined) graphWidth = s.graphWidth;
            if (s.fontSizeLabelsX !== undefined) fontSizeLabelsX = s.fontSizeLabelsX;
            if (s.fontSizeLabelsY !== undefined) fontSizeLabelsY = s.fontSizeLabelsY;
            if (s.labelsXSpacing !== undefined) labelsXSpacing = s.labelsXSpacing;
            if (s.linesOffset) linesOffset = { ...s.linesOffset };
            if (s.linesRightExtension !== undefined) linesRightExtension = s.linesRightExtension;
            if (s.graphShadowSize !== undefined) graphShadowSize = s.graphShadowSize;
            if (s.graphShadowDistance !== undefined) graphShadowDistance = s.graphShadowDistance;
            if (s.graphShadowPosition) graphShadowPosition = { ...s.graphShadowPosition };
            if (s.barreShadowSize !== undefined) barreShadowSize = s.barreShadowSize;
            if (s.barreShadowDistance !== undefined) barreShadowDistance = s.barreShadowDistance;
            if (s.barreShadowPosition) barreShadowPosition = { ...s.barreShadowPosition };
        }

        function applySettings() {
            const settings = {
                cameraOffset, cameraAngle, graphMeshOffset, lightPosition, lightIntensity,
                labelsXOffset, labelsYOffset, barreRougeOffset, barreRougeIntensity,
                barreRougeSize, graphWidth, fontSizeLabelsX, fontSizeLabelsY,
                labelsXSpacing, linesOffset, linesRightExtension, graphShadowSize,
                graphShadowDistance, graphShadowPosition, barreShadowSize,
                barreShadowDistance, barreShadowPosition
            };
            
            localStorage.setItem('graphSettings_VORANGE', JSON.stringify(settings));
            
            fetch(`${WS_URL.replace('wss:', 'https:')}/api/graph`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            })
            .then(() => {
                document.getElementById('status').textContent = '‚úÖ Sauvegard√© !';
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'graph_settings', settings }));
                }
                setTimeout(() => {
                    document.getElementById('status').textContent = '‚úÖ Connect√©';
                }, 2000);
            })
            .catch(() => {
                document.getElementById('status').textContent = '‚ö†Ô∏è Local seulement';
            });
        }

        function clearStorageAndReload() {
            if (confirm('R√©initialiser tous les param√®tres ?')) {
                localStorage.removeItem('graphSettings_VORANGE');
                location.reload();
            }
        }

        function updateAllDisplays() {
            const updates = {
                'cameraInfo': `X:${cameraOffset.x.toFixed(1)} Y:${cameraOffset.y.toFixed(1)} Z:${cameraOffset.z.toFixed(1)}`,
                'angleInfo': `H:${cameraAngle.horizontal}¬∞ V:${cameraAngle.vertical}¬∞`,
                'graphInfo': `X:${graphMeshOffset.x.toFixed(1)} Y:${graphMeshOffset.y.toFixed(1)}`,
                'graphZInfo': `Z:${graphMeshOffset.z.toFixed(1)}`,
                'graphWidthInfo': `L:${graphWidth}`,
                'lightInfo': `X:${lightPosition.x.toFixed(1)} Y:${lightPosition.y.toFixed(1)} Z:${lightPosition.z.toFixed(1)}`,
                'intensityInfo': `üí° ${Math.round(lightIntensity * 100)}%`,
                'labelsXInfo': `X:${labelsXOffset.x.toFixed(1)} Y:${labelsXOffset.y.toFixed(1)}`,
                'labelsYInfo': `X:${labelsYOffset.x.toFixed(1)} Y:${labelsYOffset.y.toFixed(1)}`,
                'barreRougeInfo': `X:${barreRougeOffset.x.toFixed(1)} Y:${barreRougeOffset.y.toFixed(1)} Z:${barreRougeOffset.z.toFixed(1)}`
            };
            for (let [id, text] of Object.entries(updates)) {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            }
        }

        // Fonctions de contr√¥le
        function moveCamera(dir) {
            if (dir === 'up') cameraOffset.y += STEP;
            else if (dir === 'down') cameraOffset.y -= STEP;
            else if (dir === 'left') cameraOffset.x -= STEP;
            else if (dir === 'right') cameraOffset.x += STEP;
            else if (dir === 'forward') cameraOffset.z -= STEP;
            else if (dir === 'backward') cameraOffset.z += STEP;
            else if (dir === 'center') cameraOffset = { x: 0, y: 5, z: 32 };
            updateAllDisplays();
            sendUpdate(); // AJOUT : envoyer imm√©diatement
        }

        function rotateCamera(dir) {
            const step = 5;
            if (dir === 'up') cameraAngle.vertical += step;
            else if (dir === 'down') cameraAngle.vertical -= step;
            else if (dir === 'left') cameraAngle.horizontal -= step;
            else if (dir === 'right') cameraAngle.horizontal += step;
            else if (dir === 'center') cameraAngle = { horizontal: 0, vertical: -20 };
            updateAllDisplays();
            sendUpdate(); // AJOUT
        }

        function resetCamera() {
            cameraOffset = { x: 0, y: 5, z: 32 };
            updateAllDisplays();
            sendUpdate(); // AJOUT
        }

        function resetCameraAngle() {
            cameraAngle = { horizontal: 0, vertical: -20 };
            updateAllDisplays();
            sendUpdate(); // AJOUT
        }

        function moveGraph(dir) {
            if (dir === 'up') graphMeshOffset.y += STEP;
            else if (dir === 'down') graphMeshOffset.y -= STEP;
            else if (dir === 'left') graphMeshOffset.x -= STEP;
            else if (dir === 'right') graphMeshOffset.x += STEP;
            else if (dir === 'forward') graphMeshOffset.z += STEP;
            else if (dir === 'backward') graphMeshOffset.z -= STEP;
            else if (dir === 'center') graphMeshOffset = { x: 0, y: 0, z: 0 };
            updateAllDisplays();
            sendUpdate(); // AJOUT
        }

        function adjustGraphWidth(dir) {
            if (dir === 'increase') graphWidth += 5;
            else if (dir === 'decrease') graphWidth = Math.max(20, graphWidth - 5);
            updateAllDisplays();
            sendUpdate(); // AJOUT
        }

        function resetGraph() {
            graphMeshOffset = { x: 0, y: 0, z: 0 };
            graphWidth = 100;
            updateAllDisplays();
            sendUpdate(); // AJOUT
        }

        function moveLight(dir) {
            if (dir === 'up') lightPosition.y += STEP;
            else if (dir === 'down') lightPosition.y -= STEP;
            else if (dir === 'left') lightPosition.x -= STEP;
            else if (dir === 'right') lightPosition.x += STEP;
            else if (dir === 'forward') lightPosition.z += STEP;
            else if (dir === 'backward') lightPosition.z -= STEP;
            else if (dir === 'center') lightPosition = { x: 5, y: 10, z: 7 };
            updateAllDisplays();
            sendUpdate(); // AJOUT
        }

        function adjustIntensity(dir) {
            const step = 0.1;
            if (dir === 'up') lightIntensity = Math.min(2.0, lightIntensity + step);
            else if (dir === 'down') lightIntensity = Math.max(0.1, lightIntensity - step);
            updateAllDisplays();
            sendUpdate(); // AJOUT
        }

        function resetLight() {
            lightPosition = { x: 5, y: 10, z: 7 };
            lightIntensity = 0.6;
            updateAllDisplays();
            sendUpdate(); // AJOUT
        }

        function moveLabels_Annees(dir) {
            if (dir === 'up') labelsXOffset.y += STEP;
            else if (dir === 'down') labelsXOffset.y -= STEP;
            else if (dir === 'left') labelsXOffset.x -= STEP;
            else if (dir === 'right') labelsXOffset.x += STEP;
            else if (dir === 'center') labelsXOffset = { x: 0, y: 0 };
            updateAllDisplays();
            sendUpdate(); // AJOUT
        }

        function moveLabels_Prix(dir) {
            if (dir === 'up') labelsYOffset.y += STEP;
            else if (dir === 'down') labelsYOffset.y -= STEP;
            else if (dir === 'left') labelsYOffset.x -= STEP;
            else if (dir === 'right') labelsYOffset.x += STEP;
            else if (dir === 'center') labelsYOffset = { x: 0, y: 0 };
            updateAllDisplays();
            sendUpdate(); // AJOUT
        }

        function moveBarreRouge(dir) {
            if (dir === 'up') barreRougeOffset.y += STEP;
            else if (dir === 'down') barreRougeOffset.y -= STEP;
            else if (dir === 'left') barreRougeOffset.x -= STEP;
            else if (dir === 'right') barreRougeOffset.x += STEP;
            else if (dir === 'forward') barreRougeOffset.z += STEP;
            else if (dir === 'backward') barreRougeOffset.z -= STEP;
            else if (dir === 'center') barreRougeOffset = { x: 0, y: -7.5, z: 0 };
            updateAllDisplays();
            sendUpdate(); // AJOUT
        }

        function adjustFontSizeX(dir) {
            if (dir === 'up') fontSizeLabelsX += 5;
            else if (dir === 'down') fontSizeLabelsX = Math.max(20, fontSizeLabelsX - 5);
            updateAllDisplays();
            sendUpdate(); // AJOUT
        }

        function adjustFontSizeY(dir) {
            if (dir === 'up') fontSizeLabelsY += 5;
            else if (dir === 'down') fontSizeLabelsY = Math.max(20, fontSizeLabelsY - 5);
            updateAllDisplays();
            sendUpdate(); // AJOUT
        }

        function adjustLabelsXSpacing(dir) {
            if (dir === 'up') labelsXSpacing += 0.1;
            else if (dir === 'down') labelsXSpacing = Math.max(0.2, labelsXSpacing - 0.1);
            updateAllDisplays();
            sendUpdate(); // AJOUT
        }

        function resetLabels() {
            labelsXOffset = { x: 0, y: 0 };
            labelsYOffset = { x: 0, y: 0 };
            fontSizeLabelsX = 100;
            fontSizeLabelsY = 128;
            labelsXSpacing = 1.0;
            updateAllDisplays();
            sendUpdate(); // AJOUT
        }

        function adjustBarreRougeIntensity(dir) {
            const step = 0.1;
            if (dir === 'increase') barreRougeIntensity = Math.min(3.0, barreRougeIntensity + step);
            else if (dir === 'decrease') barreRougeIntensity = Math.max(0.3, barreRougeIntensity - step);
            updateAllDisplays();
            sendUpdate(); // AJOUT
        }

        function adjustBarreRougeSize(dimension, dir) {
            const step = 0.5;
            if (dir === 'increase') barreRougeSize[dimension] += step;
            else if (dir === 'decrease') barreRougeSize[dimension] = Math.max(0.5, barreRougeSize[dimension] - step);
            updateAllDisplays();
            sendUpdate(); // AJOUT
        }

        function resetBarreRouge() {
            barreRougeOffset = { x: 0, y: -7.5, z: 0 };
            barreRougeIntensity = 1.5;
            barreRougeSize = { width: 9, height: 0.325, depth: 8 };
            updateAllDisplays();
            sendUpdate(); // AJOUT
        }

        // Fonctions pour les color pickers
        let gradientColors = { top: '#ffa500', bottom: '#ffb380' };
        let topFaceColor = '#CCCCCC';
        let barreRougeColor = '#CC0000';

        function syncColorFromPicker(position) {
            const picker = document.getElementById(position === 'top' ? 'colorTopPicker' : 'colorBottomPicker');
            if (picker) {
                gradientColors[position] = picker.value;
                console.log('üé® Couleur', position, 'chang√©e:', picker.value);
                sendUpdate();
            }
        }

        function syncTopFaceColorFromPicker() {
            const picker = document.getElementById('topFaceColorPicker');
            if (picker) {
                topFaceColor = picker.value;
                console.log('üé® Couleur face haute chang√©e:', picker.value);
                sendUpdate();
            }
        }

        function syncBarreColorFromPicker() {
            const picker = document.getElementById('barreColorPicker');
            if (picker) {
                barreRougeColor = picker.value;
                console.log('üé® Couleur barre rouge chang√©e:', picker.value);
                sendUpdate();
            }
        }

        // NOUVELLE FONCTION : Envoyer les mises √† jour en temps r√©el
        function sendUpdate() {
            const settings = {
                cameraOffset, cameraAngle, graphMeshOffset, lightPosition, lightIntensity,
                labelsXOffset, labelsYOffset, barreRougeOffset, barreRougeIntensity,
                barreRougeSize, graphWidth, fontSizeLabelsX, fontSizeLabelsY,
                labelsXSpacing, linesOffset, linesRightExtension, graphShadowSize,
                graphShadowDistance, graphShadowPosition, barreShadowSize,
                barreShadowDistance, barreShadowPosition,
                gradientColors, topFaceColor, barreRougeColor // AJOUT : couleurs
            };
            
            console.log('üì§ Envoi mise √† jour:', settings);
            
            // Envoyer via WebSocket si connect√©
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'graph_settings',
                    settings: settings
                }));
                console.log('‚úÖ Message envoy√© via WebSocket');
                document.getElementById('status').textContent = 'üì° Envoy√© !';
                setTimeout(() => {
                    document.getElementById('status').textContent = '‚úÖ Connect√©';
                }, 500);
            } else {
                console.warn('‚ö†Ô∏è WebSocket non connect√©, impossible d\'envoyer');
                document.getElementById('status').textContent = '‚ùå Non connect√© !';
            }
        }

        // WebSocket
        function connectWebSocket() {
            try {
                ws = new WebSocket(WS_URL);
                ws.onopen = () => {
                    document.getElementById('status').textContent = '‚úÖ Connect√© au serveur';
                };
                ws.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'graph_settings') {
                        applyLoadedSettings(msg.settings);
                        updateAllDisplays();
                    }
                };
                ws.onclose = () => {
                    document.getElementById('status').textContent = 'üîå Reconnexion...';
                    setTimeout(connectWebSocket, 3000);
                };
            } catch (error) {
                document.getElementById('status').textContent = '‚ùå Erreur connexion';
            }
        }

        // D√©marrage
        window.addEventListener('load', () => {
            loadSettings();
            connectWebSocket();
        });
    </script>
</body>
</html>
